<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>✨ Enhanced Journey EMG/NCS Learning System - Full Integration</title>
    <!-- <link rel="icon" type="image/png" href="ERNEST.png"> -->
    <link rel="stylesheet" href="css/enhanced-journey-candyland.css">
    <link rel="stylesheet" href="css/professional-board-candyland.css">
    <style>
        /* Clean Medical Background System */
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            line-height: 1.6;
            color: #1f2937;
            background: linear-gradient(135deg, #fdfcf8 0%, #f9f7f1 100%);
            min-height: 100vh;
            position: relative;
            overflow-x: hidden;
            margin: 0;
        }

        /* Clinical Cases System Styles */
        .case-step {
            display: none;
        }

        .case-step.active {
            display: block !important;
        }

        .progress-bar {
            width: 100%;
            height: 8px;
            background: #e5e7eb;
            border-radius: 4px;
            margin-bottom: 20px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #6b9f78, #4a6d52);
            border-radius: 4px;
            transition: width 0.3s ease;
        }

        .case-card {
            background: white;
            border-radius: 12px;
            padding: 20px;
            margin: 15px 0;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .case-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 24px rgba(0,0,0,0.15);
        }

        .case-card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .case-difficulty {
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: bold;
        }

        .case-difficulty.beginner {
            background: #10b981;
            color: white;
        }

        .case-difficulty.intermediate {
            background: #f59e0b;
            color: white;
        }

        .case-difficulty.difficult {
            background: #ef4444;
            color: white;
        }

        .case-stages {
            display: flex;
            gap: 8px;
            margin-top: 15px;
            flex-wrap: wrap;
        }

        .case-stages span {
            background: #f3f4f6;
            padding: 4px 8px;
            border-radius: 8px;
            font-size: 12px;
            color: #6b7280;
        }

        .stage-explanation {
            display: grid;
            gap: 15px;
            margin-top: 15px;
        }

        .stage-item {
            display: flex;
            align-items: flex-start;
            gap: 12px;
            padding: 15px;
            background: #f8fafc;
            border-radius: 8px;
        }

        .stage-icon {
            font-size: 24px;
            flex-shrink: 0;
        }

        .quiz-button {
            background: #6b9f78;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            margin: 10px 5px;
        }

        .quiz-button:hover {
            background: #4a6d52;
            transform: translateY(-1px);
        }

        .differential-input {
            width: 100%;
            padding: 15px;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            font-family: inherit;
            font-size: 14px;
            resize: vertical;
            min-height: 120px;
        }

        .differential-input:focus {
            outline: none;
            border-color: #6b9f78;
        }
            padding: 0;
        }

        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background:
                radial-gradient(circle at 20% 80%, rgba(107, 159, 120, 0.15) 0%, transparent 50%),
                radial-gradient(circle at 80% 20%, rgba(34, 197, 94, 0.1) 0%, transparent 50%),
                radial-gradient(circle at 60% 60%, rgba(168, 85, 247, 0.08) 0%, transparent 50%);
            pointer-events: none;
            z-index: -1;
        }

        /* Enhanced PGY Selection Screen */
        .enhanced-pgy-selection {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            text-align: center;
            padding: 40px 20px;
        }

        .selection-title-card {
            background: linear-gradient(135deg, #fefcf3 0%, #f8fafc 100%);
            border: 3px solid rgba(107, 159, 120, 0.2);
            border-radius: 30px;
            padding: 50px;
            margin-bottom: 50px;
            box-shadow:
                0 25px 70px rgba(107, 159, 120, 0.15),
                inset 0 1px 0 rgba(255, 255, 255, 0.8);
            position: relative;
            overflow: hidden;
            animation: gentleFloat 6s ease-in-out infinite;
        }

        .selection-title-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg,
                transparent,
                rgba(34, 197, 94, 0.1),
                rgba(168, 85, 247, 0.1),
                rgba(234, 179, 8, 0.1),
                transparent
            );
            animation: journeyShimmer 4s infinite;
        }

        @keyframes journeyShimmer {
            0% { left: -100%; }
            100% { left: 100%; }
        }

        @keyframes gentleFloat {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-10px); }
        }

        .main-title {
            font-size: 3.5em;
            color: #1e293b;
            margin-bottom: 15px;
            font-weight: 800;
        }

        .main-subtitle {
            font-size: 1.3em;
            color: #64748b;
            margin-bottom: 30px;
        }

        .pgy-selection-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 30px;
            max-width: 900px;
            margin: 0 auto;
        }

        .pgy-card {
            background: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%);
            border: 2px solid rgba(107, 159, 120, 0.2);
            border-radius: 25px;
            padding: 40px 30px;
            cursor: pointer;
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
        }

        .pgy-card:hover {
            transform: translateY(-8px) scale(1.02);
            box-shadow: 0 20px 50px rgba(107, 159, 120, 0.25);
            border-color: rgba(107, 159, 120, 0.4);
        }

        .pgy-level {
            font-size: 2.5em;
            font-weight: 800;
            color: #1e293b;
            margin-bottom: 15px;
        }

        .pgy-description {
            color: #64748b;
            font-size: 1.1em;
            line-height: 1.5;
        }

        .hidden {
            display: none !important;
        }

        /* Enhanced quiz styling */
        .quiz-options {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin-top: 15px;
        }

        .quiz-option {
            background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
            border: 2px solid rgba(107, 159, 120, 0.2);
            border-radius: 10px;
            padding: 12px 20px;
            cursor: pointer;
            transition: all 0.2s ease;
            text-align: left;
            font-size: 0.95em;
        }

        .quiz-option:hover {
            background: linear-gradient(135deg, #6b9f78 0%, #4a6d52 100%);
            color: white;
            transform: translateX(5px);
        }

        .quiz-option.correct {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
            border-color: #059669;
        }

        .quiz-option.incorrect {
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
            color: white;
            border-color: #dc2626;
        }

        .quiz-result {
            background: #f0f9ff;
            border: 2px solid #0ea5e9;
            border-radius: 10px;
            padding: 15px;
            margin-top: 15px;
            font-weight: 500;
        }

        .quiz-result.correct {
            background: #f0fdf4;
            border-color: #10b981;
            color: #065f46;
        }

        .quiz-result.incorrect {
            background: #fef2f2;
            border-color: #ef4444;
            color: #991b1b;
        }

        /* Progress Dashboard Styles */
        .progress-dashboard {
            padding: 30px;
            max-width: 1200px;
            margin: 0 auto;
        }

        .dashboard-header {
            text-align: center;
            margin-bottom: 30px;
        }

        .dashboard-header h3 {
            color: #1e293b;
            font-size: 2em;
            margin-bottom: 20px;
        }

        .dashboard-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%);
            border: 2px solid rgba(107, 159, 120, 0.2);
            border-radius: 15px;
            padding: 25px;
            text-align: center;
            transition: all 0.3s ease;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }

        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 24px rgba(0,0,0,0.15);
            border-color: rgba(107, 159, 120, 0.4);
        }

        .stat-number {
            font-size: 2.5em;
            font-weight: 800;
            color: #6b9f78;
            margin-bottom: 8px;
        }

        .stat-label {
            color: #64748b;
            font-size: 1.1em;
            font-weight: 500;
        }

        .achievement-showcase {
            background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
            border-radius: 20px;
            padding: 25px;
            min-height: 150px;
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            justify-content: center;
            align-items: center;
        }

        .achievement-badge {
            background: linear-gradient(135deg, #fbbf24 0%, #f59e0b 100%);
            color: white;
            padding: 12px 20px;
            border-radius: 25px;
            font-weight: 600;
            box-shadow: 0 4px 12px rgba(251, 191, 36, 0.3);
            animation: badgeGlow 2s ease-in-out infinite alternate;
        }

        @keyframes badgeGlow {
            0% { box-shadow: 0 4px 12px rgba(251, 191, 36, 0.3); }
            100% { box-shadow: 0 6px 20px rgba(251, 191, 36, 0.5); }
        }

        .no-achievements {
            color: #94a3b8;
            font-style: italic;
            font-size: 1.1em;
        }

        /* Atrium Health Welcome Screen - Clean Medical Design */
        .atrium-welcome-screen {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            padding: 40px 20px;
            background: linear-gradient(135deg, #6b9f78 0%, #5a8a67 100%);
        }

        .atrium-main-container {
            background: white;
            border-radius: 30px;
            padding: 60px;
            max-width: 1000px;
            width: 100%;
            box-shadow: 0 25px 80px rgba(0, 0, 0, 0.15);
            text-align: center;
            position: relative;
        }

        /* Atrium Health Logo */
        .atrium-logo-container {
            margin-bottom: 30px;
        }

        .atrium-logo-img {
            width: 100px;
            height: 100px;
            border-radius: 50%;
            object-fit: contain;
        }

        /* Main Title */
        .atrium-main-title {
            font-size: 2.8em;
            color: #2c3e50;
            margin-bottom: 50px;
            font-weight: 700;
            letter-spacing: -0.02em;
        }

        /* Content Area with ERNEST and Speech */
        .atrium-content-area {
            display: flex;
            align-items: center;
            gap: 40px;
            margin-bottom: 50px;
            text-align: left;
        }

        /* ERNEST Silhouette Container */
        .ernest-container {
            position: relative;
            flex-shrink: 0;
            text-align: center;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        /* ERNEST Character Image with Floating Animation - 25% Bigger */
        .ernest-character-img {
            width: 250px;
            height: 250px;
            border-radius: 15px;
            object-fit: contain;
            animation: ernestFloat 4s ease-in-out infinite;
            filter: drop-shadow(0 8px 16px rgba(0, 0, 0, 0.1));
        }

        @keyframes ernestFloat {
            0%, 100% { transform: translateY(0px) translateX(0px); }
            25% { transform: translateY(-8px) translateX(3px); }
            50% { transform: translateY(-4px) translateX(-3px); }
            75% { transform: translateY(-12px) translateX(2px); }
        }

        .ernest-label {
            background: #6b9f78;
            color: white;
            padding: 12px 26px;
            border-radius: 25px;
            font-weight: bold;
            margin-top: 25px;
            display: inline-block;
            font-size: 18px;
            text-align: center;
            text-align: center;
            box-shadow: 0 4px 12px rgba(107, 159, 120, 0.3);
        }

        /* Speech Bubble - Clean Medical Style */
        .speech-bubble {
            flex: 1;
            background: #f8fafc;
            border: 2px solid #e2e8f0;
            border-radius: 25px;
            padding: 35px;
            position: relative;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.08);
        }

        .speech-bubble::before {
            content: '';
            position: absolute;
            left: -14px;
            top: 50%;
            transform: translateY(-50%);
            width: 0;
            height: 0;
            border-top: 18px solid transparent;
            border-bottom: 18px solid transparent;
            border-right: 18px solid #e2e8f0;
        }

        .speech-bubble::after {
            content: '';
            position: absolute;
            left: -10px;
            top: 50%;
            transform: translateY(-50%);
            width: 0;
            height: 0;
            border-top: 15px solid transparent;
            border-bottom: 15px solid transparent;
            border-right: 15px solid #f8fafc;
        }

        .speech-text {
            font-size: 1.25em;
            line-height: 1.6;
            color: #374151;
            margin: 0;
        }

        /* Call to Action Button */
        .atrium-cta-button {
            background: #6b9f78;
            color: white;
            border: none;
            padding: 18px 45px;
            font-size: 1.4em;
            font-weight: 600;
            border-radius: 50px;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 6px 20px rgba(107, 159, 120, 0.3);
        }

        .atrium-cta-button:hover {
            transform: translateY(-3px);
            box-shadow: 0 12px 30px rgba(107, 159, 120, 0.4);
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            .atrium-content-area {
                flex-direction: column;
                text-align: center;
                gap: 30px;
            }

            .atrium-main-container {
                padding: 40px 25px;
            }

            .atrium-main-title {
                font-size: 2.2em;
            }

            .ernest-silhouette {
                width: 150px;
                height: 180px;
            }

            .speech-bubble::before,
            .speech-bubble::after {
                display: none;
            }
        }

        /* Clean 13-Module Pathway System */
        .atrium-pathway-container {
            background: #fdfcf8;
            min-height: 100vh;
            padding: 40px 20px;
            animation: pathwaySlideIn 0.8s ease-out;
            display: block !important;
            visibility: visible !important;
            position: relative;
            overflow: hidden;
        }

        /* Prevent layout shifts during content loading */
        #learning-board {
            min-height: 100vh;
            transition: all 0.3s ease;
        }

        /* Smooth loading state */
        .pathway-loading {
            opacity: 0;
            transform: translateY(20px);
        }

        .pathway-loaded {
            opacity: 1;
            transform: translateY(0);
            transition: opacity 0.5s ease, transform 0.5s ease;
        }

        /* Green Sidebar Bars */
        .atrium-pathway-container::before {
            content: '';
            position: absolute;
            left: 0;
            top: 0;
            bottom: 0;
            width: 8px;
            background: linear-gradient(to bottom, #6b9f78, #5a8a67, #4a6d52);
            border-radius: 0 4px 4px 0;
            box-shadow: 2px 0 8px rgba(107, 159, 120, 0.3);
        }

        .atrium-pathway-container::after {
            content: '';
            position: absolute;
            right: 0;
            top: 0;
            bottom: 0;
            width: 8px;
            background: linear-gradient(to bottom, #6b9f78, #5a8a67, #4a6d52);
            border-radius: 4px 0 0 4px;
            box-shadow: -2px 0 8px rgba(107, 159, 120, 0.3);
        }

        /* Ensure learning board shows when not hidden */
        #learning-board:not(.hidden) {
            display: block !important;
            visibility: visible !important;
        }

        @keyframes pathwaySlideIn {
            from { opacity: 0; transform: translateY(30px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .pathway-header {
            text-align: center;
            margin-bottom: 50px;
        }

        .pathway-title {
            font-size: 3.8em;
            color: #6b9f78;
            text-align: center;
            margin-bottom: 20px;
            font-weight: 800;
            letter-spacing: -0.03em;
            text-shadow: 0 4px 12px rgba(107, 159, 120, 0.3);
            animation: titleFloat 6s ease-in-out infinite alternate;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 20px;
        }

        @keyframes titleFloat {
            0% {
                transform: translateY(0px) scale(1);
                text-shadow: 0 4px 12px rgba(107, 159, 120, 0.3);
            }
            100% {
                transform: translateY(-8px) scale(1.02);
                text-shadow: 0 8px 20px rgba(107, 159, 120, 0.4);
            }
        }

        .atrium-logo-title {
            width: 120px;
            height: 120px;
            object-fit: contain;
            border-radius: 50%;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            animation: logoTilt 5s ease-in-out infinite alternate;
        }

        @keyframes logoTilt {
            0% {
                transform: rotate(-12deg) scale(1);
            }
            100% {
                transform: rotate(12deg) scale(1.05);
            }
        }

        .pathway-subtitle {
            font-size: 1.2em;
            color: #64748b;
            margin-bottom: 30px;
        }


        /* Vertical Pathway Layout */
        .modules-pathway {
            max-width: 1100px;
            margin: 0 auto;
            position: relative;
            z-index: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 80px;
            padding: 60px 0;
        }

        /* Shimmer Background Animation */
        .pathway-background-animation {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            pointer-events: none;
            z-index: 0;
            overflow: hidden;
            background: linear-gradient(
                45deg,
                rgba(107, 159, 120, 0.03) 0%,
                rgba(107, 159, 120, 0.08) 25%,
                rgba(107, 159, 120, 0.03) 50%,
                rgba(107, 159, 120, 0.08) 75%,
                rgba(107, 159, 120, 0.03) 100%
            );
            background-size: 400% 400%;
            animation: shimmer 12s ease-in-out infinite;
        }

        @keyframes shimmer {
            0% {
                background-position: 0% 0%;
            }
            25% {
                background-position: 100% 100%;
            }
            50% {
                background-position: 100% 0%;
            }
            75% {
                background-position: 0% 100%;
            }
            100% {
                background-position: 0% 0%;
            }
        }

        /* Center Line */
        .pathway-center-line {
            position: absolute;
            left: 50%;
            top: 0;
            bottom: 0;
            width: 3px;
            background: linear-gradient(to bottom, #6b9f78, #e2e8f0);
            z-index: 1;
        }

        /* Module Items */
        .pathway-module {
            display: flex;
            align-items: center;
            margin: 40px 0;
            position: relative;
            z-index: 2;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .pathway-module:hover {
            transform: scale(1.05) rotate(2deg);
        }

        .pathway-module.left {
            justify-content: flex-start;
            padding-right: calc(50% + 30px);
        }

        .pathway-module.right {
            justify-content: flex-end;
            padding-left: calc(50% + 30px);
        }

        /* Module Number Circle */
        .module-number-circle {
            position: absolute;
            left: 50%;
            top: 50%;
            transform: translate(-50%, -50%);
            width: 45px;
            height: 45px;
            background: #6b9f78;
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 18px;
            box-shadow: 0 4px 12px rgba(107, 159, 120, 0.3);
            z-index: 3;
            transition: all 0.3s ease;
        }

        .pathway-module:hover .module-number-circle {
            background: #5a8a67;
            transform: translate(-50%, -50%) scale(1.1);
        }

        /* Larger Background Box for Layered Effect */
        .module-background-box {
            background: rgba(107, 159, 120, 0.08);
            border-radius: 35px;
            padding: 20px;
            transition: all 0.4s ease;
            box-shadow: 0 8px 25px rgba(107, 159, 120, 0.1);
            border: 2px solid rgba(107, 159, 120, 0.15);
        }

        /* Module Content Cards - Artwork Only Design */
        .module-card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            padding: 30px;
            border-radius: 25px;
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.1),
                        0 5px 15px rgba(107, 159, 120, 0.1),
                        inset 0 1px 0 rgba(255, 255, 255, 0.6);
            border: 3px solid rgba(255, 255, 255, 0.3);
            max-width: 320px;
            max-height: 320px;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
            overflow: hidden;
        }

        /* Hover Effects for Layered Design */
        .pathway-module:hover .module-background-box {
            transform: scale(1.08);
            background: rgba(107, 159, 120, 0.12);
            box-shadow: 0 15px 40px rgba(107, 159, 120, 0.2);
        }

        .pathway-module:hover .module-card {
            border-color: rgba(107, 159, 120, 0.6);
            box-shadow: 0 20px 50px rgba(107, 159, 120, 0.3),
                        0 10px 25px rgba(0, 0, 0, 0.15),
                        inset 0 1px 0 rgba(255, 255, 255, 0.8);
            transform: scale(1.02) translateY(-8px) rotate(3deg);
            backdrop-filter: blur(15px);
        }

        .module-custom-icon {
            width: 240px;
            height: 240px;
            object-fit: contain;
            border-radius: 20px;
            transition: all 0.3s ease;
            position: relative;
            z-index: 2;
        }

        .pathway-module:hover .module-custom-icon {
            filter: brightness(1.1) contrast(1.05);
        }

        /* Remove text elements for clean artwork-only design */
        .module-icon,
        .module-title,
        .module-description {
            display: none;
        }

        /* Center alignment for all modules */
        .pathway-module.left .module-card,
        .pathway-module.right .module-card {
            text-align: center;
        }

        /* Dynamic Module Description System - Simplified */
        .module-description-panel {
            position: fixed !important;
            background: rgba(255, 255, 255, 0.95) !important;
            backdrop-filter: blur(15px) !important;
            border: 2px solid rgba(107, 159, 120, 0.8) !important;
            border-radius: 20px !important;
            padding: 30px !important;
            width: 400px !important;
            height: 250px !important;
            z-index: 9999 !important;
            opacity: 0 !important;
            transition: all 0.3s ease-out !important;
            pointer-events: none !important;
            box-shadow: 0 20px 50px rgba(0,0,0,0.15) !important;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif !important;
            display: block !important;
            overflow-y: auto !important;
        }

        .module-description-panel.show {
            opacity: 1 !important;
            pointer-events: auto !important;
        }

        /* Smart positioning - right side for left modules, left side for right modules */
        .module-description-panel.position-right {
            left: calc(50% + 200px) !important;
        }

        .module-description-panel.position-left {
            left: calc(50% - 600px) !important;
        }

        /* Ernest avatar and content styling for readability */
        .description-ernest-avatar {
            width: 40px !important;
            height: 40px !important;
            border-radius: 50% !important;
            margin-bottom: 15px !important;
            margin-right: 15px !important;
        }
        .description-title {
            font-size: 16px !important;
            font-weight: 700 !important;
            color: #2563eb !important;
            margin-bottom: 12px !important;
            line-height: 1.3 !important;
        }
        .description-text {
            font-size: 14px !important;
            color: #4b5563 !important;
            line-height: 1.5 !important;
            margin-bottom: 12px !important;
        }
        .description-highlights {
            font-size: 12px !important;
            color: #059669 !important;
            font-weight: 600 !important;
            line-height: 1.4 !important;
            margin-top: 10px !important;
        }

        .description-ernest {
            display: flex;
            align-items: flex-start;
            gap: 15px;
            margin-bottom: 15px;
        }

        .description-ernest-avatar {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            object-fit: cover;
            border: 2px solid #6b9f78;
            flex-shrink: 0;
            animation: ernestPulse 3s ease-in-out infinite;
        }

        @keyframes ernestPulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }





        .description-content {
            flex: 1;
        }

        .description-title {
            font-size: 1.3em;
            font-weight: 700;
            color: #6b9f78;
            margin-bottom: 8px;
            line-height: 1.2;
        }

        .description-text {
            font-size: 1em;
            line-height: 1.6;
            color: #2c3e50;
            margin-bottom: 12px;
        }

        .description-highlights {
            font-size: 0.9em;
            color: #64748b;
            font-style: italic;
        }

        /* New Pre-Positioned Description Boxes */
        .ernest-description-box {
            position: fixed;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(15px);
            border: 2px solid rgba(107, 159, 120, 0.8);
            border-radius: 20px;
            padding: 20px;
            width: 350px;
            max-width: 350px;
            z-index: 9999;
            opacity: 0;
            transition: all 0.3s ease-out;
            pointer-events: none;
            box-shadow: 0 10px 30px rgba(0,0,0,0.15);
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        .ernest-description-box.show {
            opacity: 1 !important;
            pointer-events: auto !important;
        }

        /* Speech bubble effect */
        .module-description-panel::before {
            content: '';
            position: absolute;
            width: 0;
            height: 0;
            top: 50%;
        }

        .module-description-panel.position-right::before {
            left: -10px;
            transform: translateY(-50%);
            border-right: 10px solid rgba(255, 255, 255, 0.96);
            border-top: 10px solid transparent;
            border-bottom: 10px solid transparent;
        }

        .module-description-panel.position-left::before {
            right: -10px;
            transform: translateY(-50%);
            border-left: 10px solid rgba(255, 255, 255, 0.96);
            border-top: 10px solid transparent;
            border-bottom: 10px solid transparent;
        }

        /* Responsive Design for Description Panels */
        @media (max-width: 1400px) {
            .module-description-panel.position-right {
                left: calc(50% + 150px);
            }
            .module-description-panel.position-left {
                right: calc(50% + 150px);
            }
            .module-description-panel {
                width: 280px;
                max-width: 280px;
            }
        }

        @media (max-width: 1200px) {
            .module-description-panel.position-right {
                left: calc(50% + 100px);
            }
            .module-description-panel.position-left {
                right: calc(50% + 100px);
            }
            .module-description-panel {
                width: 250px;
                max-width: 250px;
                padding: 20px;
            }
            .description-title {
                font-size: 1.1em;
            }
            .description-text {
                font-size: 0.9em;
            }
        }

        @media (max-width: 768px) {
            .module-description-panel {
                position: fixed !important;
                bottom: 80px !important;
                left: 50% !important;
                right: auto !important;
                transform: translateX(-50%) !important;
                width: 90% !important;
                max-width: 350px !important;
                top: auto !important;
            }
            .module-description-panel.show {
                transform: translateX(-50%) scale(1) !important;
            }
            .module-description-panel::before {
                display: none;
            }
        }
    </style>
</head>
<body>
    <!-- Atrium Health Welcome Screen -->
    <div id="pgy-selection" class="atrium-welcome-screen">
        <div class="atrium-main-container">
            <!-- Atrium Health Logo -->
            <div class="atrium-logo-container">
                <img src="atrium.jpeg" alt="Atrium Health" class="atrium-logo-img">
            </div>

            <!-- Main Title -->
            <h1 class="atrium-main-title">Atrium Health EMG/NCS Learning System</h1>

            <!-- Content Area with ERNEST and Speech Bubble -->
            <div class="atrium-content-area">
                <!-- ERNEST Character -->
                <div class="ernest-container">
                    <img src="ERNEST.png" alt="ERNEST EMG Device" class="ernest-character-img">
                    <div class="ernest-label">ERNEST</div>
                </div>

                <!-- Speech Bubble -->
                <div class="speech-bubble">
                    <p class="speech-text">
                        Welcome to Atrium Health's EMG/NCS Learning System! I'm ERNEST,
                        your electrodiagnostic companion. I'll guide you through 13 essential modules
                        that will transform you into an EMG expert. Ready to begin your journey?
                    </p>
                </div>
            </div>

            <!-- Call to Action Button -->
            <button class="atrium-cta-button" onclick="startAtriumJourney()">
                Begin Journey
            </button>
        </div>
    </div>

    <!-- Progress Dashboard -->
    <div id="progress-dashboard" class="progress-dashboard hidden">
        <div class="dashboard-header">
            <h3>📊 Learning Progress Dashboard</h3>
            <div class="dashboard-stats">
                <div class="stat-card">
                    <div class="stat-number" id="completed-modules">0</div>
                    <div class="stat-label">Modules Completed</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="current-level">PGY-</div>
                    <div class="stat-label">Current Level</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="competency-score">0%</div>
                    <div class="stat-label">Competency Progress</div>
                </div>
            </div>
        </div>
        <div class="achievement-showcase" id="achievements-display">
            <!-- Achievement badges will be displayed here -->
        </div>
    </div>

    <!-- Enhanced Journey Learning Board -->
    <div id="learning-board" class="enhanced-journey-board hidden">
        <!-- Journey content will be dynamically generated here -->
    </div>

    <!-- Navigation Controls -->
    <div id="journey-controls" class="journey-controls hidden">
        <button class="control-btn secondary" onclick="returnToMainPage()">
            ← Return to Main Page
        </button>
        <button class="control-btn secondary" onclick="toggleProgressDashboard()">
            📊 Progress Dashboard
        </button>
        <button class="control-btn primary" onclick="resetJourney()">
            Reset Journey
        </button>
    </div>

    <!-- Load Enhanced Journey Systems -->
    <script src="js/enhanced-journey-candyland.js"></script>
    <script src="js/brachial-plexus-modal.js"></script>
    <!-- <script src="js/main.js"></script> TEMPORARILY DISABLED DUE TO SYNTAX ERROR -->
    <script src="js/emg-challenge-fix.js"></script>
    <!-- OLD CLINICAL CASES SYSTEM REMOVED - REPLACED BY EMG APP COMPLETE SYSTEM -->
    <!-- <script src="js/clinical-cases-system.js"></script> -->
    <!-- Load EMG APP Complete System with all clinical cases -->
    <script src="js/emg-app-complete-system.js"></script>
    <!-- <script src="js/enhanced-journey-modal-content.js"></script> -->
    <script src="js/enhanced-journey-modal-content.js?v=2025"></script>

    <script>
        // Atrium Health Welcome Screen Function
        function startAtriumJourney() {
            console.log('🏥 Starting Atrium Health Journey');

            // Smooth fade out welcome screen
            const welcomeScreen = document.getElementById('pgy-selection');
            welcomeScreen.style.transition = 'opacity 0.8s ease, transform 0.8s ease';
            welcomeScreen.style.opacity = '0';
            welcomeScreen.style.transform = 'translateY(-20px)';

            // Start the 13-module PGY-2 journey after transition
            setTimeout(() => {
                startJourney('pgy2');
            }, 800);
        }

        // Enhanced journey interface with modal integration
        function startJourney(pgyLevel) {
            console.log(`🚀 Starting ${pgyLevel.toUpperCase()} Enhanced Learning Journey`);

            // Try to load existing progress first
            const progressLoaded = loadProgressFromStorage();

            // Set global variables (use saved progress if available)
            if (!progressLoaded || window.currentPGYLevel !== pgyLevel) {
                window.currentPGYLevel = pgyLevel;
                window.currentModuleIndex = 0;
                window.completedModules = new Set();
                saveProgressToStorage();
            }

            // Show learning board
            document.getElementById('pgy-selection').classList.add('hidden');
            document.getElementById('learning-board').classList.remove('hidden');
            document.getElementById('journey-controls').classList.remove('hidden');

            // Generate the enhanced journey board
            if (typeof generateLearningBoard === 'function') {
                generateLearningBoard(pgyLevel);
            } else {
                console.error('❌ generateLearningBoard function not found, waiting for scripts to load...');
                setTimeout(() => {
                    if (typeof generateLearningBoard === 'function') {
                        generateLearningBoard(pgyLevel);
                    } else {
                        console.error('❌ generateLearningBoard function still not available after timeout');
                    }
                }, 500);
            }

            // Don't auto-open modal - let user click to start
            console.log('📚 Journey ready - click any module to begin learning!');

            // Smooth scroll to top
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        function returnToMainPage() {
            // Hide pathway and controls
            document.getElementById('learning-board').classList.add('hidden');
            document.getElementById('journey-controls').classList.add('hidden');
            document.getElementById('progress-dashboard').classList.add('hidden');

            // Show welcome page
            document.getElementById('pgy-selection').classList.remove('hidden');

            // Hide ERNEST dialogue
            hideERNESTDialogue();

            // Smooth scroll to top
            window.scrollTo({ top: 0, behavior: 'smooth' });

            console.log('🏠 Returned to Atrium Health Main Page');
        }

        function returnToSelection() {
            returnToMainPage();
        }

        function resetJourney() {
            window.completedModules = new Set();
            window.currentModuleIndex = 0;
            saveProgressToStorage();
            if (window.currentPGYLevel) {
                generateLearningBoard(window.currentPGYLevel);
                updateProgressDashboard();
                console.log('🔄 Journey Reset - Fresh Adventure Awaits!');
            }
        }

        // Progress Dashboard Functions
        function toggleProgressDashboard() {
            const dashboard = document.getElementById('progress-dashboard');
            const learningBoard = document.getElementById('learning-board');

            if (dashboard.classList.contains('hidden')) {
                dashboard.classList.remove('hidden');
                learningBoard.classList.add('hidden');
                updateProgressDashboard();
                console.log('📊 Progress Dashboard opened');
            } else {
                dashboard.classList.add('hidden');
                learningBoard.classList.remove('hidden');
                console.log('📊 Progress Dashboard closed');
            }
        }

        function updateProgressDashboard() {
            if (!window.currentPGYLevel) return;

            const modules = learningModulesConfig[window.currentPGYLevel];
            const completedCount = window.completedModules.size;
            const totalModules = modules.length;
            const competencyPercentage = Math.round((completedCount / totalModules) * 100);

            // Update stats
            document.getElementById('completed-modules').textContent = `${completedCount}/${totalModules}`;
            document.getElementById('current-level').textContent = `PGY-${window.currentPGYLevel.charAt(3)}`;
            document.getElementById('competency-score').textContent = `${competencyPercentage}%`;

            // Update achievements
            updateAchievements(completedCount, totalModules);
        }

        function updateAchievements(completed, total) {
            const achievementsDisplay = document.getElementById('achievements-display');
            const achievements = [];

            // Achievement logic
            if (completed >= 1) achievements.push('🎯 First Steps');
            if (completed >= 3) achievements.push('📚 Knowledge Seeker');
            if (completed >= 5) achievements.push('🧠 Learning Expert');
            if (completed >= Math.floor(total * 0.5)) achievements.push('🏃‍♂️ Halfway Hero');
            if (completed >= Math.floor(total * 0.75)) achievements.push('🌟 Excellence Seeker');
            if (completed === total) achievements.push('🏆 Master Complete');

            if (achievements.length > 0) {
                achievementsDisplay.innerHTML = achievements.map(badge =>
                    `<div class="achievement-badge">${badge}</div>`
                ).join('');
            } else {
                achievementsDisplay.innerHTML = '<div class="no-achievements">Complete your first module to unlock achievements!</div>';
            }
        }

        // Local Storage Functions
        function saveProgressToStorage() {
            const progressData = {
                currentPGYLevel: window.currentPGYLevel,
                completedModules: Array.from(window.completedModules),
                currentModuleIndex: window.currentModuleIndex,
                lastUpdated: new Date().toISOString()
            };
            localStorage.setItem('ernestEMGProgress', JSON.stringify(progressData));
        }

        function loadProgressFromStorage() {
            const saved = localStorage.getItem('ernestEMGProgress');
            if (saved) {
                try {
                    const progressData = JSON.parse(saved);
                    window.currentPGYLevel = progressData.currentPGYLevel;
                    window.completedModules = new Set(progressData.completedModules || []);
                    window.currentModuleIndex = progressData.currentModuleIndex || 0;
                    console.log('✅ Progress loaded from storage');
                    return true;
                } catch (error) {
                    console.log('⚠️ Error loading progress:', error);
                    return false;
                }
            }
            return false;
        }

        // Enhanced startLearningModule function that uses our new modal system
        function startLearningModule(moduleIndex) {
            console.log('🔍 DEBUG: startLearningModule called with index:', moduleIndex);

            // Prevent duplicate calls
            if (window.isModalOpen) {
                console.log('⚠️ DEBUG: Modal already open, ignoring duplicate call');
                return;
            }

            if (typeof window.currentPGYLevel === 'undefined' || typeof learningModulesConfig === 'undefined') {
                console.error('❌ Journey system not properly initialized');
                return;
            }

            const modules = learningModulesConfig[window.currentPGYLevel];
            const module = modules[moduleIndex];

            if (!module) {
                console.error('❌ Module not found:', moduleIndex);
                return;
            }

            console.log(`🎓 Starting learning module: ${module.title}`);

            // Set flag to prevent duplicate opens
            window.isModalOpen = true;

            // Close ERNEST dialogue first
            if (typeof closeErnestDialogue === 'function') {
                closeErnestDialogue();
            }

            // Animate the selected square
            if (typeof animateSquareSelection === 'function') {
                animateSquareSelection(moduleIndex);
            }

            // Show enhanced learning modal after brief animation
            setTimeout(() => {
                showEnhancedLearningModal(module, moduleIndex);
            }, 300);
        }

        // Enhanced modal function with our new system integration
        function showEnhancedLearningModal(module, moduleIndex) {
            const terrain = getTerrainTheme(moduleIndex, learningModulesConfig[window.currentPGYLevel].length);

            // Create beautiful modal HTML using our new system
            const modalHTML = `
                <div class="learning-modal-overlay" id="enhanced-modal-${moduleIndex}">
                    <div class="learning-modal" data-terrain="${terrain.theme}">
                        <!-- Journey Context Bar -->
                        <div class="journey-context-bar">
                            <div class="journey-breadcrumb">
                                <span>${terrain.decoration} ${terrain.theme}</span>
                                <span class="breadcrumb-separator">→</span>
                                <span>Module ${moduleIndex + 1} of ${learningModulesConfig[window.currentPGYLevel].length}</span>
                                <span class="breadcrumb-separator">→</span>
                                <span>PGY-${window.currentPGYLevel.charAt(3)}</span>
                            </div>
                            <button class="modal-close-btn" onclick="closeEnhancedModal(${moduleIndex})">Return to Journey</button>
                        </div>

                        <!-- Learning Content Area -->
                        <div class="learning-content-area" id="enhanced-content-${moduleIndex}">
                            <div class="content-header">
                                <div class="content-icon">${module.icon}</div>
                                <h2 class="content-title">${module.title}</h2>
                                <div class="content-competency">${module.competency}</div>
                                <p class="content-description">${module.description}</p>
                            </div>

                            <div class="content-loading">
                                <div class="loading-spinner"></div>
                                <p>Loading interactive learning content...</p>
                            </div>
                        </div>

                        <!-- ERNEST Helper -->
                        <div class="modal-ernest-guide" onclick="showModalErnestHelp(${moduleIndex})">
                            <div class="ernest-face">🤖</div>
                        </div>

                        <!-- Module Completion Footer -->
                        <div style="padding: 20px; border-top: 1px solid rgba(107, 159, 120, 0.2); background: #f8fafc;">
                            <div style="text-align: center;">
                                <button id="complete-enhanced-btn-${moduleIndex}"
                                        onclick="completeEnhancedModule(${moduleIndex})"
                                        style="background: #6b9f78; color: white; border: none; padding: 12px 30px; border-radius: 10px; font-weight: 600; cursor: pointer; opacity: 0.5; transition: all 0.3s ease;"
                                        disabled>
                                    Complete Module & Continue Journey
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;

            // Add modal to page
            document.body.insertAdjacentHTML('beforeend', modalHTML);
            const overlay = document.getElementById(`enhanced-modal-${moduleIndex}`);

            // Animate modal appearance
            requestAnimationFrame(() => {
                overlay.classList.add('active');
            });

            // Load content using our enhanced system
            setTimeout(() => {
                console.log('🔍 DEBUG: Starting content loading process...');
                console.log('🔍 DEBUG: Module:', module);
                console.log('🔍 DEBUG: Module Index:', moduleIndex);

                if (typeof generateLearningContentByType === 'function') {
                    console.log('✅ DEBUG: generateLearningContentByType function exists');

                    const contentArea = document.getElementById(`enhanced-content-${moduleIndex}`);
                    console.log('🔍 DEBUG: Content area found:', !!contentArea);

                    if (!contentArea) {
                        console.error('❌ DEBUG: Content area not found');
                        return;
                    }

                    const loadingDiv = contentArea.querySelector('.content-loading');
                    console.log('🔍 DEBUG: Loading div found:', !!loadingDiv);

                    try {
                        console.log('🔍 DEBUG: Calling generateLearningContentByType...');
                        const contentHTML = generateLearningContentByType(module, moduleIndex);
                        console.log('✅ DEBUG: Content generated successfully');
                        console.log('🔍 DEBUG: Content HTML length:', contentHTML ? contentHTML.length : 'null/undefined');
                        console.log('🔍 DEBUG: Content preview:', contentHTML ? contentHTML.substring(0, 200) : 'no content');

                        if (!contentHTML) {
                            console.error('❌ DEBUG: Generated content is empty');
                            return;
                        }

                        // Replace loading with actual content more quickly
                        setTimeout(() => {
                            console.log('🔍 DEBUG: Starting loading transition...');

                            // Immediately replace content
                            const newContent = `
                                <div class="content-header">
                                    <div class="content-icon">${module.icon}</div>
                                    <h2 class="content-title">${module.title}</h2>
                                    <div class="content-competency">${module.competency}</div>
                                    <p class="content-description">${module.description}</p>
                                </div>
                                ${contentHTML}
                            `;

                            // Clear everything and add new content
                            contentArea.innerHTML = newContent;
                            contentArea.style.opacity = '1';

                            console.log('✅ DEBUG: Content replaced and made visible');
                            console.log('🔍 DEBUG: Remaining loading elements:', contentArea.querySelectorAll('.content-loading, .loading-spinner').length);
                        }, 500);

                        // Enable completion button after content loads
                        setTimeout(() => {
                            console.log('🔍 DEBUG: Enabling completion button...');
                            const completeBtn = document.getElementById(`complete-enhanced-btn-${moduleIndex}`);
                            if (completeBtn) {
                                completeBtn.disabled = false;
                                completeBtn.style.opacity = '1';
                                console.log('✅ DEBUG: Completion button enabled');
                            } else {
                                console.log('⚠️ DEBUG: Completion button not found');
                            }
                        }, 3000);

                    } catch (error) {
                        console.error('💥 DEBUG: Error in content generation:', error);
                        console.error('💥 DEBUG: Error stack:', error.stack);
                    }

                } else {
                    console.error('❌ DEBUG: generateLearningContentByType function not available');
                    console.log('🔍 DEBUG: Available functions:', Object.keys(window).filter(key => key.includes('generate')));
                }
            }, 600);
        }

        function closeEnhancedModal(moduleIndex) {
            console.log('🔍 DEBUG: Closing modal for module:', moduleIndex);

            // Check if challenge is running and prevent modal close
            if (window.challengeRunning) {
                console.log('⚠️ DEBUG: Challenge is running, preventing modal close');
                return;
            }

            const overlay = document.getElementById(`enhanced-modal-${moduleIndex}`);
            if (overlay) {
                overlay.classList.remove('active');
                setTimeout(() => {
                    overlay.remove();
                    // Reset flag when modal is closed
                    window.isModalOpen = false;
                    console.log('✅ DEBUG: Modal closed and flag reset');
                }, 400);
            } else {
                // Reset flag even if overlay not found
                window.isModalOpen = false;
                console.log('✅ DEBUG: Modal flag reset (overlay not found)');
            }
        }

        function completeEnhancedModule(moduleIndex) {
            const modules = learningModulesConfig[window.currentPGYLevel];
            if (modules && modules[moduleIndex]) {
                // Mark as completed
                window.completedModules.add(modules[moduleIndex].id);
                if (moduleIndex >= window.currentModuleIndex) {
                    window.currentModuleIndex = moduleIndex + 1;
                }

                // Save progress
                saveProgressToStorage();

                // Show completion celebration
                showCompletionCelebration(modules[moduleIndex]);

                // Close modal and refresh board
                setTimeout(() => {
                    closeEnhancedModal(moduleIndex);
                    generateLearningBoard(window.currentPGYLevel);
                    updateProgressDashboard();
                }, 2000);

                console.log(`🎉 Module ${moduleIndex + 1} completed: ${modules[moduleIndex].title}`);
            }
        }

        function showCompletionCelebration(module) {
            const celebrationHTML = `
                <div style="position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; background: rgba(0,0,0,0.8); display: flex; align-items: center; justify-content: center; z-index: 3000;">
                    <div style="background: white; padding: 40px; border-radius: 20px; text-align: center; max-width: 400px;">
                        <div style="font-size: 4em; margin-bottom: 20px;">🎉</div>
                        <h3 style="color: #1e293b; margin-bottom: 15px;">Module Completed!</h3>
                        <p style="color: #64748b;"><strong>${module.title}</strong> has been mastered!</p>
                        <div style="margin-top: 25px;">
                            <p style="color: #6b9f78; font-weight: 600;">Your journey continues...</p>
                        </div>
                    </div>
                </div>
            `;

            document.body.insertAdjacentHTML('beforeend', celebrationHTML);

            setTimeout(() => {
                const celebration = document.querySelector('[style*="position: fixed"][style*="z-index: 3000"]');
                if (celebration) {
                    celebration.remove();
                }
            }, 2000);
        }

        // Override the existing functions to use our enhanced modal system
        window.startLearningModule = startLearningModule;

        // Override showErnestDialogue to use our modal system instead
        window.showErnestDialogue = function(moduleIndex) {
            console.log('🔍 DEBUG: showErnestDialogue called, redirecting to startLearningModule');
            startLearningModule(moduleIndex);
        };

        // Completely disable the old Ernest dialogue system
        window.closeErnestDialogue = function() {
            console.log('🔍 DEBUG: closeErnestDialogue called (disabled)');
        };

        // Initialize modal flag
        window.isModalOpen = false;

        // Global functions for nerve navigation (moved from modal content)
        window.showNerveType = function(nerveType) {
            console.log('🔍 DEBUG: showNerveType called with:', nerveType);
            // Hide all nerve content sections
            document.querySelectorAll('.nerve-content').forEach(section => {
                section.style.display = 'none';
            });

            // Show selected nerve content
            const selectedContent = document.getElementById(nerveType + '-content');
            if (selectedContent) {
                selectedContent.style.display = 'block';
                console.log('✅ DEBUG: Showing content for:', nerveType);
            } else {
                console.log('❌ DEBUG: Content not found for:', nerveType);
            }

            // Update nerve type button styles
            document.querySelectorAll('.nerve-type-btn').forEach(btn => {
                btn.style.background = '#f8fafc';
                btn.style.border = '2px solid #e2e8f0';
                btn.style.color = '#64748b';
            });

            // Highlight active nerve type button
            const activeBtn = document.querySelector('[data-nerve="' + nerveType + '"]');
            if (activeBtn) {
                if (nerveType === 'overview') {
                    activeBtn.style.background = '#fef3c7';
                    activeBtn.style.border = '2px solid #f59e0b';
                    activeBtn.style.color = '#d97706';
                } else {
                    activeBtn.style.background = 'white';
                    activeBtn.style.border = '3px solid #3b82f6';
                    activeBtn.style.color = '#1e40af';
                }
                console.log('✅ DEBUG: Highlighted button for:', nerveType);
            }
        };

        window.showMedianSection = function(sectionId) {
            console.log('🔍 DEBUG: showMedianSection called with:', sectionId);
            // Hide all median sections
            document.querySelectorAll('.median-section').forEach(section => {
                section.style.display = 'none';
            });

            // Show selected section
            const selectedSection = document.getElementById(sectionId);
            if (selectedSection) {
                selectedSection.style.display = 'block';
                console.log('✅ DEBUG: Showing median section:', sectionId);
            }

            // Update button styles within median content
            const medianContent = document.getElementById('median-content');
            if (medianContent) {
                medianContent.querySelectorAll('.nerve-nav-btn').forEach(btn => {
                    btn.style.background = '#f8fafc';
                    btn.style.border = '2px solid #e2e8f0';
                    btn.querySelectorAll('h5, p').forEach(el => el.style.color = '#64748b');
                });

                // Highlight active button
                const activeBtn = medianContent.querySelector('[data-section="' + sectionId + '"]');
                if (activeBtn) {
                    activeBtn.style.background = 'white';
                    activeBtn.style.border = '3px solid #3b82f6';
                    activeBtn.querySelectorAll('h5').forEach(el => el.style.color = '#1e40af');
                }
            }
        };

        window.showUlnarSection = function(sectionId) {
            console.log('🔍 DEBUG: showUlnarSection called with:', sectionId);
            // Hide all ulnar sections
            document.querySelectorAll('.ulnar-section').forEach(section => {
                section.style.display = 'none';
            });

            // Show selected section
            const selectedSection = document.getElementById(sectionId);
            if (selectedSection) {
                selectedSection.style.display = 'block';
                console.log('✅ DEBUG: Showing ulnar section:', sectionId);
            }

            // Update ulnar button styles within ulnar content
            const ulnarContent = document.getElementById('ulnar-content');
            if (ulnarContent) {
                ulnarContent.querySelectorAll('.nerve-nav-btn').forEach(btn => {
                    btn.style.background = '#f8fafc';
                    btn.style.border = '2px solid #e2e8f0';
                    btn.querySelectorAll('h5, p').forEach(el => el.style.color = '#64748b');
                });

                // Highlight active button
                const activeBtn = ulnarContent.querySelector('[data-section="' + sectionId + '"]');
                if (activeBtn) {
                    activeBtn.style.background = 'white';
                    activeBtn.style.border = '3px solid #3b82f6';
                    activeBtn.querySelectorAll('h5').forEach(el => el.style.color = '#1e40af');
                }
            }
        };

        // Global quiz function for median nerve content
        window.checkMedianAnswer = function(button, isCorrect) {
            console.log('🔍 DEBUG: checkMedianAnswer called with isCorrect:', isCorrect);
            const buttons = button.parentNode.querySelectorAll('.quiz-option');
            buttons.forEach(btn => btn.style.pointerEvents = 'none');

            if (isCorrect) {
                button.style.background = '#dcfce7';
                button.style.border = '2px solid #059669';
                button.style.color = '#059669';
                button.innerHTML += ' ✓ Correct! Normal thenar sensation (palmar cutaneous branch) localizes to carpal tunnel.';
            } else {
                button.style.background = '#fef2f2';
                button.style.border = '2px solid #dc2626';
                button.style.color = '#dc2626';
                button.innerHTML += ' ✗';
            }
        };

        // Pathway Explorer Global Functions
        window.pathwayExplorer = window.pathwayExplorer || {};
        window.pathwayExplorer.currentNerve = null;
        window.pathwayExplorer.currentStep = 0;
        window.pathwayExplorer.maxSteps = 0;

        window.pathwayExplorer.nerveData = {
            median: {
                name: "Median Nerve",
                roots: "C6-T1",
                image: "Nerve Paths/Median Nerve.png",
                story: "The Median Messenger starts his epic journey at the bustling Brachial Plexus Central Station (C6-T1), where lateral and medial cords shake hands to form our hero. He travels down the arm like a VIP, riding the bicipital groove limousine between the Biceps and Brachialis neighborhoods. At the Cubital Fossa rest stop, he takes a breather medial to the brachial artery before squeezing through the narrow Pronator Teres tunnel. His faithful sidekick, the Anterior Interosseous branch, splits off to handle the deep muscle work while our main character continues toward his final destination: the infamous Carpal Tunnel! After surviving this tight squeeze, he emerges victorious in the hand, ready to command the LOAF muscles like a general commanding his troops!",
                steps: [
                    {title: "Origin", desc: "Forms from lateral and medial cords of brachial plexus (C6-T1)"},
                    {title: "Upper Arm", desc: "Travels medially to humerus in bicipital groove"},
                    {title: "Cubital Fossa", desc: "Passes medial to brachial artery"},
                    {title: "Forearm Entry", desc: "Passes between heads of pronator teres"},
                    {title: "AIN Branch", desc: "Gives off anterior interosseous nerve"},
                    {title: "Carpal Tunnel", desc: "Passes through carpal tunnel"},
                    {title: "Hand", desc: "Divides into branches for thenar muscles (LOAF)"}
                ]
            },
            ulnar: {
                name: "Ulnar Nerve",
                roots: "C8-T1",
                image: "Nerve Paths/Ulnar Nerve.png",
                story: "The Ulnar Underdog begins as the lone ranger from the medial cord, carrying the pure power of C8 and T1. He travels down the arm, taking the scenic route around the medial epicondyle at the elbow - that famous 'funny bone' spot where everyone's felt his electric personality! He slides through Guyon's canal at the wrist like a secret agent, then splits his mission: the deep branch heads to the interossei (the hand's fine motor specialists), while the superficial branch handles sensation for the pinky side of life.",
                steps: [
                    {title: "Origin", desc: "Arises from medial cord of brachial plexus (C8-T1)"},
                    {title: "Upper Arm", desc: "Travels down medial aspect of arm"},
                    {title: "Cubital Tunnel", desc: "Passes through cubital tunnel behind medial epicondyle"},
                    {title: "Forearm", desc: "Travels between FCU and FDP in forearm"},
                    {title: "Guyon's Canal", desc: "Passes through Guyon's canal at wrist"},
                    {title: "Hand Division", desc: "Splits into superficial and deep branches"},
                    {title: "Hand Muscles", desc: "Innervates intrinsic hand muscles and sensation"}
                ]
            },
            radial: {
                name: "Radial Nerve",
                roots: "C5-T1",
                image: "Nerve Paths/Radial Nerve.png",
                story: "The Radial Rebel is the strong, silent type from the posterior cord, packing the full power of C5-T1. This mighty nerve takes the back route down the arm, spiraling around the humerus in the famous spiral groove like a roller coaster. He's the extension expert, powering all the muscles that straighten the elbow, lift the wrist, and extend the fingers. His most vulnerable moment comes at the spiral groove, where a broken humerus can leave him bruised and beaten, causing the dreaded 'wrist drop.'",
                steps: [
                    {title: "Origin", desc: "Arises from posterior cord (C5-T1)"},
                    {title: "Spiral Groove", desc: "Travels in spiral groove of humerus (vulnerable point)"},
                    {title: "Lateral Arm", desc: "Emerges laterally, pierces lateral intermuscular septum"},
                    {title: "Elbow Division", desc: "Divides into superficial and deep (PIN) branches"},
                    {title: "Posterior Forearm", desc: "PIN innervates extensor muscles"},
                    {title: "Dorsal Hand", desc: "Superficial branch provides dorsal hand sensation"}
                ]
            },
            musculocutaneous: {
                name: "Musculocutaneous Nerve",
                roots: "C5-C7",
                image: "Nerve Paths/Musculocutaneous Nerve.png",
                story: "The Musculocutaneous Marvel begins at the lateral cord headquarters in the brachial plexus, carrying orders from C5-C7. This sturdy nerve pierces through the coracobrachialis muscle like a determined warrior, then travels between the biceps brachii and brachialis muscles, supervising their every flex. As it approaches the elbow, it transforms into the lateral cutaneous nerve of the forearm, spreading its sensory network across the lateral forearm like a protective shield.",
                steps: [
                    {title: "Origin", desc: "Arises from lateral cord of brachial plexus (C5-C7)"},
                    {title: "Coracobrachialis", desc: "Pierces coracobrachialis muscle"},
                    {title: "Biceps Brachii", desc: "Innervates biceps brachii"},
                    {title: "Brachialis", desc: "Innervates lateral part of brachialis"},
                    {title: "Lateral Cutaneous", desc: "Becomes lateral cutaneous nerve of forearm"},
                    {title: "Forearm Sensation", desc: "Provides sensation to lateral forearm"}
                ]
            },
            axillary: {
                name: "Axillary Nerve",
                roots: "C5-C6",
                image: "Nerve Paths/Axillary Nerve.png",
                story: "The Axillary Ambassador emerges from the posterior cord, carrying the strength of C5 and C6. This diplomatic nerve travels posteriorly around the surgical neck of the humerus, navigating through the quadrilateral space like a secret agent. It has two important missions: powering the mighty deltoid muscle and providing sensation to the shoulder's badge of honor - that small patch of skin over the deltoid that soldiers call the 'regimental patch'.",
                steps: [
                    {title: "Origin", desc: "Arises from posterior cord (C5-C6)"},
                    {title: "Quadrilateral Space", desc: "Passes through quadrilateral space"},
                    {title: "Surgical Neck", desc: "Wraps around surgical neck of humerus"},
                    {title: "Deltoid Motor", desc: "Innervates deltoid muscle"},
                    {title: "Teres Minor", desc: "Innervates teres minor muscle"},
                    {title: "Cutaneous Branch", desc: "Provides sensation over deltoid (regimental patch)"}
                ]
            },
            femoral: {
                name: "Femoral Nerve",
                roots: "L2-L4",
                image: "Nerve Paths/Femoral Nerve.png",
                story: "The Femoral General emerges from the lumbar plexus with the authority of L2-L4. This commanding nerve travels under the inguinal ligament like a VIP passing through customs, then spreads its influence across the anterior thigh. It's the knee extension expert, powering the mighty quadriceps muscle group while also providing sensation down the medial leg via its saphenous branch - the longest sensory nerve in the body!",
                steps: [
                    {title: "Origin", desc: "Forms from lumbar plexus (L2-L4)"},
                    {title: "Inguinal Ligament", desc: "Passes under inguinal ligament"},
                    {title: "Femoral Triangle", desc: "Enters femoral triangle"},
                    {title: "Quadriceps", desc: "Innervates quadriceps muscle group"},
                    {title: "Saphenous Branch", desc: "Gives off saphenous nerve"},
                    {title: "Medial Leg", desc: "Saphenous nerve provides sensation to medial leg"}
                ]
            },
            tibial: {
                name: "Tibial Nerve",
                roots: "L4-S3",
                image: "Nerve Paths/Tibial Nerve.png",
                story: "The Tibial Traveler is one half of the mighty sciatic nerve's legacy, carrying the plantarflexion power of L4-S3. After the sciatic nerve splits at the popliteal fossa, this nerve takes the deep route down the posterior leg, traveling through the tarsal tunnel at the ankle like a train through a mountain pass. It's the pointing-toes expert, controlling all the muscles that push the foot down and curl the toes.",
                steps: [
                    {title: "Origin", desc: "Medial division of sciatic nerve (L4-S3)"},
                    {title: "Popliteal Fossa", desc: "Continues from sciatic bifurcation"},
                    {title: "Posterior Leg", desc: "Travels down posterior compartment"},
                    {title: "Plantarflexors", desc: "Innervates calf muscles and deep compartment"},
                    {title: "Tarsal Tunnel", desc: "Passes through tarsal tunnel at ankle"},
                    {title: "Foot Muscles", desc: "Innervates intrinsic foot muscles"}
                ]
            },
            peroneal: {
                name: "Peroneal (Fibular) Nerve",
                roots: "L4-S2",
                image: "Nerve Paths/Superficial Fibular Nerve.png",
                deepImage: "Nerve Paths/Deep Fibular Nerve.png",
                story: "The Peroneal Pioneer, also known as the Common Fibular nerve, is an adventurous branch of the mighty sciatic nerve. This nerve loves taking the scenic route around the fibular head, making it vulnerable but vital for foot function. It splits into two explorers: the superficial peroneal (the ankle evertor) and the deep peroneal (the toe lifter), each with their own important territories to govern in the lower leg and foot.",
                steps: [
                    {title: "Origin", desc: "Lateral division of sciatic nerve (L4-S2)"},
                    {title: "Fibular Head", desc: "Wraps around fibular head (vulnerable point)"},
                    {title: "Superficial Branch", desc: "Gives off superficial peroneal nerve"},
                    {title: "Deep Branch", desc: "Continues as deep peroneal nerve"},
                    {title: "Ankle Muscles", desc: "Innervates ankle dorsiflexors and everters"},
                    {title: "Foot Sensation", desc: "Provides sensation to dorsal foot and web spaces"}
                ]
            },
            sciatic: {
                name: "Sciatic Nerve",
                roots: "L4-S3",
                image: "Nerve Paths/Sciatic Nerve.png",
                story: "The Sciatic Supreme is the body's largest and most powerful nerve, combining the might of the lumbar and sacral plexuses. This heavyweight champion travels through the greater sciatic foramen, then runs down the posterior thigh like a mighty river. At the popliteal fossa, it typically splits into its two famous branches: the tibial nerve (the plantarflexion powerhouse) and the common peroneal nerve (the dorsiflexion dynamo).",
                steps: [
                    {title: "Origin", desc: "Forms from sacral plexus (L4-S3)"},
                    {title: "Greater Sciatic Foramen", desc: "Exits pelvis through greater sciatic foramen"},
                    {title: "Posterior Thigh", desc: "Travels down posterior thigh"},
                    {title: "Hamstring Muscles", desc: "Innervates hamstring muscles"},
                    {title: "Popliteal Fossa", desc: "Reaches popliteal fossa"},
                    {title: "Bifurcation", desc: "Splits into tibial and common peroneal nerves"}
                ]
            },
            obturator: {
                name: "Obturator Nerve",
                roots: "L2-L4",
                image: "Nerve Paths/Obturator Nerve.png",
                story: "The Obturator Officer is a specialized nerve with a unique mission: controlling hip adduction. Born from the lumbar plexus, this nerve takes an unusual route through the obturator foramen (hence its name), like a secret tunnel through the pelvis. It divides into anterior and posterior branches to command the adductor muscle army, helping bring the legs together and stabilize the hip during walking.",
                steps: [
                    {title: "Origin", desc: "Arises from lumbar plexus (L2-L4)"},
                    {title: "Obturator Foramen", desc: "Passes through obturator foramen"},
                    {title: "Anterior Branch", desc: "Splits into anterior branch"},
                    {title: "Posterior Branch", desc: "Splits into posterior branch"},
                    {title: "Adductor Muscles", desc: "Innervates adductor muscle group"},
                    {title: "Hip Sensation", desc: "Provides sensation to medial thigh"}
                ]
            }
        };

        window.selectNerve = function(nerveName) {
            console.log('🧠 Selecting nerve:', nerveName);
            const explorer = window.pathwayExplorer;
            if (!explorer.nerveData[nerveName]) {
                console.log('❌ Nerve not found:', nerveName);
                return;
            }

            explorer.currentNerve = explorer.nerveData[nerveName];
            explorer.currentStep = 0;
            explorer.maxSteps = explorer.currentNerve.steps.length;

            const pathwayContainer = document.getElementById('pathway-container');
            if (pathwayContainer) {
                pathwayContainer.style.display = 'block';
                console.log('✅ Pathway container shown');
            }

            const storyElement = document.getElementById('story-text');
            if (storyElement) {
                storyElement.innerHTML = explorer.currentNerve.story;
                console.log('✅ Story updated');
            }

            const imageElement = document.getElementById('nerve-pathway-image');
            if (imageElement) {
                let imageHtml = '';

                // Special case for peroneal nerve - show both superficial and deep fibular
                if (nerveName === 'peroneal' && explorer.currentNerve.deepImage) {
                    imageHtml = '<div style="text-align: center;"><h6 style="color: #0c4a6e; margin-bottom: 15px; font-size: 1.1em;">' + explorer.currentNerve.name + '</h6><p style="color: #64748b; margin-bottom: 15px;">Nerve Roots: ' + explorer.currentNerve.roots + '</p>' +
                    '<div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">' +
                    '<div><h6 style="color: #0369a1; font-size: 1em; margin-bottom: 8px;">Superficial Fibular</h6><img src="' + explorer.currentNerve.image + '" alt="Superficial Fibular Nerve Pathway" style="width: 100%; height: auto; border-radius: 8px; border: 2px solid #bae6fd;"></div>' +
                    '<div><h6 style="color: #0369a1; font-size: 1em; margin-bottom: 8px;">Deep Fibular</h6><img src="' + explorer.currentNerve.deepImage + '" alt="Deep Fibular Nerve Pathway" style="width: 100%; height: auto; border-radius: 8px; border: 2px solid #bae6fd;"></div>' +
                    '</div></div>';
                } else if (explorer.currentNerve.image) {
                    // Regular nerve with single image
                    imageHtml = '<div style="text-align: center;"><h6 style="color: #0c4a6e; margin-bottom: 10px; font-size: 1.1em;">' + explorer.currentNerve.name + '</h6><p style="color: #64748b; margin-bottom: 15px;">Nerve Roots: ' + explorer.currentNerve.roots + '</p><img src="' + explorer.currentNerve.image + '" alt="' + explorer.currentNerve.name + ' Pathway" style="width: 100%; height: auto; border-radius: 8px; border: 2px solid #bae6fd;"></div>';
                } else {
                    // Fallback for nerves without images
                    imageHtml = '<div style="text-align: center;"><div style="font-size: 3em; margin-bottom: 15px; color: #0ea5e9;">🧠</div><h6 style="color: #0c4a6e; margin-bottom: 10px; font-size: 1.1em;">' + explorer.currentNerve.name + '</h6><p style="color: #64748b;">Nerve Roots: ' + explorer.currentNerve.roots + '</p><p style="color: #94a3b8; font-size: 0.9em; margin-top: 15px; padding: 10px; background: #f1f5f9; border-radius: 6px;">[Image not available]</p></div>';
                }

                imageElement.innerHTML = imageHtml;
                console.log('✅ Nerve image updated for:', nerveName);
            }

            window.showStep(0);

            document.querySelectorAll('.nerve-btn').forEach(btn => {
                btn.style.background = 'white';
                btn.style.color = '#0c4a6e';
            });

            const clickedButton = document.querySelector('button[onclick*="' + nerveName + '"]');
            if (clickedButton) {
                clickedButton.style.background = '#0ea5e9';
                clickedButton.style.color = 'white';
                console.log('✅ Button highlighted');
            }
        };

        window.showStep = function(stepIndex) {
            const explorer = window.pathwayExplorer;
            if (!explorer.currentNerve || stepIndex < 0 || stepIndex >= explorer.maxSteps) return;

            explorer.currentStep = stepIndex;

            const stepsElement = document.getElementById('pathway-steps');
            if (stepsElement) {
                let stepsHtml = '';
                for (let i = 0; i < explorer.currentNerve.steps.length; i++) {
                    const s = explorer.currentNerve.steps[i];
                    const bgColor = i === stepIndex ? '#f0fdf4' : (i < stepIndex ? '#ecfdf5' : '#f9fafb');
                    const borderColor = i <= stepIndex ? '#10b981' : '#e5e7eb';
                    const titleColor = i <= stepIndex ? '#059669' : '#6b7280';
                    const descColor = i <= stepIndex ? '#374151' : '#9ca3af';

                    stepsHtml += '<div style="padding: 10px; margin-bottom: 8px; border-radius: 8px; border-left: 4px solid ' + borderColor + '; background: ' + bgColor + ';"><div style="font-weight: 600; color: ' + titleColor + '; margin-bottom: 4px;">' + (i + 1) + '. ' + s.title + '</div><div style="color: ' + descColor + '; font-size: 0.95em;">' + s.desc + '</div></div>';
                }
                stepsElement.innerHTML = stepsHtml;
            }

            const prevBtn = document.getElementById('prev-btn');
            const nextBtn = document.getElementById('next-btn');
            if (prevBtn) {
                prevBtn.disabled = stepIndex === 0;
                prevBtn.style.opacity = stepIndex === 0 ? '0.5' : '1';
            }
            if (nextBtn) {
                nextBtn.disabled = stepIndex === explorer.maxSteps - 1;
                nextBtn.style.opacity = stepIndex === explorer.maxSteps - 1 ? '0.5' : '1';
            }
        };

        window.nextStep = function() {
            const explorer = window.pathwayExplorer;
            if (explorer.currentStep < explorer.maxSteps - 1) {
                window.showStep(explorer.currentStep + 1);
            }
        };

        window.previousStep = function() {
            const explorer = window.pathwayExplorer;
            if (explorer.currentStep > 0) {
                window.showStep(explorer.currentStep - 1);
            }
        };

        window.resetPathway = function() {
            const explorer = window.pathwayExplorer;
            if (explorer.currentNerve) {
                window.showStep(0);
            }
        };

        // Function to close general modal
        window.closeGeneralModal = function() {
            const modalOverlay = document.getElementById('modal-overlay');
            if (modalOverlay) {
                modalOverlay.style.display = 'none';
            }
        };

        // ===============================================
        // ATRIUM HEALTH 13-MODULE PATHWAY SYSTEM
        // ===============================================

        // Module Configuration with Custom Artwork Integration
        const atriumModuleConfig = [
            { id: 'emg-introduction', title: 'EMG/NCS Introduction', customIcon: 'NEW ICONS/EMG:NCS Intro.png' },
            { id: 'plexus-anatomy', title: 'Peripheral Anatomy', customIcon: 'NEW ICONS/Peripheral Anatomy.png' },
            { id: 'brachial-plexus-interactive', title: 'Brachial Plexus Interactive', customIcon: 'NEW ICONS/Brachial Plexus Anatomy.png' },
            { id: 'radiculopathy-pathophysiology', title: 'Radiculopathy Pathophysiology', customIcon: 'NEW ICONS/Radiculopathy Pathophysiology.png' },
            { id: 'neuropathy-pathophysiology', title: 'Neuropathy Pathophysiology', customIcon: 'NEW ICONS/Neuropathy Pathophysiology.png' },
            { id: 'ncs-fundamentals', title: 'NCS Fundamentals', customIcon: 'NEW ICONS/NCS Fundamentals.png' },
            { id: 'ncs-techniques', title: 'NCS Techniques', customIcon: 'NEW ICONS/NCS Techniques.png' },
            { id: 'emg-needle-localization', title: 'EMG Needle Localization', customIcon: 'NEW ICONS/EMG Needle localization.png' },
            { id: 'muscle-quiz', title: 'Muscle Study Lab', customIcon: 'NEW ICONS/muscle study lab.png' },
            { id: 'basic-patterns', title: 'Basic Pattern Recognition', customIcon: 'NEW ICONS/Basic Pattern Recognition.png' },
            { id: 'neuropathy-myopathy-basics', title: 'Neuropathy vs Myopathy Basics', customIcon: 'NEW ICONS/Neuropathy vs. Myopathy Basics.png' },
            { id: 'simple-reports', title: 'Basic Report Writing', customIcon: 'NEW ICONS/Basic report writing.png' },
            { id: 'clinical-correlation', title: 'Clinical Application', customIcon: 'NEW ICONS/Clinical application.png' }
        ];

        // Old ERNEST Messages Removed - Now Using Dynamic Description System

        // Create Pre-Positioned Description Boxes
        function createDescriptionBoxes() {
            const boardContainer = document.getElementById('learning-board');

            // Create 13 description boxes, one for each module
            for (let moduleNumber = 1; moduleNumber <= 13; moduleNumber++) {
                const desc = moduleDescriptions[moduleNumber] || {
                    title: `Module ${moduleNumber}`,
                    text: "Description coming soon.",
                    highlights: ""
                };

                const side = (moduleNumber - 1) % 2 === 0 ? 'left' : 'right';

                // Create the description box element
                const descriptionBox = document.createElement('div');
                descriptionBox.id = `description-box-${moduleNumber}`;
                descriptionBox.className = `ernest-description-box module-${moduleNumber}-description`;
                descriptionBox.innerHTML = `
                    <div class="description-ernest">
                        <img src="ERNEST.png" alt="ERNEST" class="description-ernest-avatar">
                        <div class="description-content">
                            <div class="description-title">${desc.title}</div>
                            <div class="description-text">${desc.text}</div>
                            <div class="description-highlights">${desc.highlights}</div>
                        </div>
                    </div>
                `;

                // Add to the page
                boardContainer.appendChild(descriptionBox);

                // Position it parallel to the corresponding module (will be refined in next step)
                positionDescriptionBox(descriptionBox, moduleNumber, side);
            }

            console.log('✅ Created 13 pre-positioned description boxes');

            // Add window resize handler to reposition boxes
            window.addEventListener('resize', () => {
                for (let moduleNumber = 1; moduleNumber <= 13; moduleNumber++) {
                    const box = document.getElementById(`description-box-${moduleNumber}`);
                    const side = (moduleNumber - 1) % 2 === 0 ? 'left' : 'right';
                    if (box) {
                        positionDescriptionBox(box, moduleNumber, side);
                    }
                }
            });
        }

        // Position Description Box Parallel to Module Icon
        function positionDescriptionBox(box, moduleNumber, side) {
            // Find the corresponding module element
            const moduleElement = document.querySelector(`[onmouseover*="showModuleDescription(${moduleNumber}"]`);
            if (!moduleElement) {
                console.warn(`Module ${moduleNumber} not found for positioning`);
                return;
            }

            // Get the pathway center line element to calculate precise center
            const centerLine = document.querySelector('.pathway-center-line');
            const moduleRect = moduleElement.getBoundingClientRect();
            const centerRect = centerLine ? centerLine.getBoundingClientRect() : null;

            // Calculate the center of the page/pathway
            const pageCenter = centerRect ? centerRect.left + (centerRect.width / 2) : window.innerWidth / 2;

            // Calculate vertical position (parallel to module icon)
            const scrollY = window.scrollY;
            const topPosition = moduleRect.top + scrollY + (moduleRect.height / 2) - 100; // Center vertically with box

            // Calculate horizontal position (opposite side of center line)
            let leftPosition;
            const boxWidth = 350; // Match CSS width
            const spacing = 150; // Increased gap between center line and description box

            if (side === 'left') {
                // Module on left, description on right side of center
                leftPosition = pageCenter + spacing;
            } else {
                // Module on right, description on left side of center
                leftPosition = pageCenter - spacing - boxWidth;
            }

            // Ensure description boxes don't go off-screen
            const minLeft = 20;
            const maxLeft = window.innerWidth - boxWidth - 20;
            leftPosition = Math.max(minLeft, Math.min(maxLeft, leftPosition));

            // Apply positioning
            box.style.position = 'fixed';
            box.style.top = topPosition + 'px';
            box.style.left = leftPosition + 'px';
            box.style.opacity = '0'; // Hidden initially
            box.style.pointerEvents = 'none'; // Non-interactive when hidden

            // console.log(`Positioned description box ${moduleNumber} (${side}) at top: ${topPosition}px, left: ${leftPosition}px`);
        }

        // Generate 13-Module Pathway
        function generateAtriumPathway(pgyLevel) {
            console.log('🏥 Generating Atrium Health 13-Module Pathway...');

            const boardContainer = document.getElementById('learning-board');
            if (!boardContainer) {
                console.error('❌ Learning board container not found');
                return;
            }

            // Progress tracking removed - simplified pathway generation

            // Generate pathway HTML
            const pathwayHTML = `
                <div class="atrium-pathway-container">
                    <div class="pathway-background-animation"></div>
                    <!-- Pathway Header -->
                    <div class="pathway-header">
                        <h1 class="pathway-title">
                            <img src="atrium.jpeg" alt="Atrium Health" class="atrium-logo-title">
                            EMG/NCS Learning Pathway
                        </h1>
                        <p class="pathway-subtitle">Comprehensive Electrodiagnostic Medicine Training</p>
                    </div>

                    <!-- 13-Module Vertical Pathway -->
                    <div class="modules-pathway">
                        <!-- Center Line -->
                        <div class="pathway-center-line"></div>

                        ${atriumModuleConfig.map((module, index) => generateModuleHTML(module, index)).join('')}
                    </div>
                </div>
            `;

            console.log('🔍 DEBUG: Generated HTML length:', pathwayHTML.length);

            // Add loading class for smooth transition
            boardContainer.classList.add('pathway-loading');

            // Set content
            boardContainer.innerHTML = pathwayHTML;

            // Trigger smooth loading animation
            setTimeout(() => {
                boardContainer.classList.remove('pathway-loading');
                boardContainer.classList.add('pathway-loaded');

                // Create pre-positioned description boxes after modules are loaded
                setTimeout(() => {
                    createDescriptionBoxes();
                }, 100);
            }, 50);

            console.log('🔍 DEBUG: Board container innerHTML set with smooth loading');

            // ERNEST welcome dialogue removed - now using dynamic descriptions

            console.log('✅ Atrium Health Pathway Generated Successfully!');
        }

        // Generate Individual Module HTML
        function generateModuleHTML(module, index) {
            const side = index % 2 === 0 ? 'left' : 'right';
            const moduleNumber = index + 1;

            return `
                <div class="pathway-module ${side}"
                     onmouseover="showModuleDescription(${moduleNumber}, '${side}')"
                     onmouseout="hideModuleDescription()"
                     onclick="openAtriumModule(${moduleNumber}, '${module.id}')">

                    <!-- Module Number Circle -->
                    <div class="module-number-circle">
                        ${moduleNumber}
                    </div>

                    <!-- Module Content with Layered Background Effect -->
                    <div class="module-background-box">
                        <div class="module-card">
                            <img src="${module.customIcon}" alt="${module.title}" class="module-custom-icon"
                                 onerror="this.style.display='none'; this.parentNode.innerHTML='<div style=\\'color:#6b9f78;font-size:2em;\\'>${moduleNumber}</div>';">
                        </div>
                    </div>

                </div>
            `;
        }

        // Open Module with Modal Integration
        function openAtriumModule(moduleNumber, moduleId) {
            console.log(`🎓 Opening Module ${moduleNumber}: ${moduleId}`);

            // Create module object for existing modal system
            const module = { contentId: moduleId, id: moduleId };

            try {
                // Use existing modal content generator
                if (typeof generateLearningContentByType === 'function') {
                    const content = generateLearningContentByType(module, moduleNumber - 1);
                    if (content && typeof window.showModal === 'function') {
                        window.showModal(`Module ${moduleNumber}: ${atriumModuleConfig[moduleNumber - 1].title}`, content);
                        console.log(`✅ Module ${moduleNumber} opened successfully`);
                    } else {
                        console.error(`❌ No content generated for module ${moduleNumber}`);
                        showFallbackContent(moduleNumber, moduleId);
                    }
                } else {
                    console.error('❌ generateLearningContentByType function not available');
                    showFallbackContent(moduleNumber, moduleId);
                }
            } catch (error) {
                console.error(`❌ Error opening module ${moduleNumber}:`, error);
                showFallbackContent(moduleNumber, moduleId);
            }
        }

        // Fallback content if modal generators fail
        function showFallbackContent(moduleNumber, moduleId) {
            if (typeof window.showModal === 'function') {
                window.showModal(`Module ${moduleNumber}`, `
                    <div style="text-align: center; padding: 40px;">
                        <div style="font-size: 3em; margin-bottom: 20px;">⚠️</div>
                        <h3>Content Loading Error</h3>
                        <p>Unable to load content for this module.</p>
                        <p><strong>Module:</strong> ${moduleId}</p>
                        <p>Please check that all required JavaScript files are loaded.</p>
                    </div>
                `);
            }
        }

        // Dynamic Module Description System
        const moduleDescriptions = {
            1: {
                title: "EMG/NCS Introduction",
                text: "Master the fundamental principles of electrodiagnostic medicine! This comprehensive module covers patient preparation, safety protocols, basic neurophysiology, and the clinical applications that make EMG/NCS an essential diagnostic tool.",
                highlights: "Topics: Patient care, safety, basic principles, clinical applications"
            },
            2: {
                title: "Peripheral Anatomy",
                text: "Build your anatomical foundation with detailed nerve pathway mapping. Learn the complex relationships between peripheral nerves, muscles, and clinical presentations to become an expert diagnostician.",
                highlights: "Topics: Nerve anatomy, muscle innervation, anatomical variations"
            },
            3: {
                title: "Brachial Plexus Interactive",
                text: "Explore the most complex nerve network in the body! This interactive module helps you visualize brachial plexus anatomy, understand injury patterns, and correlate findings with clinical presentations.",
                highlights: "Topics: Interactive anatomy, injury patterns, clinical correlations"
            },
            4: {
                title: "Radiculopathy Pathophysiology",
                text: "Understand the mechanisms behind nerve root compression and irritation. Learn to differentiate radiculopathy from other conditions and master the EMG/NCS findings that confirm your diagnosis.",
                highlights: "Topics: Nerve root compression, differential diagnosis, EMG patterns"
            },
            5: {
                title: "Neuropathy Pathophysiology",
                text: "Distinguish between axonal and demyelinating processes with confidence! This fundamental knowledge shapes your entire approach to peripheral nerve disorders and treatment planning.",
                highlights: "Topics: Axonal vs demyelinating, pathophysiology, treatment implications"
            },
            6: {
                title: "NCS Fundamentals",
                text: "Dive deep into nerve conduction studies! Master electrode placement, stimulation techniques, measurement interpretation, and learn to differentiate normal from pathological findings.",
                highlights: "Topics: Electrode placement, stimulation, normal values, interpretation"
            },
            7: {
                title: "NCS Techniques",
                text: "Perfect your technical skills with advanced nerve conduction study techniques. Learn troubleshooting strategies, optimal positioning, and how to obtain reliable, reproducible results.",
                highlights: "Topics: Advanced techniques, troubleshooting, quality control"
            },
            8: {
                title: "EMG Needle Localization",
                text: "Master precise needle electrode placement using anatomical landmarks. Learn safe insertion techniques, avoid complications, and ensure accurate muscle sampling for reliable results.",
                highlights: "Topics: Needle placement, anatomical landmarks, safety protocols"
            },
            9: {
                title: "Muscle Study Laboratory",
                text: "Explore comprehensive muscle anatomy with our advanced Preston & Shapiro laboratory database. Interactive muscle exploration with detailed anatomical references and clinical correlations.",
                highlights: "Topics: Muscle anatomy, Preston & Shapiro database, interactive learning"
            },
            10: {
                title: "Basic Pattern Recognition",
                text: "Develop your pattern recognition skills for abnormal spontaneous activity. Learn to identify fibrillations, positive sharp waves, fasciculations, and other key EMG findings.",
                highlights: "Topics: Spontaneous activity, pattern recognition, EMG waveforms"
            },
            11: {
                title: "Neuropathy vs Myopathy",
                text: "Master the critical distinction between nerve and muscle disorders. Learn the EMG/NCS patterns that differentiate neuropathies from myopathies and guide appropriate treatment.",
                highlights: "Topics: Differential diagnosis, EMG patterns, clinical implications"
            },
            12: {
                title: "Basic Report Writing",
                text: "Learn to write clear, clinically relevant EMG/NCS reports. Understand report structure, proper terminology, and how to communicate findings effectively to referring physicians.",
                highlights: "Topics: Report structure, medical terminology, clinical communication"
            },
            13: {
                title: "Clinical Application",
                text: "Apply everything you've learned with real clinical scenarios and comprehensive case studies. Practice the complete EMG/NCS workflow from history to final diagnosis.",
                highlights: "Topics: Clinical cases, workflow, diagnostic reasoning, real scenarios"
            }
        };


        // Global variables for ERNEST system
        let hideTimer = null;


        // Old single-panel functions removed - now using panel-specific functions

        function hideModuleDescription() {
            // Clear any existing timer
            if (hideTimer) {
                clearTimeout(hideTimer);
            }

            // Set 2-second delay for smooth user experience
            hideTimer = setTimeout(() => {
                // Hide all visible description boxes
                const visibleBoxes = document.querySelectorAll('.ernest-description-box.show');
                visibleBoxes.forEach(box => {
                    box.classList.remove('show');
                });
                hideTimer = null;
            }, 2000);
        }

        function showModuleDescription(moduleNumber, moduleSide) {
            // Cancel any pending hide timer
            if (hideTimer) {
                clearTimeout(hideTimer);
                hideTimer = null;
            }

            // Hide all other description boxes first
            const allBoxes = document.querySelectorAll('.ernest-description-box');
            allBoxes.forEach(box => {
                box.classList.remove('show');
            });

            // Show the specific description box for this module
            const targetBox = document.getElementById(`description-box-${moduleNumber}`);
            if (targetBox) {
                targetBox.classList.add('show');
                // console.log(`Showing description for module ${moduleNumber}`);
            } else {
                console.error(`❌ Description box not found for module ${moduleNumber}`);
            }
        }






        // Override the existing generateLearningBoard function
        window.generateLearningBoard = generateAtriumPathway;

        // Make sure all functions are available globally
        window.startAtriumJourney = startAtriumJourney;
        window.showModuleDescription = showModuleDescription;
        window.hideModuleDescription = hideModuleDescription;

        // Tab Navigation Function for Enhanced EMG Introduction
        function showEMGSection(sectionName) {
            console.log('🔄 Switching to EMG section:', sectionName);

            // Hide all EMG sections
            const sections = document.querySelectorAll('.emg-section');
            sections.forEach(section => {
                section.style.display = 'none';
            });

            // Show the selected section
            const targetSection = document.getElementById(sectionName + '-section');
            if (targetSection) {
                targetSection.style.display = 'block';
            }

            // Update tab styling
            const tabs = document.querySelectorAll('.emg-tab');
            tabs.forEach(tab => {
                tab.style.background = 'transparent';
                tab.style.color = '#64748b';
            });

            // Highlight active tab
            const activeTab = document.getElementById(sectionName + '-tab');
            if (activeTab) {
                activeTab.style.background = '#3b82f6';
                activeTab.style.color = 'white';
            }

            console.log('✅ EMG section switched to:', sectionName);
        }

        // Make functions globally available
        window.generateAtriumPathway = generateAtriumPathway;
        window.openAtriumModule = openAtriumModule;
        window.showModuleDescription = showModuleDescription;
        window.hideModuleDescription = hideModuleDescription;
        window.showEMGSection = showEMGSection;
        window.returnToMainPage = returnToMainPage;

        console.log('✨🎮 Enhanced Journey with Integrated Modal System - Ready!');
    </script>

    <!-- General Modal for Clinical Cases -->
    <div id="modal-overlay" style="position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; background: rgba(0,0,0,0.9); z-index: 999999; display: none; justify-content: center; align-items: center; overflow-y: auto;">
        <div style="background: white; border-radius: 15px; width: 95%; max-width: 1200px; max-height: 95vh; overflow-y: auto; position: relative; margin: 20px; box-shadow: 0 20px 60px rgba(0,0,0,0.3);">
            <div style="padding: 25px; border-bottom: 2px solid #e5e7eb; background: linear-gradient(135deg, #f3f4f6, #e5e7eb); border-radius: 15px 15px 0 0;">
                <h2 id="modal-title" style="margin: 0; color: #1f2937; font-size: 24px; font-weight: 700;"></h2>
                <button onclick="closeGeneralModal()" style="position: absolute; top: 20px; right: 20px; background: #ef4444; color: white; border: none; font-size: 20px; cursor: pointer; width: 35px; height: 35px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold; transition: all 0.2s;">×</button>
            </div>
            <div id="modal-body" style="padding: 30px; background: white; border-radius: 0 0 15px 15px;">
            </div>
        </div>
    </div>

    <!-- Description Panel Now Generated in Pathway HTML -->

    <!-- New UI Layout System - DISABLED (using custom Atrium Health system) -->
    <!-- <script src="js/new-ui-layout.js"></script> -->

    <script>
        function closeGeneralModal() {
            const overlay = document.getElementById('modal-overlay');
            if (overlay) {
                overlay.style.display = 'none';
                console.log('🔒 Modal closed');
            }
        }

        // Add CSS styles for modal
        const modalStyles = document.createElement('style');
        modalStyles.textContent = `
            #modal-overlay button:hover {
                background: #dc2626 !important;
                transform: scale(1.1);
            }

            #modal-overlay .interactive-content {
                max-width: 100%;
                margin: 0;
            }

            #modal-overlay .quiz-section {
                margin-bottom: 20px;
            }
        `;
        document.head.appendChild(modalStyles);

        // Close modal when clicking outside
        document.addEventListener('DOMContentLoaded', function() {
            const overlay = document.getElementById('modal-overlay');
            if (overlay) {
                overlay.addEventListener('click', function(e) {
                    if (e.target === this) {
                        closeGeneralModal();
                    }
                });
            }
        });

        // Add keyboard support for ESC key
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                const overlay = document.getElementById('modal-overlay');
                if (overlay && overlay.style.display === 'flex') {
                    closeGeneralModal();
                }
            }
        });
    </script>
</body>
</html>