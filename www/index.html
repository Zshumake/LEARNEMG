<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport"
        content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes, viewport-fit=cover">
    <title>‚ú® Enhanced Journey EMG/NCS Learning System - Full Integration</title>
    <link rel="icon" type="image/png" href="ERNEST.png">
    <link rel="apple-touch-icon" href="ERNEST.png">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="manifest" href="manifest.json">
    <link rel="stylesheet" href="css/enhanced-journey-candyland.css?v=20251203-layout-fix">
    <link rel="stylesheet" href="css/professional-board-candyland.css">
    <style>
        /* Clean Medical Background System */
        * {
            box-sizing: border-box;
        }

        :root {
            display: block !important;
            background: none !important;
        }

        html {
            background: linear-gradient(135deg, #6b9f78 0%, #5a8a67 100%);
            min-height: 100vh;
            width: 100%;
            overflow-x: hidden;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            line-height: 1.6;
            color: #1f2937;
            background: transparent;
            min-height: 100vh;
            width: 100%;
            position: relative;
            overflow-x: hidden;
            margin: 0;
            padding: 0;
        }

        /* Clinical Cases System Styles */
        .case-step {
            display: none;
        }

        .case-step.active {
            display: block !important;
        }

        .progress-bar {
            width: 100%;
            height: 8px;
            background: #e5e7eb;
            border-radius: 4px;
            margin-bottom: 20px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #6b9f78, #4a6d52);
            border-radius: 4px;
            transition: width 0.3s ease;
        }

        .case-card {
            background: white;
            border-radius: 12px;
            padding: 20px;
            margin: 15px 0;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .case-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.15);
        }

        .case-card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .case-difficulty {
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: bold;
        }

        .case-difficulty.beginner {
            background: #10b981;
            color: white;
        }

        .case-difficulty.intermediate {
            background: #f59e0b;
            color: white;
        }

        .case-difficulty.difficult {
            background: #ef4444;
            color: white;
        }

        .case-stages {
            display: flex;
            gap: 8px;
            margin-top: 15px;
            flex-wrap: wrap;
        }

        .case-stages span {
            background: #f3f4f6;
            padding: 4px 8px;
            border-radius: 8px;
            font-size: 12px;
            color: #6b7280;
        }

        .stage-explanation {
            display: grid;
            gap: 15px;
            margin-top: 15px;
        }

        .stage-item {
            display: flex;
            align-items: flex-start;
            gap: 12px;
            padding: 15px;
            background: #f8fafc;
            border-radius: 8px;
        }

        .stage-icon {
            font-size: 24px;
            flex-shrink: 0;
        }

        .quiz-button {
            background: #6b9f78;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            margin: 10px 5px;
        }

        .quiz-button:hover {
            background: #4a6d52;
            transform: translateY(-1px);
        }

        .differential-input {
            width: 100%;
            padding: 15px;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            font-family: inherit;
            font-size: 14px;
            resize: vertical;
            min-height: 120px;
        }

        .differential-input:focus {
            outline: none;
            border-color: #6b9f78;
        }



        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background:
                radial-gradient(circle at 20% 80%, rgba(107, 159, 120, 0.15) 0%, transparent 50%),
                radial-gradient(circle at 80% 20%, rgba(34, 197, 94, 0.1) 0%, transparent 50%),
                radial-gradient(circle at 60% 60%, rgba(168, 85, 247, 0.08) 0%, transparent 50%);
            pointer-events: none;
            z-index: -1;
        }

        /* Enhanced PGY Selection Screen */
        .enhanced-pgy-selection {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            text-align: center;
            padding: 40px 20px;
        }

        .selection-title-card {
            background: linear-gradient(135deg, #fefcf3 0%, #f8fafc 100%);
            border: 3px solid rgba(107, 159, 120, 0.2);
            border-radius: 30px;
            padding: 50px;
            margin-bottom: 50px;
            box-shadow:
                0 25px 70px rgba(107, 159, 120, 0.15),
                inset 0 1px 0 rgba(255, 255, 255, 0.8);
            position: relative;
            overflow: hidden;
            animation: gentleFloat 6s ease-in-out infinite;
        }

        .selection-title-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg,
                    transparent,
                    rgba(34, 197, 94, 0.1),
                    rgba(168, 85, 247, 0.1),
                    rgba(234, 179, 8, 0.1),
                    transparent);
            animation: journeyShimmer 4s infinite;
        }

        @keyframes journeyShimmer {
            0% {
                left: -100%;
            }

            100% {
                left: 100%;
            }
        }

        @keyframes gentleFloat {

            0%,
            100% {
                transform: translateY(0);
            }

            50% {
                transform: translateY(-10px);
            }
        }

        .main-title {
            font-size: 3.5em;
            color: #1e293b;
            margin-bottom: 15px;
            font-weight: 800;
        }

        .main-subtitle {
            font-size: 1.3em;
            color: #64748b;
            margin-bottom: 30px;
        }

        .pgy-selection-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 30px;
            max-width: 900px;
            margin: 0 auto;
        }

        .pgy-card {
            background: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%);
            border: 2px solid rgba(107, 159, 120, 0.2);
            border-radius: 25px;
            padding: 40px 30px;
            cursor: pointer;
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
        }

        .pgy-card:hover {
            transform: translateY(-8px) scale(1.02);
            box-shadow: 0 20px 50px rgba(107, 159, 120, 0.25);
            border-color: rgba(107, 159, 120, 0.4);
        }

        .pgy-level {
            font-size: 2.5em;
            font-weight: 800;
            color: #1e293b;
            margin-bottom: 15px;
        }

        .pgy-description {
            color: #64748b;
            font-size: 1.1em;
            line-height: 1.5;
        }

        .hidden {
            display: none !important;
        }

        /* Enhanced quiz styling */
        .quiz-options {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin-top: 15px;
        }

        .quiz-option {
            background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
            border: 2px solid rgba(107, 159, 120, 0.2);
            border-radius: 10px;
            padding: 12px 20px;
            cursor: pointer;
            transition: all 0.2s ease;
            text-align: left;
            font-size: 0.95em;
        }

        .quiz-option:hover {
            background: linear-gradient(135deg, #6b9f78 0%, #4a6d52 100%);
            color: white;
            transform: translateX(5px);
        }

        .quiz-option.correct {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
            border-color: #059669;
        }

        .quiz-option.incorrect {
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
            color: white;
            border-color: #dc2626;
        }

        .quiz-result {
            background: #f0f9ff;
            border: 2px solid #0ea5e9;
            border-radius: 10px;
            padding: 15px;
            margin-top: 15px;
            font-weight: 500;
        }

        .quiz-result.correct {
            background: #f0fdf4;
            border-color: #10b981;
            color: #065f46;
        }

        .quiz-result.incorrect {
            background: #fef2f2;
            border-color: #ef4444;
            color: #991b1b;
        }

        /* Progress Dashboard Styles */
        .progress-dashboard {
            padding: 30px;
            max-width: 1200px;
            margin: 0 auto;
        }

        .dashboard-header {
            text-align: center;
            margin-bottom: 30px;
        }

        .dashboard-header h3 {
            color: #1e293b;
            font-size: 2em;
            margin-bottom: 20px;
        }

        .dashboard-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%);
            border: 2px solid rgba(107, 159, 120, 0.2);
            border-radius: 15px;
            padding: 25px;
            text-align: center;
            transition: all 0.3s ease;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.15);
            border-color: rgba(107, 159, 120, 0.4);
        }

        .stat-number {
            font-size: 2.5em;
            font-weight: 800;
            color: #6b9f78;
            margin-bottom: 8px;
        }

        .stat-label {
            color: #64748b;
            font-size: 1.1em;
            font-weight: 500;
        }

        .achievement-showcase {
            background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
            border-radius: 20px;
            padding: 25px;
            min-height: 150px;
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            justify-content: center;
            align-items: center;
        }

        .achievement-badge {
            background: linear-gradient(135deg, #fbbf24 0%, #f59e0b 100%);
            color: white;
            padding: 12px 20px;
            border-radius: 25px;
            font-weight: 600;
            box-shadow: 0 4px 12px rgba(251, 191, 36, 0.3);
            animation: badgeGlow 2s ease-in-out infinite alternate;
        }

        @keyframes badgeGlow {
            0% {
                box-shadow: 0 4px 12px rgba(251, 191, 36, 0.3);
            }

            100% {
                box-shadow: 0 6px 20px rgba(251, 191, 36, 0.5);
            }
        }

        .no-achievements {
            color: #94a3b8;
            font-style: italic;
            font-size: 1.1em;
        }

        /* Atrium Health Welcome Screen - Clean Medical Design */
        .atrium-welcome-screen {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            width: 100%;
            box-sizing: border-box;
            padding: 40px 20px;
            background: linear-gradient(135deg, #6b9f78 0%, #5a8a67 100%);
            margin: 0;
        }

        .atrium-main-container {
            background: white;
            border-radius: 30px;
            padding: 60px;
            max-width: 1000px;
            width: 100%;
            box-shadow: 0 25px 80px rgba(0, 0, 0, 0.15);
            text-align: center;
            position: relative;
        }

        /* Atrium Health Logo */
        .atrium-logo-container {
            margin-bottom: 30px;
        }

        .atrium-logo-img {
            width: 100px;
            height: 100px;
            border-radius: 50%;
            object-fit: contain;
        }

        /* Main Title */
        .atrium-main-title {
            font-size: 2.8em;
            color: #2c3e50;
            margin-bottom: 20px;
            font-weight: 700;
            letter-spacing: -0.02em;
        }

        /* Content Area with ERNEST and Speech */
        .atrium-content-area {
            display: flex;
            align-items: center;
            gap: 40px;
            margin-bottom: 30px;
            text-align: left;
        }

        /* ERNEST Silhouette Container */
        .ernest-container {
            position: relative;
            flex-shrink: 0;
            text-align: center;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        /* ERNEST Character Image with Floating Animation - 25% Bigger */
        .ernest-character-img {
            width: 250px;
            height: 250px;
            border-radius: 15px;
            object-fit: contain;
            animation: ernestFloat 4s ease-in-out infinite;
            filter: drop-shadow(0 8px 16px rgba(0, 0, 0, 0.1));
        }

        @keyframes ernestFloat {

            0%,
            100% {
                transform: translateY(0px) translateX(0px);
            }

            25% {
                transform: translateY(-8px) translateX(3px);
            }

            50% {
                transform: translateY(-4px) translateX(-3px);
            }

            75% {
                transform: translateY(-12px) translateX(2px);
            }
        }

        .ernest-label {
            background: #6b9f78;
            color: white;
            padding: 12px 26px;
            border-radius: 25px;
            font-weight: bold;
            margin-top: 25px;
            display: inline-block;
            font-size: 18px;
            text-align: center;
            text-align: center;
            box-shadow: 0 4px 12px rgba(107, 159, 120, 0.3);
        }

        /* Speech Bubble - Clean Medical Style */
        .speech-bubble {
            flex: 1;
            background: #f8fafc;
            border: 2px solid #e2e8f0;
            border-radius: 25px;
            padding: 35px;
            position: relative;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.08);
        }

        .speech-bubble::before {
            content: '';
            position: absolute;
            left: -14px;
            top: 50%;
            transform: translateY(-50%);
            width: 0;
            height: 0;
            border-top: 18px solid transparent;
            border-bottom: 18px solid transparent;
            border-right: 18px solid #e2e8f0;
        }

        .speech-bubble::after {
            content: '';
            position: absolute;
            left: -10px;
            top: 50%;
            transform: translateY(-50%);
            width: 0;
            height: 0;
            border-top: 15px solid transparent;
            border-bottom: 15px solid transparent;
            border-right: 15px solid #f8fafc;
        }

        .speech-text {
            font-size: 1.25em;
            line-height: 1.6;
            color: #374151;
            margin: 0;
        }

        /* Call to Action Button */
        .atrium-cta-button {
            background: linear-gradient(135deg, #0d9488 0%, #0f766e 100%);
            color: white;
            border: none;
            padding: 18px 40px;
            font-size: 1.3em;
            font-weight: bold;
            border-radius: 50px;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 10px 25px rgba(13, 148, 136, 0.3);
            text-transform: uppercase;
            letter-spacing: 1px;
            position: relative;
            overflow: hidden;
            margin-top: 20px;
        }

        /* Mobile Optimization for Start Page */
        @media (max-width: 768px) {
            .atrium-content-area {
                flex-direction: column;
                gap: 20px;
                margin-bottom: 30px;
            }

            .ernest-character-img {
                width: 140px;
                /* Much smaller */
                height: 140px;
            }

            .ernest-label {
                padding: 8px 16px;
                font-size: 14px;
                margin-top: 15px;
            }

            .speech-bubble {
                padding: 20px;
            }

            .speech-text {
                font-size: 1rem;
                /* Smaller text */
                line-height: 1.5;
            }

            .speech-bubble::before,
            .speech-bubble::after {
                /* Move arrow to top for column layout */
                left: 50%;
                top: -14px;
                transform: translateX(-50%) rotate(90deg);
            }

            .atrium-cta-button {
                padding: 15px 30px;
                font-size: 1.1em;
                width: 100%;
            }

            /* Mobile Optimization for Modules (Fix "Massive Borders") */
            #modal-overlay>div {
                width: 100% !important;
                height: 100% !important;
                max-height: 100vh !important;
                margin: 0 !important;
                border-radius: 0 !important;
                padding: 10px !important;
                /* Reduce internal padding of the modal container */
            }

            .interactive-content>div {
                padding: 15px !important;
                margin-bottom: 15px !important;
                border-radius: 10px !important;
            }

            .interactive-content h3 {
                font-size: 1.2em !important;
                margin-bottom: 10px !important;
            }

            .interactive-content p,
            .interactive-content li {
                font-size: 0.95em !important;
            }

            /* Adjust iframe container height for mobile */
            .interactive-content iframe {
                height: 500px !important;
            }

            /* Compact Podcast Card on Mobile */
            .podcast-card-hover {
                padding: 15px !important;
                margin-bottom: 15px !important;
            }
        }

        .atrium-cta-button {
            background: #6b9f78;
            color: white;
            border: none;
            padding: 18px 45px;
            font-size: 1.4em;
            font-weight: 600;
            border-radius: 50px;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 6px 20px rgba(107, 159, 120, 0.3);
        }

        .atrium-cta-button:hover {
            transform: translateY(-3px);
            box-shadow: 0 12px 30px rgba(107, 159, 120, 0.4);
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            .atrium-content-area {
                flex-direction: column;
                text-align: center;
                gap: 30px;
            }

            .atrium-main-container {
                padding: 40px 25px;
            }

            .atrium-main-title {
                font-size: 2.2em;
            }

            .ernest-silhouette {
                width: 150px;
                height: 180px;
            }

            .speech-bubble::before,
            .speech-bubble::after {
                display: none;
            }
        }

        /* Clean 13-Module Pathway System */
        .atrium-pathway-container {
            background: #fdfcf8;
            min-height: 100vh;
            padding: 40px 20px;
            animation: pathwaySlideIn 0.8s ease-out;
            display: block !important;
            visibility: visible !important;
            position: relative;
            overflow-x: hidden;
            overflow-y: visible;
        }

        /* Prevent layout shifts during content loading */
        #learning-board {
            min-height: 100vh;
            transition: all 0.3s ease;
        }

        /* Smooth loading state */
        .pathway-loading {
            opacity: 0;
            transform: translateY(20px);
        }

        .pathway-loaded {
            opacity: 1;
            transform: translateY(0);
            transition: opacity 0.5s ease, transform 0.5s ease;
        }

        /* Green Sidebar Bars */
        .atrium-pathway-container::before {
            content: '';
            position: absolute;
            left: 0;
            top: 0;
            bottom: 0;
            width: 8px;
            background: linear-gradient(to bottom, #6b9f78, #5a8a67, #4a6d52);
            border-radius: 0 4px 4px 0;
            box-shadow: 2px 0 8px rgba(107, 159, 120, 0.3);
        }

        .atrium-pathway-container::after {
            content: '';
            position: absolute;
            right: 0;
            top: 0;
            bottom: 0;
            width: 8px;
            background: linear-gradient(to bottom, #6b9f78, #5a8a67, #4a6d52);
            border-radius: 4px 0 0 4px;
            box-shadow: -2px 0 8px rgba(107, 159, 120, 0.3);
        }

        /* Ensure learning board shows when not hidden */
        #learning-board:not(.hidden) {
            display: block !important;
            visibility: visible !important;
        }

        @keyframes pathwaySlideIn {
            from {
                opacity: 0;
                transform: translateY(30px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .pathway-header {
            text-align: center;
            margin-bottom: 50px;
        }

        .pathway-title {
            font-size: 3.8em;
            color: #6b9f78;
            text-align: center;
            margin-bottom: 20px;
            font-weight: 800;
            letter-spacing: -0.03em;
            text-shadow: 0 4px 12px rgba(107, 159, 120, 0.3);
            animation: titleFloat 6s ease-in-out infinite alternate;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 20px;
        }

        @keyframes titleFloat {
            0% {
                transform: translateY(0px) scale(1);
                text-shadow: 0 4px 12px rgba(107, 159, 120, 0.3);
            }

            100% {
                transform: translateY(-8px) scale(1.02);
                text-shadow: 0 8px 20px rgba(107, 159, 120, 0.4);
            }
        }

        .atrium-logo-title {
            width: 120px;
            height: 120px;
            object-fit: contain;
            border-radius: 50%;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            animation: logoTilt 5s ease-in-out infinite alternate;
        }

        @keyframes logoTilt {
            0% {
                transform: rotate(-12deg) scale(1);
            }

            100% {
                transform: rotate(12deg) scale(1.05);
            }
        }

        .pathway-subtitle {
            font-size: 1.2em;
            color: #64748b;
            margin-bottom: 30px;
        }


        /* ========================================= */
        /* NEW GRID LAYOUT SYSTEM */
        /* ========================================= */

        /* Main Container */
        .modules-container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 40px 20px 120px 20px;
            /* Extra bottom padding for ERNEST dialogue */
            position: relative;
            z-index: 1;
        }

        /* Shimmer Background Animation (keep this - looks nice!) */
        .pathway-background-animation {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            pointer-events: none;
            z-index: 0;
            overflow: hidden;
            background: linear-gradient(45deg,
                    rgba(107, 159, 120, 0.03) 0%,
                    rgba(107, 159, 120, 0.08) 25%,
                    rgba(107, 159, 120, 0.03) 50%,
                    rgba(107, 159, 120, 0.08) 75%,
                    rgba(107, 159, 120, 0.03) 100%);
            background-size: 400% 400%;
            animation: shimmer 12s ease-in-out infinite;
        }

        @keyframes shimmer {
            0% {
                background-position: 0% 0%;
            }

            25% {
                background-position: 100% 100%;
            }

            50% {
                background-position: 100% 0%;
            }

            75% {
                background-position: 0% 100%;
            }

            100% {
                background-position: 0% 0%;
            }
        }

        /* Hero Module (EMG Introduction) - Full Width Featured */
        .hero-module {
            background: linear-gradient(135deg, #14b8a6 0%, #0891b2 100%);
            border-radius: 25px;
            padding: 50px;
            margin-bottom: 50px;
            box-shadow: 0 20px 60px rgba(20, 184, 166, 0.3);
            cursor: pointer;
            transition: all 0.4s ease;
            position: relative;
            overflow: hidden;
        }

        .hero-module::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.1) 0%, rgba(255, 255, 255, 0) 100%);
            pointer-events: none;
        }

        .hero-module:hover {
            transform: translateY(-8px);
            box-shadow: 0 25px 70px rgba(20, 184, 166, 0.4);
        }

        .hero-content {
            display: flex;
            align-items: center;
            gap: 40px;
            position: relative;
            z-index: 1;
        }

        .hero-icon {
            width: 200px;
            height: 200px;
            object-fit: contain;
            filter: drop-shadow(0 10px 30px rgba(0, 0, 0, 0.3));
        }

        .hero-text {
            flex: 1;
            color: white;
        }

        .hero-badge {
            display: inline-block;
            background: rgba(255, 255, 255, 0.2);
            padding: 8px 20px;
            border-radius: 20px;
            font-size: 0.9em;
            font-weight: 600;
            margin-bottom: 15px;
            backdrop-filter: blur(10px);
        }

        .hero-title {
            font-size: 2.5em;
            font-weight: 800;
            margin: 0 0 15px 0;
            text-shadow: 0 2px 20px rgba(0, 0, 0, 0.2);
        }

        .hero-description {
            font-size: 1.2em;
            opacity: 0.95;
            line-height: 1.6;
        }

        /* Grid Container for Modules 2-13 (12 icons in 4 columns = 3 perfect rows) */
        .modules-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 55px;
            margin-bottom: 50px;
            animation: fadeInUp 0.6s ease-out;
            justify-items: center;
            padding: 10px;
            max-width: 1600px;
            margin-left: auto;
            margin-right: auto;
        }

        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Individual Module Card */
        .module-card {
            background: white;
            border-radius: 20px;
            padding: 16px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.06);
            cursor: pointer;
            transition: transform 0.4s cubic-bezier(0.68, -0.55, 0.265, 1.55),
                box-shadow 0.4s ease,
                border-color 0.4s ease;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-align: center;
            position: relative;
            border: 5px solid #6b9f78;
            min-height: 200px;
            width: 100%;
            max-width: 240px;
        }

        .module-card:hover {
            transform: scale(1.15);
            z-index: 100;
            box-shadow: 0 25px 80px rgba(107, 159, 120, 0.5),
                0 0 30px rgba(107, 159, 120, 0.6);
            border-color: #14b8a6;
            animation: bounce-glow 0.6s ease-in-out;
        }

        @keyframes bounce-glow {

            0%,
            100% {
                box-shadow: 0 25px 80px rgba(107, 159, 120, 0.5),
                    0 0 30px rgba(107, 159, 120, 0.6);
            }

            50% {
                box-shadow: 0 25px 80px rgba(20, 184, 166, 0.7),
                    0 0 50px rgba(20, 184, 166, 0.9);
            }
        }

        .module-icon {
            width: 150px;
            height: 150px;
            object-fit: contain;
            margin: 0;
            transition: all 0.3s ease;
        }

        .module-card:hover .module-icon {
            filter: brightness(1.15) contrast(1.1);
        }

        /* Footer Module (Clinical Application) - Full Width Conclusion */
        .footer-module {
            background: linear-gradient(135deg, #6b9f78 0%, #5a8a67 100%);
            border-radius: 25px;
            padding: 50px;
            box-shadow: 0 20px 60px rgba(107, 159, 120, 0.3);
            cursor: pointer;
            transition: all 0.4s ease;
            position: relative;
            overflow: hidden;
        }

        .footer-module::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.1) 0%, rgba(255, 255, 255, 0) 100%);
            pointer-events: none;
        }

        .footer-module:hover {
            transform: translateY(-8px);
            box-shadow: 0 25px 70px rgba(107, 159, 120, 0.4);
        }

        /* Responsive Grid - 12 items divides perfectly into 4, 3, 2, or 1 columns */
        @media (max-width: 1200px) {
            .modules-grid {
                grid-template-columns: repeat(3, 1fr);
                gap: 35px;
            }
        }

        @media (max-width: 900px) {
            .modules-grid {
                grid-template-columns: repeat(2, 1fr);
                gap: 40px;
            }

            .hero-content {
                flex-direction: column;
                text-align: center;
            }

            .module-card {
                max-width: 280px;
            }
        }

        @media (max-width: 600px) {
            .modules-grid {
                grid-template-columns: repeat(2, 110px) !important;
                gap: 18px !important;
                justify-content: center !important;
                padding: 0 !important;
            }

            .hero-module {
                padding: 8px !important;
                margin-bottom: 10px !important;
            }

            .hero-content {
                gap: 8px !important;
            }

            .hero-icon {
                width: 23px !important;
                height: 23px !important;
            }

            .hero-title {
                font-size: 0.9em !important;
                margin: 4px 0 !important;
            }

            .hero-description {
                display: none !important;
            }

            .hero-badge {
                font-size: 0.6em !important;
                padding: 3px 8px !important;
            }

            .module-card {
                max-width: 100% !important;
                padding: 6px !important;
                border-width: 3px !important;
                min-height: 100px !important;
            }

            .module-icon {
                width: 90px !important;
                height: 90px !important;
            }
        }

        /* Old pathway styles removed - using new grid system */

        /* Dynamic Module Description System - Simplified */
        .module-description-panel {
            position: fixed !important;
            background: rgba(255, 255, 255, 0.95) !important;
            backdrop-filter: blur(15px) !important;
            border: 2px solid rgba(107, 159, 120, 0.8) !important;
            border-radius: 20px !important;
            padding: 30px !important;
            width: 400px !important;
            height: 250px !important;
            z-index: 9999 !important;
            opacity: 0 !important;
            transition: all 0.3s ease-out !important;
            pointer-events: none !important;
            box-shadow: 0 20px 50px rgba(0, 0, 0, 0.15) !important;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif !important;
            display: block !important;
            overflow-y: auto !important;
        }

        .module-description-panel.show {
            opacity: 1 !important;
            pointer-events: auto !important;
        }

        /* Smart positioning - right side for left modules, left side for right modules */
        .module-description-panel.position-right {
            left: calc(50% + 200px) !important;
        }

        .module-description-panel.position-left {
            left: calc(50% - 600px) !important;
        }

        /* Ernest avatar and content styling for readability */
        .description-ernest-avatar {
            width: 40px !important;
            height: 40px !important;
            border-radius: 50% !important;
            margin-bottom: 15px !important;
            margin-right: 15px !important;
        }

        .description-title {
            font-size: 16px !important;
            font-weight: 700 !important;
            color: #2563eb !important;
            margin-bottom: 12px !important;
            line-height: 1.3 !important;
        }

        .description-text {
            font-size: 14px !important;
            color: #4b5563 !important;
            line-height: 1.5 !important;
            margin-bottom: 12px !important;
        }

        .description-highlights {
            font-size: 12px !important;
            color: #059669 !important;
            font-weight: 600 !important;
            line-height: 1.4 !important;
            margin-top: 10px !important;
        }

        .description-ernest {
            display: flex;
            align-items: flex-start;
            gap: 15px;
            margin-bottom: 15px;
        }

        .description-ernest-avatar {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            object-fit: cover;
            border: 2px solid #6b9f78;
            flex-shrink: 0;
            animation: ernestPulse 3s ease-in-out infinite;
        }

        @keyframes ernestPulse {

            0%,
            100% {
                transform: scale(1);
            }

            50% {
                transform: scale(1.05);
            }
        }





        .description-content {
            flex: 1;
        }

        .description-title {
            font-size: 1.3em;
            font-weight: 700;
            color: #6b9f78;
            margin-bottom: 8px;
            line-height: 1.2;
        }

        .description-text {
            font-size: 1em;
            line-height: 1.6;
            color: #2c3e50;
            margin-bottom: 12px;
        }

        .description-highlights {
            font-size: 0.9em;
            color: #64748b;
            font-style: italic;
        }

        /* ========================================= */
        /* ERNEST RPG-STYLE DIALOGUE BOX */
        /* ========================================= */

        .ernest-dialogue-box {
            position: fixed !important;
            bottom: 0 !important;
            left: 0 !important;
            right: 0 !important;
            background: linear-gradient(to top, rgba(255, 255, 255, 0.98), rgba(255, 255, 255, 0.95));
            backdrop-filter: blur(20px);
            border-top: 4px solid #6b9f78;
            padding: 25px 40px;
            z-index: 99999 !important;
            transform: translateY(100%);
            transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 -10px 40px rgba(0, 0, 0, 0.15);
            margin: 0 !important;
        }

        .ernest-dialogue-box.show {
            transform: translateY(0);
        }

        .ernest-dialogue-content {
            max-width: 1400px;
            margin: 0 auto;
            display: flex;
            align-items: center;
            gap: 25px;
        }

        .ernest-avatar {
            width: 120px;
            height: 120px;
            border-radius: 15px;
            border: 3px solid #6b9f78;
            box-shadow: 0 5px 20px rgba(107, 159, 120, 0.3);
            flex-shrink: 0;
            object-fit: contain;
            background: white;
            padding: 5px;
        }

        .ernest-text {
            flex: 1;
        }

        .ernest-name {
            font-size: 1em;
            font-weight: 700;
            color: #6b9f78;
            margin: 0 0 8px 0;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .ernest-message {
            font-size: 1.1em;
            line-height: 1.6;
            color: #2c3e50;
            margin: 0;
        }

        .ernest-highlights {
            font-size: 0.95em;
            color: #64748b;
            font-style: italic;
            margin-top: 8px;
        }

        /* Speech bubble effect */
        .module-description-panel::before {
            content: '';
            position: absolute;
            width: 0;
            height: 0;
            top: 50%;
        }

        .module-description-panel.position-right::before {
            left: -10px;
            transform: translateY(-50%);
            border-right: 10px solid rgba(255, 255, 255, 0.96);
            border-top: 10px solid transparent;
            border-bottom: 10px solid transparent;
        }

        .module-description-panel.position-left::before {
            right: -10px;
            transform: translateY(-50%);
            border-left: 10px solid rgba(255, 255, 255, 0.96);
            border-top: 10px solid transparent;
            border-bottom: 10px solid transparent;
        }

        /* Responsive Design for Description Panels */
        @media (max-width: 1400px) {
            .module-description-panel.position-right {
                left: calc(50% + 150px);
            }

            .module-description-panel.position-left {
                right: calc(50% + 150px);
            }

            .module-description-panel {
                width: 280px;
                max-width: 280px;
            }
        }

        @media (max-width: 1200px) {
            .module-description-panel.position-right {
                left: calc(50% + 100px);
            }

            .module-description-panel.position-left {
                right: calc(50% + 100px);
            }

            .module-description-panel {
                width: 250px;
                max-width: 250px;
                padding: 20px;
            }

            .description-title {
                font-size: 1.1em;
            }

            .description-text {
                font-size: 0.9em;
            }
        }

        @media (max-width: 768px) {
            .module-description-panel {
                position: fixed !important;
                bottom: 80px !important;
                left: 50% !important;
                right: auto !important;
                transform: translateX(-50%) !important;
                width: 90% !important;
                max-width: 350px !important;
                top: auto !important;
            }

            .module-description-panel.show {
                transform: translateX(-50%) scale(1) !important;
            }

            .module-description-panel::before {
                display: none;
            }
        }

        /* Learning Objectives Button */
        .learning-objectives-btn {
            padding: 12px 24px;
            background: linear-gradient(135deg, #6b9f78, #4a6d52);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            margin: 15px 0 10px 0;
            transition: all 0.3s ease;
            box-shadow: 0 2px 8px rgba(107, 159, 120, 0.3);
        }

        .learning-objectives-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(107, 159, 120, 0.4);
            background: linear-gradient(135deg, #7ab088, #557d5e);
        }

        /* Learning Objectives Modal */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            z-index: 10000;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        .modal-content {
            background: white;
            border-radius: 16px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
            position: relative;
            width: 90%;
            max-width: 1200px;
        }

        .modal-header {
            padding: 20px 25px;
            border-bottom: 2px solid #e5e7eb;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-title {
            font-size: 24px;
            font-weight: 700;
            color: #1f2937;
            margin: 0;
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 32px;
            color: #6b7280;
            cursor: pointer;
            padding: 0;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 4px;
            transition: all 0.2s;
        }

        .modal-close:hover {
            background: #f3f4f6;
            color: #1f2937;
        }

        .modal-body {
            padding: 25px;
            max-height: calc(90vh - 100px);
            overflow-y: auto;
        }

        .learning-objectives-content {
            max-width: 1200px;
            max-height: 90vh;
            overflow-y: auto;
        }

        /* PGY-2 Section (Prominent) */
        .pgy2-section {
            background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%);
            border: 2px solid #3b82f6;
            border-radius: 12px;
            padding: 25px;
            margin-bottom: 30px;
        }

        .pgy2-header {
            color: #1e40af;
            font-size: 24px;
            margin-bottom: 5px;
        }

        /* Three Column Grid */
        .objectives-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 20px;
            margin-top: 20px;
        }

        @media (max-width: 992px) {
            .objectives-grid {
                grid-template-columns: 1fr;
            }
        }

        /* Section Styling */
        .objectives-section {
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        .pgy3-section {
            background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
            border: 2px solid #f59e0b;
        }

        .pgy3-header {
            color: #92400e;
        }

        .pgy4-section {
            background: linear-gradient(135deg, #fce7f3 0%, #fbcfe8 100%);
            border: 2px solid #ec4899;
        }

        .pgy4-header {
            color: #831843;
        }

        .advanced-section {
            background: linear-gradient(135deg, #f3e8ff 0%, #e9d5ff 100%);
            border: 2px solid #a855f7;
        }

        .advanced-header {
            color: #6b21a8;
        }

        .objectives-header {
            font-size: 18px;
            font-weight: 700;
            margin-bottom: 5px;
        }

        .objectives-subtitle {
            font-size: 13px;
            color: #6b7280;
            margin-bottom: 15px;
            font-style: italic;
        }

        /* Competency Groups */
        .competency-group {
            margin-bottom: 20px;
        }

        .competency-group h4 {
            font-size: 16px;
            font-weight: 600;
            color: #374151;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .competency-group ul {
            margin: 0;
            padding-left: 20px;
        }

        .competency-group li {
            margin-bottom: 6px;
            line-height: 1.5;
            color: #4b5563;
        }

        /* Compact Groups for 3-column layout */
        .competency-group-compact {
            margin-bottom: 15px;
        }

        .competency-group-compact h4 {
            font-size: 14px;
            font-weight: 600;
            color: #374151;
            margin-bottom: 6px;
        }

        .competency-group-compact ul {
            margin: 0;
            padding-left: 18px;
        }

        .competency-group-compact li {
            margin-bottom: 4px;
            font-size: 13px;
            line-height: 1.4;
            color: #4b5563;
        }
    </style>

    <!-- Critical functions that need to be available immediately -->
    <script>
        // Define startAtriumJourney early so onclick handlers can use it
        window.startAtriumJourney = function () {
            console.log('üè• Starting Atrium Health Journey');

            // Wait for DOM and all scripts to be ready
            function executeStart() {
                // Smooth fade out welcome screen
                const welcomeScreen = document.getElementById('pgy-selection');
                if (welcomeScreen) {
                    welcomeScreen.style.transition = 'opacity 0.8s ease, transform 0.8s ease';
                    welcomeScreen.style.opacity = '0';
                    welcomeScreen.style.transform = 'translateY(-20px)';

                    // Start the 13-module PGY-2 journey after transition
                    setTimeout(() => {
                        // Retry logic: wait for startJourney to be available
                        let retryCount = 0;
                        const maxRetries = 50; // 5 seconds max

                        const tryStart = setInterval(() => {
                            if (typeof startJourney === 'function') {
                                clearInterval(tryStart);
                                startJourney('pgy2');
                            } else {
                                retryCount++;
                                if (retryCount >= maxRetries) {
                                    clearInterval(tryStart);
                                    console.error('‚ùå startJourney function failed to load after 5 seconds');
                                    alert('Error loading journey system. Please refresh the page.');
                                }
                            }
                        }, 100);
                    }, 800);
                }
            }

            // Wait for DOM if still loading
            if (document.readyState === 'loading') {
                document.addEventListener('DOMContentLoaded', executeStart);
            } else {
                executeStart();
            }
        };
    </script>
</head>

<body>
    <!-- Atrium Health Welcome Screen -->
    <div id="pgy-selection" class="atrium-welcome-screen">
        <div class="atrium-main-container">
            <!-- Atrium Health Logo -->
            <div class="atrium-logo-container">
                <img src="atrium.jpeg" alt="Atrium Health" class="atrium-logo-img">
            </div>

            <!-- Main Title -->
            <h1 class="atrium-main-title">Atrium Health EMG/NCS Learning System</h1>

            <!-- Version Marker -->
            <div style="text-align: center; margin-top: 15px; margin-bottom: 10px;">
                <div
                    style="background: linear-gradient(135deg, #f59e0b, #ea580c); color: white; padding: 8px 16px; border-radius: 20px; display: inline-block; font-size: 0.85rem; font-weight: 600; box-shadow: 0 2px 8px rgba(245, 158, 11, 0.3);">
                    ü¶∂ Sural Nerve Added & Pathway Images! (v2025.12.09 13:15)
                </div>
            </div>

            <!-- Content Area with ERNEST and Speech Bubble -->
            <div class="atrium-content-area">
                <!-- ERNEST Character -->
                <div class="ernest-container">
                    <img src="ERNEST.png" alt="ERNEST EMG Device" class="ernest-character-img">
                    <div class="ernest-label">ERNEST</div>
                </div>

                <!-- Speech Bubble -->
                <div class="speech-bubble">
                    <p class="lead-text"
                        style="font-size: 1.25em; color: #475569; margin-bottom: 30px; line-height: 1.6;">
                        Join Ernest on an interactive adventure through the peripheral nervous system.
                        Master complex anatomy, conquer clinical patterns, and build the skills that will
                        help you become a confident electrodiagnostician. Ready to begin your journey?
                    </p>
                </div>
            </div>

            <!-- Call to Action Button -->
            <button class="atrium-cta-button" onclick="startAtriumJourney()">
                Begin Journey
            </button>
        </div>
    </div>

    <!-- Progress Dashboard -->
    <div id="progress-dashboard" class="progress-dashboard hidden">
        <div class="dashboard-header">
            <h3>üìä Learning Progress Dashboard</h3>
            <div class="dashboard-stats">
                <div class="stat-card">
                    <div class="stat-number" id="completed-modules">0</div>
                    <div class="stat-label">Modules Completed</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="current-level">PGY-</div>
                    <div class="stat-label">Current Level</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="competency-score">0%</div>
                    <div class="stat-label">Competency Progress</div>
                </div>
            </div>
        </div>
        <div class="achievement-showcase" id="achievements-display">
            <!-- Achievement badges will be displayed here -->
        </div>
    </div>

    <!-- Enhanced Journey Learning Board -->
    <div id="learning-board" class="enhanced-journey-board hidden">
        <!-- Journey content will be dynamically generated here -->
    </div>

    <!-- Navigation Controls -->


    <!-- Load Enhanced Journey Systems -->
    <script src="js/enhanced-journey-candyland.js"></script>
    <script src="js/brachial-plexus-modal.js"></script>
    <!-- <script src="js/main.js"></script> TEMPORARILY DISABLED DUE TO SYNTAX ERROR -->
    <script src="js/emg-challenge-fix.js"></script>
    <!-- OLD CLINICAL CASES SYSTEM REMOVED - REPLACED BY EMG APP COMPLETE SYSTEM -->
    <!-- <script src="js/clinical-cases-system.js"></script> -->
    <!-- Load EMG APP Complete System with all clinical cases -->
    <script src="js/emg-app-complete-system.js"></script>
    <script src="js/enhanced-journey-modal-content.js?v=img_sanitize_final"></script>
    <!-- <script src="js/enhanced-journey-modal-content.js?v=20251002-larger-text"></script> -->

    <!-- Module Loading System (Phase 2: Dynamic Module Loading Active) -->
    <script type="module" src="js/modules/core.js"></script>
    <script type="module" src="js/module-loader.js"></script>

    <!-- Shared Quiz Utility Functions (used by multiple modules) -->
    <script>
        // Generate interactive quiz from questions array
        function generateModuleQuiz(questions) {
            if (!questions || questions.length === 0) return '';

            const quizHTML = questions.map((q, index) => `
                <div class="quiz-question-card" style="background: white; padding: 25px; border-radius: 12px; border: 2px solid #e5e7eb; display: ${index === 0 ? 'block' : 'none'};" data-question="${index}">
                    <p style="font-size: 1.1em; font-weight: 600; margin-bottom: 20px; color: #1f2937;">
                        <span style="background: #0d9488; color: white; padding: 4px 10px; border-radius: 6px; margin-right: 10px; font-size: 0.9em;">Question ${index + 1} of ${questions.length}</span>
                        ${q.question}
                    </p>
                    <div class="quiz-options" style="display: grid; gap: 10px;">
                        ${q.options.map((option, optIndex) => `
                            <button class="quiz-option"
                                    onclick="checkQuizAnswer(this, ${optIndex === q.correct}, '${q.explanation.replace(/'/g, "\\'")}', ${index}, ${questions.length})"
                                    style="padding: 15px 20px; background: #f8fafc; border: 2px solid #e2e8f0; border-radius: 8px; cursor: pointer; text-align: left; font-size: 1em; transition: all 0.3s; min-height: 48px;"
                                    onmouseover="this.style.background='#f1f5f9'; this.style.borderColor='#cbd5e1';"
                                    onmouseout="if(!this.classList.contains('correct') && !this.classList.contains('incorrect')) { this.style.background='#f8fafc'; this.style.borderColor='#e2e8f0'; }">
                                ${option}
                            </button>
                        `).join('')}
                    </div>
                    <div class="quiz-feedback" style="margin-top: 15px; padding: 15px; border-radius: 8px; display: none;"></div>
                    <button class="quiz-next-btn" style="margin-top: 20px; padding: 12px 24px; background: #0d9488; color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 1em; display: none; transition: all 0.3s;"
                            onclick="nextQuizQuestion(${index}, ${questions.length})"
                            onmouseover="this.style.background='#0f766e';"
                            onmouseout="this.style.background='#0d9488';">
                        ${index === questions.length - 1 ? 'View Results' : 'Next Question ‚Üí'}
                    </button>
                </div>
            `).join('');

            return `
                <div class="module-quiz-section" style="margin-top: 40px; padding-top: 30px; border-top: 3px solid #e5e7eb;">
                    <div style="background: linear-gradient(135deg, #0d9488, #0f766e); padding: 25px; border-radius: 15px; margin-bottom: 25px; text-align: center;">
                        <h3 style="color: white; margin-bottom: 10px; font-size: 1.8em;">üìù Test Your Knowledge</h3>
                        <p style="color: rgba(255,255,255,0.9); margin: 0; font-size: 1.1em;">Answer ${questions.length} questions to reinforce your learning</p>
                    </div>
                    <div class="quiz-score-tracker" style="background: #f0fdfa; padding: 15px 20px; border-radius: 10px; margin-bottom: 25px; text-align: center; border: 2px solid #99f6e4;">
                        <span style="font-size: 1.2em; font-weight: 600; color: #134e4a;">Score: <span id="quiz-score">0</span>/${questions.length}</span>
                    </div>
                    <div class="quiz-container">
                        ${quizHTML}
                    </div>
                    <div id="quiz-complete" style="display: none; background: #ccfbf1; padding: 25px; border-radius: 12px; border: 2px solid #5eead4; text-align: center;">
                        <h3 style="color: #115e59; margin-bottom: 15px;">üéâ Quiz Complete!</h3>
                        <p style="color: #134e4a; font-size: 1.2em; margin: 0;">You scored <span id="final-score"></span> out of ${questions.length}</p>
                    </div>
                </div>
            `;
        }

        window.checkQuizAnswer = function (button, isCorrect, explanation, questionIndex, totalQuestions) {
            const questionCard = button.closest('.quiz-question-card');
            const allButtons = questionCard.querySelectorAll('.quiz-option');
            const feedbackDiv = questionCard.querySelector('.quiz-feedback');
            const nextBtn = questionCard.querySelector('.quiz-next-btn');

            allButtons.forEach(btn => {
                btn.disabled = true;
                btn.style.cursor = 'not-allowed';
                btn.style.opacity = '0.6';
            });

            if (isCorrect) {
                button.style.background = 'linear-gradient(135deg, #10b981, #059669)';
                button.style.borderColor = '#059669';
                button.style.color = 'white';
                button.style.fontWeight = '600';
                button.style.opacity = '1';
                button.classList.add('correct');

                const scoreEl = document.getElementById('quiz-score');
                if (scoreEl) {
                    scoreEl.textContent = parseInt(scoreEl.textContent) + 1;
                }

                feedbackDiv.style.display = 'block';
                feedbackDiv.style.background = '#d1fae5';
                feedbackDiv.style.borderLeft = '4px solid #10b981';
                feedbackDiv.innerHTML = `
                    <p style="margin: 0; color: #065f46; font-weight: 600; margin-bottom: 8px;">‚úÖ Correct!</p>
                    <p style="margin: 0; color: #047857; line-height: 1.6;">${explanation}</p>
                `;
            } else {
                button.style.background = 'linear-gradient(135deg, #ef4444, #dc2626)';
                button.style.borderColor = '#dc2626';
                button.style.color = 'white';
                button.style.fontWeight = '600';
                button.style.opacity = '1';
                button.classList.add('incorrect');

                allButtons.forEach((btn) => {
                    if (btn !== button && !btn.classList.contains('incorrect')) {
                        const isThisCorrect = btn.onclick.toString().includes('true');
                        if (isThisCorrect) {
                            btn.style.background = '#d1fae5';
                            btn.style.borderColor = '#10b981';
                            btn.style.color = '#065f46';
                            btn.style.fontWeight = '600';
                            btn.style.opacity = '1';
                        }
                    }
                });

                feedbackDiv.style.display = 'block';
                feedbackDiv.style.background = '#fee2e2';
                feedbackDiv.style.borderLeft = '4px solid #ef4444';
                feedbackDiv.innerHTML = `
                    <p style="margin: 0; color: #991b1b; font-weight: 600; margin-bottom: 8px;">‚ùå Incorrect</p>
                    <p style="margin: 0; color: #b91c1c; line-height: 1.6;">${explanation}</p>
                `;
            }

            if (nextBtn) {
                nextBtn.style.display = 'block';
            }

            feedbackDiv.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
        };

        window.nextQuizQuestion = function (currentIndex, totalQuestions) {
            const currentCard = document.querySelector(`.quiz-question-card[data-question="${currentIndex}"]`);
            if (currentCard) {
                currentCard.style.display = 'none';
            }

            if (currentIndex === totalQuestions - 1) {
                const completeDiv = document.getElementById('quiz-complete');
                const finalScoreSpan = document.getElementById('final-score');
                const currentScore = document.getElementById('quiz-score').textContent;

                if (completeDiv && finalScoreSpan) {
                    finalScoreSpan.textContent = currentScore;
                    completeDiv.style.display = 'block';
                    completeDiv.scrollIntoView({ behavior: 'smooth', block: 'center' });
                }
            } else {
                const nextCard = document.querySelector(`.quiz-question-card[data-question="${currentIndex + 1}"]`);
                if (nextCard) {
                    nextCard.style.display = 'block';
                    nextCard.scrollIntoView({ behavior: 'smooth', block: 'center' });
                }
            }
        };

        window.generateModuleQuiz = generateModuleQuiz;
    </script>

    <!-- Additional Support Functions for Modules -->
    <script>
        // Get muscle image path helper - Global utility function
        function getMuscleImagePath(muscleKey) {
            const imageMap = {
                'APB': 'EMG IMAGES/Abductor Pollicus Brevis.png',
                'Bicep': 'EMG IMAGES/Biceps.png',
                'EIP': 'EMG IMAGES/Extensor Indicus.png',
                'FDI': 'EMG IMAGES/First Dorsal Interosseous.png',
                'Middle Deltoid': 'EMG IMAGES/Deltoid.png',
                'PT': 'EMG IMAGES/Pronator teres.png',
                'Tricep': 'EMG IMAGES/Triceps.png',
                'Extensor Hallucis': 'EMG IMAGES/Extensor Hallucis longus.png',
                'Medial Gastroc': 'EMG IMAGES/Medial Gastroc.png',
                'Peroneus Longus': 'EMG IMAGES/Fibularis longus.png',
                'Tibialis Ant': 'EMG IMAGES/Tibialis Anterior.png',
                'Tibialis Post': 'EMG IMAGES/Tibialis Posterior.png',
                'Vastus Lateralis': 'EMG IMAGES/Vastus Lateralis.png'
            };
            return imageMap[muscleKey] || null;
        }
        window.getMuscleImagePath = getMuscleImagePath;
    </script>

    <!-- Module 8: EMG Needle Localization System -->


    <!-- Module 9: Muscle Study System (Study Cards + EMG Challenge) -->
    <script src="js/muscle-study-system.js"></script>

    <!-- Module 11: Neuropathy vs Myopathy Basics System -->


    <!-- Module 5: Neuropathy Pathophysiology Support Functions -->
    <script src="js/neuropathy-pathophysiology-support.js"></script>

    <!-- Module 7: NCS Techniques Support Functions -->
    <script src="js/ncs-techniques-support.js?v=img_sanitize_final"></script>

    <script>
        // Comprehensive iOS crash tracking
        // Check if isIOS already exists to prevent duplicate declaration
        if (typeof isIOS === 'undefined') {
            window.isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent);
        }

        if (window.isIOS) {
            console.warn('üì± iOS DETECTED - Enhanced crash tracking enabled');

            // Track memory if available
            if (performance.memory) {
                setInterval(() => {
                    const mem = performance.memory;
                    const usedMB = (mem.usedJSHeapSize / 1048576).toFixed(2);
                    const totalMB = (mem.totalJSHeapSize / 1048576).toFixed(2);
                    const limitMB = (mem.jsHeapSizeLimit / 1048576).toFixed(2);
                    const percentUsed = ((mem.usedJSHeapSize / mem.jsHeapSizeLimit) * 100).toFixed(1);

                    console.log(`üíæ Memory: ${usedMB}MB / ${limitMB}MB (${percentUsed}%)`);

                    if (percentUsed > 90) {
                        console.error('üö® MEMORY CRITICAL: ' + percentUsed + '%');
                    }
                }, 2000);
            }

            // Track zoom level changes
            let lastZoom = window.visualViewport ? window.visualViewport.scale : 1;
            if (window.visualViewport) {
                window.visualViewport.addEventListener('resize', () => {
                    const currentZoom = window.visualViewport.scale;
                    if (currentZoom !== lastZoom) {
                        console.warn('üîç ZOOM CHANGED:', {
                            from: lastZoom.toFixed(2),
                            to: currentZoom.toFixed(2),
                            width: window.visualViewport.width,
                            height: window.visualViewport.height
                        });
                        lastZoom = currentZoom;
                    }
                });
            }

            // Track visible content size
            const trackVisibleContent = () => {
                const modalBody = document.getElementById('modal-body');
                if (modalBody) {
                    const rect = modalBody.getBoundingClientRect();
                    const contentSize = modalBody.innerHTML.length;
                    console.log('üìè Visible modal:', {
                        width: rect.width.toFixed(0),
                        height: rect.height.toFixed(0),
                        contentBytes: contentSize,
                        scrollHeight: modalBody.scrollHeight
                    });
                }
            };

            // Track every 5 seconds
            setInterval(trackVisibleContent, 5000);
        }

        // Minimal crash tracking
        window.addEventListener('beforeunload', function (e) {
            console.error('‚ö†Ô∏è PAGE UNLOAD - Something triggered navigation away from page');
        });

        window.addEventListener('pagehide', function (e) {
            console.error('‚ö†Ô∏è PAGE HIDE - Page is being hidden/closed');
        });

        // Note: window.startAtriumJourney is now defined in the <head> section for immediate availability

        // Local Storage Functions
        function saveProgressToStorage() {
            const progressData = {
                currentPGYLevel: window.currentPGYLevel,
                completedModules: Array.from(window.completedModules),
                currentModuleIndex: window.currentModuleIndex,
                lastUpdated: new Date().toISOString()
            };
            localStorage.setItem('ernestEMGProgress', JSON.stringify(progressData));
        }

        function loadProgressFromStorage() {
            const saved = localStorage.getItem('ernestEMGProgress');
            if (saved) {
                try {
                    const progressData = JSON.parse(saved);
                    window.currentPGYLevel = progressData.currentPGYLevel;
                    window.completedModules = new Set(progressData.completedModules || []);
                    window.currentModuleIndex = progressData.currentModuleIndex || 0;
                    console.log('‚úÖ Progress loaded from storage');
                    return true;
                } catch (error) {
                    console.log('‚ö†Ô∏è Error loading progress:', error);
                    return false;
                }
            }
            return false;
        }


        // Enhanced journey interface with modal integration
        function startJourney(pgyLevel) {
            console.log(`üöÄ Starting ${pgyLevel.toUpperCase()} Enhanced Learning Journey`);

            // Try to load existing progress first
            const progressLoaded = loadProgressFromStorage();

            // Set global variables (use saved progress if available)
            if (!progressLoaded || window.currentPGYLevel !== pgyLevel) {
                window.currentPGYLevel = pgyLevel;
                window.currentModuleIndex = 0;
                window.completedModules = new Set();
                saveProgressToStorage();
            }

            // Show learning board
            document.getElementById('pgy-selection').classList.add('hidden');
            document.getElementById('learning-board').classList.remove('hidden');
            // document.getElementById('journey-controls').classList.remove('hidden'); // REMOVED - Legacy footer

            // Generate the enhanced journey board
            if (typeof generateLearningBoard === 'function') {
                generateLearningBoard(pgyLevel);
            } else {
                console.error('‚ùå generateLearningBoard function not found, waiting for scripts to load...');
                setTimeout(() => {
                    if (typeof generateLearningBoard === 'function') {
                        generateLearningBoard(pgyLevel);
                    } else {
                        console.error('‚ùå generateLearningBoard function still not available after timeout');
                    }
                }, 500);
            }

            // Don't auto-open modal - let user click to start
            console.log('üìö Journey ready - click any module to begin learning!');

            // Smooth scroll to top
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }



        // Enhanced startLearningModule function that uses our new modal system
        function startLearningModule(moduleIndex) {
            console.log('üîç DEBUG: startLearningModule called with index:', moduleIndex);

            // Prevent duplicate calls
            if (window.isModalOpen) {
                console.log('‚ö†Ô∏è DEBUG: Modal already open, ignoring duplicate call');
                return;
            }

            if (typeof window.currentPGYLevel === 'undefined' || typeof learningModulesConfig === 'undefined') {
                console.error('‚ùå Journey system not properly initialized');
                return;
            }

            const modules = learningModulesConfig[window.currentPGYLevel];
            const module = modules[moduleIndex];

            if (!module) {
                console.error('‚ùå Module not found:', moduleIndex);
                return;
            }

            console.log(`üéì Starting learning module: ${module.title}`);

            // Set flag to prevent duplicate opens
            window.isModalOpen = true;

            // Close ERNEST dialogue first
            if (typeof closeErnestDialogue === 'function') {
                closeErnestDialogue();
            }

            // Animate the selected square
            if (typeof animateSquareSelection === 'function') {
                animateSquareSelection(moduleIndex);
            }

            // Show enhanced learning modal after brief animation
            setTimeout(() => {
                showEnhancedLearningModal(module, moduleIndex);
            }, 300);
        }

        // Enhanced modal function with our new system integration
        function showEnhancedLearningModal(module, moduleIndex) {
            const terrain = getTerrainTheme(moduleIndex, learningModulesConfig[window.currentPGYLevel].length);

            // Create beautiful modal HTML using our new system
            const modalHTML = `
                <div class="learning-modal-overlay" id="enhanced-modal-${moduleIndex}">
                    <div class="learning-modal" data-terrain="${terrain.theme}">
                        <!-- Journey Context Bar -->
                        <div class="journey-context-bar">
                            <div class="journey-breadcrumb">
                                <span>${terrain.decoration} ${terrain.theme}</span>
                                <span class="breadcrumb-separator">‚Üí</span>
                                <span>Module ${moduleIndex + 1} of ${learningModulesConfig[window.currentPGYLevel].length}</span>
                                <span class="breadcrumb-separator">‚Üí</span>
                                <span>PGY-${window.currentPGYLevel.charAt(3)}</span>
                            </div>
                            <button class="modal-close-btn" onclick="closeEnhancedModal(${moduleIndex})">Return to Journey</button>
                        </div>

                        <!-- Learning Content Area -->
                        <div class="learning-content-area" id="enhanced-content-${moduleIndex}">
                            <div class="content-header">
                                <div class="content-icon">${module.icon}</div>
                                <h2 class="content-title">${module.title}</h2>
                                <div class="content-competency">${module.competency}</div>
                                <p class="content-description">${module.description}</p>
                            </div>

                            <div class="content-loading">
                                <div class="loading-spinner"></div>
                                <p>Loading interactive learning content...</p>
                            </div>
                        </div>

                        <!-- ERNEST Helper -->
                        <div class="modal-ernest-guide" onclick="showModalErnestHelp(${moduleIndex})">
                            <div class="ernest-face">ü§ñ</div>
                        </div>

                        <!-- Module Completion Footer -->
                        <div style="padding: 20px; border-top: 1px solid rgba(107, 159, 120, 0.2); background: #f8fafc;">
                            <div style="text-align: center;">
                                <button id="complete-enhanced-btn-${moduleIndex}"
                                        onclick="completeEnhancedModule(${moduleIndex})"
                                        style="background: #6b9f78; color: white; border: none; padding: 12px 30px; border-radius: 10px; font-weight: 600; cursor: pointer; opacity: 0.5; transition: all 0.3s ease;"
                                        disabled>
                                    Complete Module & Continue Journey
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;

            // Add modal to page
            document.body.insertAdjacentHTML('beforeend', modalHTML);
            const overlay = document.getElementById(`enhanced-modal-${moduleIndex}`);

            // Animate modal appearance
            requestAnimationFrame(() => {
                overlay.classList.add('active');
            });

            // Load content using our enhanced system
            setTimeout(() => {
                console.log('üîç DEBUG: Starting content loading process...');
                console.log('üîç DEBUG: Module:', module);
                console.log('üîç DEBUG: Module Index:', moduleIndex);

                if (typeof generateLearningContentByType === 'function') {
                    console.log('‚úÖ DEBUG: generateLearningContentByType function exists');

                    const contentArea = document.getElementById(`enhanced-content-${moduleIndex}`);
                    console.log('üîç DEBUG: Content area found:', !!contentArea);

                    if (!contentArea) {
                        console.error('‚ùå DEBUG: Content area not found');
                        return;
                    }

                    const loadingDiv = contentArea.querySelector('.content-loading');
                    console.log('üîç DEBUG: Loading div found:', !!loadingDiv);

                    try {
                        console.log('üîç DEBUG: Calling generateLearningContentByType...');
                        const contentHTML = generateLearningContentByType(module, moduleIndex);
                        console.log('‚úÖ DEBUG: Content generated successfully');
                        console.log('üîç DEBUG: Content HTML length:', contentHTML ? contentHTML.length : 'null/undefined');
                        console.log('üîç DEBUG: Content preview:', contentHTML ? contentHTML.substring(0, 200) : 'no content');

                        if (!contentHTML) {
                            console.error('‚ùå DEBUG: Generated content is empty');
                            return;
                        }

                        // Replace loading with actual content more quickly
                        setTimeout(() => {
                            console.log('üîç DEBUG: Starting loading transition...');

                            // Immediately replace content
                            const newContent = `
                                <div class="content-header">
                                    <div class="content-icon">${module.icon}</div>
                                    <h2 class="content-title">${module.title}</h2>
                                    <div class="content-competency">${module.competency}</div>
                                    <p class="content-description">${module.description}</p>
                                </div>
                                ${contentHTML}
                            `;

                            // Clear everything and add new content
                            contentArea.innerHTML = newContent;
                            contentArea.style.opacity = '1';

                            console.log('‚úÖ DEBUG: Content replaced and made visible');
                            console.log('üîç DEBUG: Remaining loading elements:', contentArea.querySelectorAll('.content-loading, .loading-spinner').length);
                        }, 500);

                        // Enable completion button after content loads
                        setTimeout(() => {
                            console.log('üîç DEBUG: Enabling completion button...');
                            const completeBtn = document.getElementById(`complete-enhanced-btn-${moduleIndex}`);
                            if (completeBtn) {
                                completeBtn.disabled = false;
                                completeBtn.style.opacity = '1';
                                console.log('‚úÖ DEBUG: Completion button enabled');
                            } else {
                                console.log('‚ö†Ô∏è DEBUG: Completion button not found');
                            }
                        }, 3000);

                    } catch (error) {
                        console.error('üí• DEBUG: Error in content generation:', error);
                        console.error('üí• DEBUG: Error stack:', error.stack);
                    }

                } else {
                    console.error('‚ùå DEBUG: generateLearningContentByType function not available');
                    console.log('üîç DEBUG: Available functions:', Object.keys(window).filter(key => key.includes('generate')));
                }
            }, 600);
        }

        function closeEnhancedModal(moduleIndex) {
            console.log('üîç DEBUG: Closing modal for module:', moduleIndex);

            // Check if challenge is running and prevent modal close
            if (window.challengeRunning) {
                console.log('‚ö†Ô∏è DEBUG: Challenge is running, preventing modal close');
                return;
            }

            const overlay = document.getElementById(`enhanced-modal-${moduleIndex}`);
            if (overlay) {
                overlay.classList.remove('active');
                setTimeout(() => {
                    overlay.remove();
                    // Reset flag when modal is closed
                    window.isModalOpen = false;
                    console.log('‚úÖ DEBUG: Modal closed and flag reset');
                }, 400);
            } else {
                // Reset flag even if overlay not found
                window.isModalOpen = false;
                console.log('‚úÖ DEBUG: Modal flag reset (overlay not found)');
            }
        }

        function completeEnhancedModule(moduleIndex) {
            const modules = learningModulesConfig[window.currentPGYLevel];
            if (modules && modules[moduleIndex]) {
                // Mark as completed
                window.completedModules.add(modules[moduleIndex].id);
                if (moduleIndex >= window.currentModuleIndex) {
                    window.currentModuleIndex = moduleIndex + 1;
                }

                // Save progress
                saveProgressToStorage();

                // Show completion celebration
                showCompletionCelebration(modules[moduleIndex]);

                // Close modal and refresh board
                setTimeout(() => {
                    closeEnhancedModal(moduleIndex);
                    generateLearningBoard(window.currentPGYLevel);
                    updateProgressDashboard();
                }, 2000);

                console.log(`üéâ Module ${moduleIndex + 1} completed: ${modules[moduleIndex].title}`);
            }
        }

        function showCompletionCelebration(module) {
            const celebrationHTML = `
                <div style="position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; background: rgba(0,0,0,0.8); display: flex; align-items: center; justify-content: center; z-index: 3000;">
                    <div style="background: white; padding: 40px; border-radius: 20px; text-align: center; max-width: 400px;">
                        <div style="font-size: 4em; margin-bottom: 20px;">üéâ</div>
                        <h3 style="color: #1e293b; margin-bottom: 15px;">Module Completed!</h3>
                        <p style="color: #64748b;"><strong>${module.title}</strong> has been mastered!</p>
                        <div style="margin-top: 25px;">
                            <p style="color: #6b9f78; font-weight: 600;">Your journey continues...</p>
                        </div>
                    </div>
                </div>
            `;

            document.body.insertAdjacentHTML('beforeend', celebrationHTML);

            setTimeout(() => {
                const celebration = document.querySelector('[style*="position: fixed"][style*="z-index: 3000"]');
                if (celebration) {
                    celebration.remove();
                }
            }, 2000);
        }

        // Override the existing functions to use our enhanced modal system
        window.startLearningModule = startLearningModule;

        // Override showErnestDialogue to use our modal system instead
        window.showErnestDialogue = function (moduleIndex) {
            console.log('üîç DEBUG: showErnestDialogue called, redirecting to startLearningModule');
            startLearningModule(moduleIndex);
        };

        // Completely disable the old Ernest dialogue system
        window.closeErnestDialogue = function () {
            console.log('üîç DEBUG: closeErnestDialogue called (disabled)');
        };

        // Initialize modal flag
        window.isModalOpen = false;

        // Global functions for nerve navigation (moved from modal content)
        window.showNerveType = function (nerveType) {
            console.log('üîç DEBUG: showNerveType called with:', nerveType);
            // Hide all nerve content sections
            document.querySelectorAll('.nerve-content').forEach(section => {
                section.style.display = 'none';
            });

            // Show selected nerve content
            const selectedContent = document.getElementById(nerveType + '-content');
            if (selectedContent) {
                selectedContent.style.display = 'block';
                console.log('‚úÖ DEBUG: Showing content for:', nerveType);
            } else {
                console.log('‚ùå DEBUG: Content not found for:', nerveType);
            }

            // Update nerve type button styles
            document.querySelectorAll('.nerve-type-btn').forEach(btn => {
                btn.style.background = '#f8fafc';
                btn.style.border = '2px solid #e2e8f0';
                btn.style.color = '#64748b';
            });

            // Highlight active nerve type button
            const activeBtn = document.querySelector('[data-nerve="' + nerveType + '"]');
            if (activeBtn) {
                if (nerveType === 'overview') {
                    activeBtn.style.background = '#fef3c7';
                    activeBtn.style.border = '2px solid #f59e0b';
                    activeBtn.style.color = '#d97706';
                } else {
                    activeBtn.style.background = 'white';
                    activeBtn.style.border = '3px solid #3b82f6';
                    activeBtn.style.color = '#1e40af';
                }
                console.log('‚úÖ DEBUG: Highlighted button for:', nerveType);
            }
        };

        window.showMedianSection = function (sectionId) {
            console.log('üîç DEBUG: showMedianSection called with:', sectionId);
            // Hide all median sections
            document.querySelectorAll('.median-section').forEach(section => {
                section.style.display = 'none';
            });

            // Show selected section
            const selectedSection = document.getElementById(sectionId);
            if (selectedSection) {
                selectedSection.style.display = 'block';
                console.log('‚úÖ DEBUG: Showing median section:', sectionId);
            }

            // Update button styles within median content
            const medianContent = document.getElementById('median-content');
            if (medianContent) {
                medianContent.querySelectorAll('.nerve-nav-btn').forEach(btn => {
                    btn.style.background = '#f8fafc';
                    btn.style.border = '2px solid #e2e8f0';
                    btn.querySelectorAll('h5, p').forEach(el => el.style.color = '#64748b');
                });

                // Highlight active button
                const activeBtn = medianContent.querySelector('[data-section="' + sectionId + '"]');
                if (activeBtn) {
                    activeBtn.style.background = 'white';
                    activeBtn.style.border = '3px solid #3b82f6';
                    activeBtn.querySelectorAll('h5').forEach(el => el.style.color = '#1e40af');
                }
            }
        };

        window.showUlnarSection = function (sectionId) {
            console.log('üîç DEBUG: showUlnarSection called with:', sectionId);
            // Hide all ulnar sections
            document.querySelectorAll('.ulnar-section').forEach(section => {
                section.style.display = 'none';
            });

            // Show selected section
            const selectedSection = document.getElementById(sectionId);
            if (selectedSection) {
                selectedSection.style.display = 'block';
                console.log('‚úÖ DEBUG: Showing ulnar section:', sectionId);
            }

            // Update ulnar button styles within ulnar content
            const ulnarContent = document.getElementById('ulnar-content');
            if (ulnarContent) {
                ulnarContent.querySelectorAll('.nerve-nav-btn').forEach(btn => {
                    btn.style.background = '#f8fafc';
                    btn.style.border = '2px solid #e2e8f0';
                    btn.querySelectorAll('h5, p').forEach(el => el.style.color = '#64748b');
                });

                // Highlight active button
                const activeBtn = ulnarContent.querySelector('[data-section="' + sectionId + '"]');
                if (activeBtn) {
                    activeBtn.style.background = 'white';
                    activeBtn.style.border = '3px solid #3b82f6';
                    activeBtn.querySelectorAll('h5').forEach(el => el.style.color = '#1e40af');
                }
            }
        };

        // Global quiz function for median nerve content
        window.checkMedianAnswer = function (button, isCorrect) {
            console.log('üîç DEBUG: checkMedianAnswer called with isCorrect:', isCorrect);
            const buttons = button.parentNode.querySelectorAll('.quiz-option');
            buttons.forEach(btn => btn.style.pointerEvents = 'none');

            if (isCorrect) {
                button.style.background = '#dcfce7';
                button.style.border = '2px solid #059669';
                button.style.color = '#059669';
                button.innerHTML += ' ‚úì Correct! Normal thenar sensation (palmar cutaneous branch) localizes to carpal tunnel.';
            } else {
                button.style.background = '#fef2f2';
                button.style.border = '2px solid #dc2626';
                button.style.color = '#dc2626';
                button.innerHTML += ' ‚úó';
            }
        };

        // Pathway Explorer Global Functions
        window.pathwayExplorer = window.pathwayExplorer || {};
        window.pathwayExplorer.currentNerve = null;
        window.pathwayExplorer.currentStep = 0;
        window.pathwayExplorer.maxSteps = 0;

        window.pathwayExplorer.nerveData = {
            median: {
                name: "Median Nerve",
                roots: "C6-T1",
                image: "Nerve Paths/Median Nerve.png",
                story: "The Median Messenger starts his epic journey at the bustling Brachial Plexus Central Station (C6-T1), where lateral and medial cords shake hands to form our hero. He travels down the arm like a VIP, riding the bicipital groove limousine between the Biceps and Brachialis neighborhoods. At the Cubital Fossa rest stop, he takes a breather medial to the brachial artery before squeezing through the narrow Pronator Teres tunnel. His faithful sidekick, the Anterior Interosseous branch, splits off to handle the deep muscle work while our main character continues toward his final destination: the infamous Carpal Tunnel! After surviving this tight squeeze, he emerges victorious in the hand, ready to command the LOAF muscles like a general commanding his troops!",
                steps: [
                    { title: "Origin", desc: "Forms from lateral and medial cords of brachial plexus (C6-T1)", isInjurySite: false },
                    { title: "Upper Arm", desc: "Travels medially to humerus in bicipital groove", isInjurySite: false },
                    { title: "Cubital Fossa", desc: "Passes medial to brachial artery", isInjurySite: false },
                    { title: "Forearm Entry", desc: "Passes between heads of pronator teres (common entrapment site)", isInjurySite: true },
                    { title: "AIN Branch", desc: "Gives off anterior interosseous nerve", isInjurySite: false },
                    { title: "Carpal Tunnel", desc: "Passes through carpal tunnel under transverse carpal ligament (most common entrapment)", isInjurySite: true },
                    { title: "Hand", desc: "Divides into branches for thenar muscles (LOAF)", isInjurySite: false }
                ]
            },
            ulnar: {
                name: "Ulnar Nerve",
                roots: "C8-T1",
                image: "Nerve Paths/Ulnar Nerve.png",
                story: "The Ulnar Underdog begins as the lone ranger from the medial cord, carrying the pure power of C8 and T1. He travels down the arm, taking the scenic route around the medial epicondyle at the elbow - that famous 'funny bone' spot where everyone's felt his electric personality! He slides through Guyon's canal at the wrist like a secret agent, then splits his mission: the deep branch heads to the interossei (the hand's fine motor specialists), while the superficial branch handles sensation for the pinky side of life.",
                steps: [
                    { title: "Origin", desc: "Arises from medial cord of brachial plexus (C8-T1)", isInjurySite: false },
                    { title: "Upper Arm", desc: "Travels down medial aspect of arm", isInjurySite: false },
                    { title: "Cubital Tunnel", desc: "Passes through cubital tunnel under Osborne's band behind medial epicondyle (most common entrapment)", isInjurySite: true },
                    { title: "Forearm", desc: "Travels between FCU and FDP in forearm", isInjurySite: false },
                    { title: "Guyon's Canal", desc: "Passes through Guyon's canal at wrist (volar carpal ligament roof)", isInjurySite: true },
                    { title: "Hand Division", desc: "Splits into superficial and deep branches", isInjurySite: false },
                    { title: "Hand Muscles", desc: "Innervates intrinsic hand muscles and sensation", isInjurySite: false }
                ]
            },
            radial: {
                name: "Radial Nerve",
                roots: "C5-T1",
                image: "Nerve Paths/Radial Nerve.png",
                story: "The Radial Rebel is the strong, silent type from the posterior cord, packing the full power of C5-T1. This mighty nerve takes the back route down the arm, spiraling around the humerus in the famous spiral groove like a roller coaster. He's the extension expert, powering all the muscles that straighten the elbow, lift the wrist, and extend the fingers. His most vulnerable moment comes at the spiral groove, where a broken humerus can leave him bruised and beaten, causing the dreaded 'wrist drop.'",
                steps: [
                    { title: "Origin", desc: "Arises from posterior cord (C5-T1)", isInjurySite: false },
                    { title: "Spiral Groove", desc: "Travels in spiral groove of humerus directly on bone (most vulnerable point for compression/fracture)", isInjurySite: true },
                    { title: "Lateral Arm", desc: "Emerges laterally, pierces lateral intermuscular septum", isInjurySite: false },
                    { title: "Elbow Division", desc: "Divides into superficial and deep (PIN) branches", isInjurySite: false },
                    { title: "Posterior Forearm", desc: "PIN passes through arcade of Frohse at supinator (compression site)", isInjurySite: true },
                    { title: "Dorsal Hand", desc: "Superficial branch provides dorsal hand sensation", isInjurySite: false }
                ]
            },
            musculocutaneous: {
                name: "Musculocutaneous Nerve",
                roots: "C5-C7",
                image: "Nerve Paths/Musculocutaneous Nerve.png",
                story: "The Musculocutaneous Marvel begins at the lateral cord headquarters in the brachial plexus, carrying orders from C5-C7. This sturdy nerve pierces through the coracobrachialis muscle like a determined warrior, then travels between the biceps brachii and brachialis muscles, supervising their every flex. As it approaches the elbow, it transforms into the lateral cutaneous nerve of the forearm, spreading its sensory network across the lateral forearm like a protective shield.",
                steps: [
                    { title: "Origin", desc: "Arises from lateral cord of brachial plexus (C5-C7)", isInjurySite: false },
                    { title: "Coracobrachialis", desc: "Pierces coracobrachialis muscle", isInjurySite: false },
                    { title: "Biceps Brachii", desc: "Innervates biceps brachii", isInjurySite: false },
                    { title: "Brachialis", desc: "Innervates lateral part of brachialis", isInjurySite: false },
                    { title: "Lateral Cutaneous", desc: "Becomes lateral cutaneous nerve of forearm", isInjurySite: false },
                    { title: "Forearm Sensation", desc: "Provides sensation to lateral forearm", isInjurySite: false }
                ]
            },
            axillary: {
                name: "Axillary Nerve",
                roots: "C5-C6",
                image: "Nerve Paths/Axillary Nerve.png",
                story: "The Axillary Ambassador emerges from the posterior cord, carrying the strength of C5 and C6. This diplomatic nerve travels posteriorly around the surgical neck of the humerus, navigating through the quadrilateral space like a secret agent. It has two important missions: powering the mighty deltoid muscle and providing sensation to the shoulder's badge of honor - that small patch of skin over the deltoid that soldiers call the 'regimental patch'.",
                steps: [
                    { title: "Origin", desc: "Arises from posterior cord (C5-C6)", isInjurySite: false },
                    { title: "Quadrilateral Space", desc: "Passes through quadrilateral space", isInjurySite: false },
                    { title: "Surgical Neck", desc: "Wraps around surgical neck of humerus (vulnerable to fracture)", isInjurySite: true },
                    { title: "Deltoid Motor", desc: "Innervates deltoid muscle", isInjurySite: false },
                    { title: "Teres Minor", desc: "Innervates teres minor muscle", isInjurySite: false },
                    { title: "Cutaneous Branch", desc: "Provides sensation over deltoid (regimental patch)", isInjurySite: false }
                ]
            },
            femoral: {
                name: "Femoral Nerve",
                roots: "L2-L4",
                image: "Nerve Paths/Femoral Nerve.png",
                story: "The Femoral General emerges from the lumbar plexus with the authority of L2-L4. This commanding nerve travels under the inguinal ligament like a VIP passing through customs, then spreads its influence across the anterior thigh. It's the knee extension expert, powering the mighty quadriceps muscle group while also providing sensation down the medial leg via its saphenous branch - the longest sensory nerve in the body!",
                steps: [
                    { title: "Origin", desc: "Forms from lumbar plexus (L2-L4)", isInjurySite: false },
                    { title: "Inguinal Ligament", desc: "Passes under inguinal ligament", isInjurySite: false },
                    { title: "Femoral Triangle", desc: "Enters femoral triangle", isInjurySite: false },
                    { title: "Quadriceps", desc: "Innervates quadriceps muscle group", isInjurySite: false },
                    { title: "Saphenous Branch", desc: "Gives off saphenous nerve", isInjurySite: false },
                    { title: "Medial Leg", desc: "Saphenous nerve provides sensation to medial leg", isInjurySite: false }
                ]
            },
            tibial: {
                name: "Tibial Nerve",
                roots: "L4-S3",
                image: "Nerve Paths/Tibial Nerve.png",
                story: "The Tibial Traveler is one half of the mighty sciatic nerve's legacy, carrying the plantarflexion power of L4-S3. After the sciatic nerve splits at the popliteal fossa, this nerve takes the deep route down the posterior leg, traveling through the tarsal tunnel at the ankle like a train through a mountain pass. It's the pointing-toes expert, controlling all the muscles that push the foot down and curl the toes.",
                steps: [
                    { title: "Origin", desc: "Medial division of sciatic nerve (L4-S3)", isInjurySite: false },
                    { title: "Popliteal Fossa", desc: "Continues from sciatic bifurcation", isInjurySite: false },
                    { title: "Posterior Leg", desc: "Travels down posterior compartment", isInjurySite: false },
                    { title: "Plantarflexors", desc: "Innervates calf muscles and deep compartment", isInjurySite: false },
                    { title: "Tarsal Tunnel", desc: "Passes through tarsal tunnel under flexor retinaculum at medial ankle (entrapment site)", isInjurySite: true },
                    { title: "Foot Muscles", desc: "Divides into medial and lateral plantar nerves for intrinsic foot muscles", isInjurySite: false }
                ]
            },
            peroneal: {
                name: "Peroneal (Fibular) Nerve",
                roots: "L4-S2",
                image: "Nerve Paths/Superficial Fibular Nerve.png",
                deepImage: "Nerve Paths/Deep Fibular Nerve.png",
                story: "The Peroneal Pioneer, also known as the Common Fibular nerve, is an adventurous branch of the mighty sciatic nerve. This nerve loves taking the scenic route around the fibular head, making it vulnerable but vital for foot function. It splits into two explorers: the superficial peroneal (the ankle evertor) and the deep peroneal (the toe lifter), each with their own important territories to govern in the lower leg and foot.",
                steps: [
                    { title: "Origin", desc: "Lateral division of sciatic nerve (L4-S2)", isInjurySite: false },
                    { title: "Fibular Head", desc: "Wraps around fibular neck through fibular tunnel (most common lower extremity mononeuropathy)", isInjurySite: true },
                    { title: "Superficial Branch", desc: "Gives off superficial peroneal nerve for ankle eversion", isInjurySite: false },
                    { title: "Deep Branch", desc: "Continues as deep peroneal nerve for ankle dorsiflexion", isInjurySite: false },
                    { title: "Anterior Tarsal Tunnel", desc: "Deep peroneal passes under inferior extensor retinaculum at ankle (rare entrapment)", isInjurySite: true },
                    { title: "Foot", desc: "Provides motor to foot extensors and sensation to dorsal foot and first web space", isInjurySite: false }
                ]
            },
            sciatic: {
                name: "Sciatic Nerve",
                roots: "L4-S3",
                image: "Nerve Paths/Sciatic Nerve.png",
                story: "The Sciatic Supreme is the body's largest and most powerful nerve, combining the might of the lumbar and sacral plexuses. This heavyweight champion travels through the greater sciatic foramen, then runs down the posterior thigh like a mighty river. At the popliteal fossa, it typically splits into its two famous branches: the tibial nerve (the plantarflexion powerhouse) and the common peroneal nerve (the dorsiflexion dynamo).",
                steps: [
                    { title: "Origin", desc: "Forms from sacral plexus (L4-S3)", isInjurySite: false },
                    { title: "Greater Sciatic Foramen", desc: "Exits pelvis through greater sciatic foramen", isInjurySite: false },
                    { title: "Posterior Thigh", desc: "Travels down posterior thigh", isInjurySite: false },
                    { title: "Hamstring Muscles", desc: "Innervates hamstring muscles", isInjurySite: false },
                    { title: "Popliteal Fossa", desc: "Reaches popliteal fossa", isInjurySite: false },
                    { title: "Bifurcation", desc: "Splits into tibial and common peroneal nerves", isInjurySite: false }
                ]
            },
            obturator: {
                name: "Obturator Nerve",
                roots: "L2-L4",
                image: "Nerve Paths/Obturator Nerve.png",
                story: "The Obturator Officer is a specialized nerve with a unique mission: controlling hip adduction. Born from the lumbar plexus, this nerve takes an unusual route through the obturator foramen (hence its name), like a secret tunnel through the pelvis. It divides into anterior and posterior branches to command the adductor muscle army, helping bring the legs together and stabilize the hip during walking.",
                steps: [
                    { title: "Origin", desc: "Arises from lumbar plexus (L2-L4)", isInjurySite: false },
                    { title: "Obturator Foramen", desc: "Passes through obturator foramen", isInjurySite: false },
                    { title: "Anterior Branch", desc: "Splits into anterior branch", isInjurySite: false },
                    { title: "Posterior Branch", desc: "Splits into posterior branch", isInjurySite: false },
                    { title: "Adductor Muscles", desc: "Innervates adductor muscle group", isInjurySite: false },
                    { title: "Hip Sensation", desc: "Provides sensation to medial thigh", isInjurySite: false }
                ]
            },
            sural: {
                name: "Sural Nerve",
                roots: "S1-S2",
                image: "Nerve Paths/Sural Nerve.png",
                story: "The Sural Scout is the faithful sensory companion of the lower leg. Formed by the union of the medial sural cutaneous nerve (from the tibial) and the communicating branch (from the common peroneal), this nerve travels down the back of the calf like a dedicated rear guard. It passes behind the lateral malleolus - a key landmark! - and continues along the side of the foot, providing sensation to the postero-lateral leg and the lateral side of the foot and little toe.",
                steps: [
                    { title: "Origin", desc: "Formed by union of medial sural cutaneous (tibial) and sural communicating branch (common peroneal) (S1-S2)", isInjurySite: false },
                    { title: "Posterior Leg", desc: "Travels down midline of posterior calf with small saphenous vein", isInjurySite: false },
                    { title: "Lateral Malleolus", desc: "Passes posterior to lateral malleolus (key landmark)", isInjurySite: false },
                    { title: "Foot", desc: "Travels along lateral side of foot", isInjurySite: false },
                    { title: "Innervation", desc: "Sensation to posterolateral leg, lateral foot, and lateral aspect of 5th toe", isInjurySite: false }
                ]
            }
        };

        window.selectNerve = function (nerveName) {
            console.log('üß† Selecting nerve:', nerveName);
            const explorer = window.pathwayExplorer;
            if (!explorer.nerveData[nerveName]) {
                console.log('‚ùå Nerve not found:', nerveName);
                return;
            }

            explorer.currentNerve = explorer.nerveData[nerveName];
            explorer.currentStep = 0;
            explorer.maxSteps = explorer.currentNerve.steps.length;

            const pathwayContainer = document.getElementById('pathway-container');
            if (pathwayContainer) {
                pathwayContainer.style.display = 'block';
                console.log('‚úÖ Pathway container shown');
            }

            const storyElement = document.getElementById('story-text');
            if (storyElement) {
                storyElement.innerHTML = explorer.currentNerve.story;
                console.log('‚úÖ Story updated');
            }

            const imageElement = document.getElementById('nerve-pathway-image');
            if (imageElement) {
                let imageHtml = '';

                // Special case for peroneal nerve - show both superficial and deep fibular
                if (nerveName === 'peroneal' && explorer.currentNerve.deepImage) {
                    imageHtml = '<div style="text-align: center;"><h6 style="color: #0c4a6e; margin-bottom: 15px; font-size: 1.1em;">' + explorer.currentNerve.name + '</h6><p style="color: #64748b; margin-bottom: 15px;">Nerve Roots: ' + explorer.currentNerve.roots + '</p>' +
                        '<div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">' +
                        '<div><h6 style="color: #0369a1; font-size: 1em; margin-bottom: 8px;">Superficial Fibular</h6><img src="' + explorer.currentNerve.image + '" alt="Superficial Fibular Nerve Pathway" style="width: 100%; height: auto; border-radius: 8px; border: 2px solid #bae6fd;"></div>' +
                        '<div><h6 style="color: #0369a1; font-size: 1em; margin-bottom: 8px;">Deep Fibular</h6><img src="' + explorer.currentNerve.deepImage + '" alt="Deep Fibular Nerve Pathway" style="width: 100%; height: auto; border-radius: 8px; border: 2px solid #bae6fd;"></div>' +
                        '</div></div>';
                } else if (explorer.currentNerve.image) {
                    // Regular nerve with single image
                    imageHtml = '<div style="text-align: center;"><h6 style="color: #0c4a6e; margin-bottom: 10px; font-size: 1.1em;">' + explorer.currentNerve.name + '</h6><p style="color: #64748b; margin-bottom: 15px;">Nerve Roots: ' + explorer.currentNerve.roots + '</p><img src="' + explorer.currentNerve.image + '" alt="' + explorer.currentNerve.name + ' Pathway" style="width: 100%; height: auto; border-radius: 8px; border: 2px solid #bae6fd;"></div>';
                } else {
                    // Fallback for nerves without images
                    imageHtml = '<div style="text-align: center;"><div style="font-size: 3em; margin-bottom: 15px; color: #0ea5e9;">üß†</div><h6 style="color: #0c4a6e; margin-bottom: 10px; font-size: 1.1em;">' + explorer.currentNerve.name + '</h6><p style="color: #64748b;">Nerve Roots: ' + explorer.currentNerve.roots + '</p><p style="color: #94a3b8; font-size: 0.9em; margin-top: 15px; padding: 10px; background: #f1f5f9; border-radius: 6px;">[Image not available]</p></div>';
                }

                imageElement.innerHTML = imageHtml;
                console.log('‚úÖ Nerve image updated for:', nerveName);
            }

            window.showStep(0);

            document.querySelectorAll('.nerve-btn').forEach(btn => {
                btn.style.background = 'white';
                btn.style.color = '#0c4a6e';
            });

            const clickedButton = document.querySelector('button[onclick*="' + nerveName + '"]');
            if (clickedButton) {
                clickedButton.style.background = '#0ea5e9';
                clickedButton.style.color = 'white';
                console.log('‚úÖ Button highlighted');
            }
        };

        // Define showStep with RED/GREEN injury highlighting + click functionality
        window.showStep = function (stepIndex) {
            const explorer = window.pathwayExplorer;
            if (!explorer.currentNerve || stepIndex < 0 || stepIndex >= explorer.maxSteps) return;

            explorer.currentStep = stepIndex;

            // Build HTML with RED for injuries, GREEN for normal
            const stepsHtml = explorer.currentNerve.steps.map((s, i) => {
                const isInjury = s.isInjurySite;
                const isCurrent = i === stepIndex;
                const isFuture = i > stepIndex;

                let borderColor, bgColor, textColor, icon;

                if (isFuture) {
                    borderColor = '#e5e7eb';
                    bgColor = '#f9fafb';
                    textColor = '#6b7280';
                    icon = `${i + 1}.`;
                } else if (isInjury) {
                    borderColor = '#dc2626';
                    bgColor = isCurrent ? '#fee2e2' : '#fef2f2';
                    textColor = isCurrent ? '#991b1b' : '#dc2626';
                    icon = `‚ö†Ô∏è ${i + 1}.`;
                } else {
                    borderColor = '#10b981';
                    bgColor = isCurrent ? '#f0fdf4' : '#ecfdf5';
                    textColor = isCurrent ? '#047857' : '#059669';
                    icon = `${i + 1}.`;
                }

                return `<div style="padding: 10px; margin-bottom: 8px; border-radius: 8px; border-left: 4px solid ${borderColor}; background: ${bgColor};">
                    <div style="font-weight: 600; color: ${textColor}; margin-bottom: 4px;">
                        ${icon} ${s.title}
                    </div>
                    <div style="color: ${isFuture ? '#9ca3af' : '#374151'}; font-size: 0.95em;">
                        ${s.desc}
                    </div>
                </div>`;
            }).join('');

            const clickHint = stepIndex === explorer.maxSteps - 1 ? '' :
                '<div style="position: absolute; bottom: 10px; right: 15px; color: #94a3b8; font-size: 0.8em; opacity: 0.7;">Click anywhere to advance ‚Üí</div>';

            document.getElementById('pathway-steps').innerHTML = stepsHtml + clickHint;

            // Update prev button
            const prevBtn = document.getElementById('prev-btn');
            if (prevBtn) {
                prevBtn.disabled = stepIndex === 0;
                prevBtn.style.opacity = stepIndex === 0 ? '0.5' : '1';
            }

            // Set up click-to-advance functionality
            const pathwayBox = document.getElementById('pathway-steps');
            if (stepIndex === explorer.maxSteps - 1) {
                pathwayBox.style.cursor = 'default';
                pathwayBox.onclick = null;
            } else {
                pathwayBox.style.cursor = 'pointer';
                pathwayBox.onclick = window.nextStep;
                pathwayBox.onmouseover = function () {
                    this.style.backgroundColor = '#f0f9ff';
                    this.style.borderColor = '#0ea5e9';
                    this.style.transform = 'translateY(-2px)';
                    this.style.boxShadow = '0 4px 12px rgba(14, 165, 233, 0.15)';
                };
                pathwayBox.onmouseout = function () {
                    this.style.backgroundColor = 'white';
                    this.style.borderColor = '#bae6fd';
                    this.style.transform = 'translateY(0)';
                    this.style.boxShadow = 'none';
                };
            }
        };

        window.nextStep = function () {
            const explorer = window.pathwayExplorer;
            if (explorer.currentStep < explorer.maxSteps - 1) {
                window.showStep(explorer.currentStep + 1);
            }
        };

        window.previousStep = function () {
            const explorer = window.pathwayExplorer;
            if (explorer.currentStep > 0) {
                window.showStep(explorer.currentStep - 1);
            }
        };

        window.resetPathway = function () {
            const explorer = window.pathwayExplorer;
            if (explorer.currentNerve) {
                window.showStep(0);
            }
        };

        // Function to close general modal
        window.closeGeneralModal = function () {
            const modalOverlay = document.getElementById('modal-overlay');
            if (modalOverlay) {
                modalOverlay.style.display = 'none';
            }
        };

        // ===============================================
        // ATRIUM HEALTH 13-MODULE PATHWAY SYSTEM
        // ===============================================

        // Module Configuration with Custom Artwork Integration
        const atriumModuleConfig = [
            { id: 'emg-introduction', title: 'EMG/NCS Introduction', customIcon: 'NEW ICONS/EMG:NCS Intro.png' },
            { id: 'plexus-anatomy', title: 'Plexus Anatomy', customIcon: 'NEW ICONS/Peripheral Anatomy.png' },
            { id: 'brachial-plexus-interactive', title: 'Brachial Plexus Interactive', customIcon: 'NEW ICONS/Brachial Plexus Anatomy.png' },
            { id: 'radiculopathy-pathophysiology', title: 'Radiculopathy Pathophysiology', customIcon: 'NEW ICONS/Radiculopathy Pathophysiology.png' },
            { id: 'neuropathy-pathophysiology', title: 'Neuropathy Pathophysiology', customIcon: 'NEW ICONS/Neuropathy Pathophysiology.png' },
            { id: 'ncs-fundamentals', title: 'NCS Fundamentals', customIcon: 'NEW ICONS/NCS Fundamentals.png' },
            { id: 'ncs-techniques', title: 'NCS Techniques', customIcon: 'NEW ICONS/NCS Techniques.png' },
            { id: 'emg-needle-localization', title: 'EMG Needle Localization', customIcon: 'NEW ICONS/EMG Needle localization.png' },
            { id: 'muscle-quiz', title: 'Muscle Study Lab', customIcon: 'NEW ICONS/muscle study lab.png' },
            { id: 'basic-patterns', title: 'Basic Pattern Recognition', customIcon: 'NEW ICONS/Basic Pattern Recognition.png' },
            { id: 'neuropathy-myopathy-basics', title: 'Neuropathy vs Myopathy Basics', customIcon: 'NEW ICONS/Neuropathy vs. Myopathy Basics.png' },
            { id: 'simple-reports', title: 'Basic Report Writing', customIcon: 'NEW ICONS/Basic report writing.png' },
            { id: 'clinical-correlation', title: 'Clinical Application', customIcon: 'NEW ICONS/Clinical application.png' }
        ];

        // Old ERNEST Messages Removed - Now Using Dynamic Description System

        // Create Pre-Positioned Description Boxes
        function createDescriptionBoxes() {
            const boardContainer = document.getElementById('learning-board');

            // Create 14 description boxes, one for each module
            for (let moduleNumber = 1; moduleNumber <= 14; moduleNumber++) {
                const desc = moduleDescriptions[moduleNumber] || {
                    title: `Module ${moduleNumber}`,
                    text: "Description coming soon.",
                    highlights: ""
                };

                const side = (moduleNumber - 1) % 2 === 0 ? 'left' : 'right';

                // Create the description box element
                const descriptionBox = document.createElement('div');
                descriptionBox.id = `description-box-${moduleNumber}`;
                descriptionBox.className = `ernest-description-box module-${moduleNumber}-description`;
                descriptionBox.innerHTML = `
                    <div class="description-ernest">
                        <img src="ERNEST.png" alt="ERNEST" class="description-ernest-avatar">
                        <div class="description-content">
                            <div class="description-title">${desc.title}</div>
                            <div class="description-text">${desc.text}</div>
                            <div class="description-highlights">${desc.highlights}</div>
                        </div>
                    </div>
                `;

                // Add to the page
                boardContainer.appendChild(descriptionBox);

                // Position it parallel to the corresponding module (will be refined in next step)
                positionDescriptionBox(descriptionBox, moduleNumber, side);
            }

            console.log('‚úÖ Created 13 pre-positioned description boxes');

            // Add window resize handler to reposition boxes
            window.addEventListener('resize', () => {
                for (let moduleNumber = 1; moduleNumber <= 14; moduleNumber++) {
                    const box = document.getElementById(`description-box-${moduleNumber}`);
                    const side = (moduleNumber - 1) % 2 === 0 ? 'left' : 'right';
                    if (box) {
                        positionDescriptionBox(box, moduleNumber, side);
                    }
                }
            });
        }

        // Position Description Box Parallel to Module Icon
        function positionDescriptionBox(box, moduleNumber, side) {
            // Find the corresponding module element
            const moduleElement = document.querySelector(`[onmouseover*="showModuleDescription(${moduleNumber}"]`);
            if (!moduleElement) {
                console.warn(`Module ${moduleNumber} not found for positioning`);
                return;
            }

            // Get the pathway center line element to calculate precise center
            const centerLine = document.querySelector('.pathway-center-line');
            const moduleRect = moduleElement.getBoundingClientRect();
            const centerRect = centerLine ? centerLine.getBoundingClientRect() : null;

            // Calculate the center of the page/pathway
            const pageCenter = centerRect ? centerRect.left + (centerRect.width / 2) : window.innerWidth / 2;

            // Calculate vertical position (parallel to module icon)
            const scrollY = window.scrollY;
            const topPosition = moduleRect.top + scrollY + (moduleRect.height / 2) - 100; // Center vertically with box

            // Calculate horizontal position (opposite side of center line)
            let leftPosition;
            const boxWidth = 350; // Match CSS width
            const spacing = 150; // Increased gap between center line and description box

            if (side === 'left') {
                // Module on left, description on right side of center
                leftPosition = pageCenter + spacing;
            } else {
                // Module on right, description on left side of center
                leftPosition = pageCenter - spacing - boxWidth;
            }

            // Ensure description boxes don't go off-screen
            const minLeft = 20;
            const maxLeft = window.innerWidth - boxWidth - 20;
            leftPosition = Math.max(minLeft, Math.min(maxLeft, leftPosition));

            // Apply positioning
            box.style.position = 'fixed';
            box.style.top = topPosition + 'px';
            box.style.left = leftPosition + 'px';
            box.style.opacity = '0'; // Hidden initially
            box.style.pointerEvents = 'none'; // Non-interactive when hidden

            // console.log(`Positioned description box ${moduleNumber} (${side}) at top: ${topPosition}px, left: ${leftPosition}px`);
        }

        // Generate New Grid-Based Layout
        function generateAtriumPathway(pgyLevel) {
            console.log('üè• Generating New Grid Layout...');

            const boardContainer = document.getElementById('learning-board');
            if (!boardContainer) {
                console.error('‚ùå Learning board container not found');
                return;
            }

            // Generate new grid layout HTML
            const layoutHTML = `
                <div class="atrium-pathway-container">
                    <div class="pathway-background-animation"></div>

                    <!-- Pathway Header -->
                    <div class="pathway-header">
                        <h1 class="pathway-title">
                            <img src="atrium.jpeg" alt="Atrium Health" class="atrium-logo-title">
                            EMG/NCS Learning Pathway
                        </h1>
                        <p class="pathway-subtitle">Comprehensive Electrodiagnostic Medicine Training</p>
                        <button class="learning-objectives-btn" onclick="showLearningObjectives()">See Learning Objectives</button>

                        <!-- Collapsible Podcasts Button -->
                        <button class="collapsible-podcasts-btn" onclick="togglePodcastsCollapsible()" style="
                            background: linear-gradient(135deg, #f59e0b, #ea580c);
                            color: white;
                            border: none;
                            border-radius: 12px;
                            padding: 15px 25px;
                            margin: 15px auto;
                            cursor: pointer;
                            display: flex;
                            align-items: center;
                            gap: 15px;
                            transition: all 0.3s ease;
                            box-shadow: 0 4px 15px rgba(245, 158, 11, 0.3);
                            font-size: 1.1em;
                            font-weight: 600;
                            max-width: 450px;">
                            <img src="ERNEST.png" alt="Ernest" style="width: 60px; height: 60px; border-radius: 50%; border: 3px solid white; object-fit: cover;">
                            <span style="flex: 1;">Come Listen to My Podcasts!</span>
                            <span id="podcast-toggle-icon" style="transition: transform 0.3s ease; font-size: 1.2em;">‚ñº</span>
                        </button>
                    </div>

                    <!-- Collapsible Podcasts Container -->
                    <div id="podcasts-collapsible-container" class="podcasts-collapsible" style="
                        display: none;
                        max-width: 1200px;
                        margin: 0 auto 40px;
                        background: white;
                        border-radius: 12px;
                        padding: 25px;
                        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);">

                        <h3 style="color: #1e40af; margin: 0 0 20px 0; font-size: 1.3em; text-align: center;">üéôÔ∏è All Podcast Episodes (14 Total)</h3>

                        <!-- Module Podcasts Section -->
                        <div style="margin-bottom: 25px;">
                            <h4 style="color: #3b82f6; margin: 0 0 12px 0; font-size: 1em; border-bottom: 2px solid #e5e7eb; padding-bottom: 8px;">üìö Module Podcasts</h4>

                            <!-- 3-Column Grid -->
                            <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px;">
                                <!-- EMG Introduction Fundamentals -->
                                <div onclick="openModulePodcast('emg-introduction', 'emg-intro-main')" style="
                                    background: #f8fafc; border: 1px solid #e2e8f0; border-radius: 6px; padding: 8px;
                                    cursor: pointer; transition: all 0.2s ease; display: flex; align-items: center; gap: 8px;"
                                    onmouseover="this.style.background='#eff6ff'; this.style.borderColor='#3b82f6'"
                                    onmouseout="this.style.background='#f8fafc'; this.style.borderColor='#e2e8f0'">
                                    <img src="ERNEST.png" style="width: 28px; height: 28px; border-radius: 50%; flex-shrink: 0; object-fit: cover;" alt="Ernest">
                                    <div style="flex: 1; min-width: 0;">
                                        <div style="font-size: 0.8em; font-weight: 600; color: #1e40af; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">EMG Introduction</div>
                                        <div style="font-size: 0.7em; color: #64748b;">52:27</div>
                                    </div>
                                    <svg width="16" height="16" viewBox="0 0 16 16" fill="none" style="flex-shrink: 0;">
                                        <path d="M3 2L13 8L3 14V2Z" fill="#f59e0b"/>
                                    </svg>
                                </div>

                                <!-- Essential Terminology -->
                                <div onclick="openModulePodcast('emg-introduction', 'emg-terminology')" style="
                                    background: #f8fafc; border: 1px solid #e2e8f0; border-radius: 6px; padding: 8px;
                                    cursor: pointer; transition: all 0.2s ease; display: flex; align-items: center; gap: 8px;"
                                    onmouseover="this.style.background='#eff6ff'; this.style.borderColor='#3b82f6'"
                                    onmouseout="this.style.background='#f8fafc'; this.style.borderColor='#e2e8f0'">
                                    <img src="ERNEST.png" style="width: 28px; height: 28px; border-radius: 50%; flex-shrink: 0; object-fit: cover;" alt="Ernest">
                                    <div style="flex: 1; min-width: 0;">
                                        <div style="font-size: 0.8em; font-weight: 600; color: #1e40af; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">Essential Terminology</div>
                                        <div style="font-size: 0.7em; color: #64748b;">14:46</div>
                                    </div>
                                    <svg width="16" height="16" viewBox="0 0 16 16" fill="none" style="flex-shrink: 0;">
                                        <path d="M3 2L13 8L3 14V2Z" fill="#f59e0b"/>
                                    </svg>
                                </div>

                                <!-- Peripheral Anatomy -->
                                <div onclick="openModulePodcast('plexus-anatomy', 'plexus-peripheral')" style="
                                    background: #f8fafc; border: 1px solid #e2e8f0; border-radius: 6px; padding: 8px;
                                    cursor: pointer; transition: all 0.2s ease; display: flex; align-items: center; gap: 8px;"
                                    onmouseover="this.style.background='#eff6ff'; this.style.borderColor='#3b82f6'"
                                    onmouseout="this.style.background='#f8fafc'; this.style.borderColor='#e2e8f0'">
                                    <img src="ERNEST.png" style="width: 28px; height: 28px; border-radius: 50%; flex-shrink: 0; object-fit: cover;" alt="Ernest">
                                    <div style="flex: 1; min-width: 0;">
                                        <div style="font-size: 0.8em; font-weight: 600; color: #1e40af; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">Peripheral Anatomy</div>
                                        <div style="font-size: 0.7em; color: #64748b;">39:07</div>
                                    </div>
                                    <svg width="16" height="16" viewBox="0 0 16 16" fill="none" style="flex-shrink: 0;">
                                        <path d="M3 2L13 8L3 14V2Z" fill="#f59e0b"/>
                                    </svg>
                                </div>

                                <!-- Anomalous Anatomy -->
                                <div onclick="openModulePodcast('plexus-anatomy', 'plexus-anomalous')" style="
                                    background: #f8fafc; border: 1px solid #e2e8f0; border-radius: 6px; padding: 8px;
                                    cursor: pointer; transition: all 0.2s ease; display: flex; align-items: center; gap: 8px;"
                                    onmouseover="this.style.background='#eff6ff'; this.style.borderColor='#3b82f6'"
                                    onmouseout="this.style.background='#f8fafc'; this.style.borderColor='#e2e8f0'">
                                    <img src="ERNEST.png" style="width: 28px; height: 28px; border-radius: 50%; flex-shrink: 0; object-fit: cover;" alt="Ernest">
                                    <div style="flex: 1; min-width: 0;">
                                        <div style="font-size: 0.8em; font-weight: 600; color: #1e40af; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">Anomalous Anatomy</div>
                                        <div style="font-size: 0.7em; color: #64748b;">14:47</div>
                                    </div>
                                    <svg width="16" height="16" viewBox="0 0 16 16" fill="none" style="flex-shrink: 0;">
                                        <path d="M3 2L13 8L3 14V2Z" fill="#f59e0b"/>
                                    </svg>
                                </div>

                                <!-- Plexopathies -->
                                <div onclick="openModulePodcast('brachial-plexus', 'brachial-ep1')" style="
                                    background: #f8fafc; border: 1px solid #e2e8f0; border-radius: 6px; padding: 8px;
                                    cursor: pointer; transition: all 0.2s ease; display: flex; align-items: center; gap: 8px;"
                                    onmouseover="this.style.background='#eff6ff'; this.style.borderColor='#3b82f6'"
                                    onmouseout="this.style.background='#f8fafc'; this.style.borderColor='#e2e8f0'">
                                    <img src="ERNEST.png" style="width: 28px; height: 28px; border-radius: 50%; flex-shrink: 0; object-fit: cover;" alt="Ernest">
                                    <div style="flex: 1; min-width: 0;">
                                        <div style="font-size: 0.8em; font-weight: 600; color: #1e40af; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">Plexopathies</div>
                                        <div style="font-size: 0.7em; color: #64748b;">13:28</div>
                                    </div>
                                    <svg width="16" height="16" viewBox="0 0 16 16" fill="none" style="flex-shrink: 0;">
                                        <path d="M3 2L13 8L3 14V2Z" fill="#f59e0b"/>
                                    </svg>
                                </div>

                                <!-- Radiculopathy -->
                                <div onclick="openModulePodcast('radiculopathy', 'radiculopathy-ep1')" style="
                                    background: #f8fafc; border: 1px solid #e2e8f0; border-radius: 6px; padding: 8px;
                                    cursor: pointer; transition: all 0.2s ease; display: flex; align-items: center; gap: 8px;"
                                    onmouseover="this.style.background='#eff6ff'; this.style.borderColor='#3b82f6'"
                                    onmouseout="this.style.background='#f8fafc'; this.style.borderColor='#e2e8f0'">
                                    <img src="ERNEST.png" style="width: 28px; height: 28px; border-radius: 50%; flex-shrink: 0; object-fit: cover;" alt="Ernest">
                                    <div style="flex: 1; min-width: 0;">
                                        <div style="font-size: 0.8em; font-weight: 600; color: #1e40af; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">Radiculopathy</div>
                                        <div style="font-size: 0.7em; color: #64748b;">15:48</div>
                                    </div>
                                    <svg width="16" height="16" viewBox="0 0 16 16" fill="none" style="flex-shrink: 0;">
                                        <path d="M3 2L13 8L3 14V2Z" fill="#f59e0b"/>
                                    </svg>
                                </div>

                                <!-- Polyneuropathies -->
                                <div onclick="openModulePodcast('neuropathy-pathophysiology', 'neuropathy-poly')" style="
                                    background: #f8fafc; border: 1px solid #e2e8f0; border-radius: 6px; padding: 8px;
                                    cursor: pointer; transition: all 0.2s ease; display: flex; align-items: center; gap: 8px;"
                                    onmouseover="this.style.background='#eff6ff'; this.style.borderColor='#3b82f6'"
                                    onmouseout="this.style.background='#f8fafc'; this.style.borderColor='#e2e8f0'">
                                    <img src="ERNEST.png" style="width: 28px; height: 28px; border-radius: 50%; flex-shrink: 0; object-fit: cover;" alt="Ernest">
                                    <div style="flex: 1; min-width: 0;">
                                        <div style="font-size: 0.8em; font-weight: 600; color: #1e40af; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">Polyneuropathies</div>
                                        <div style="font-size: 0.7em; color: #64748b;">16:41</div>
                                    </div>
                                    <svg width="16" height="16" viewBox="0 0 16 16" fill="none" style="flex-shrink: 0;">
                                        <path d="M3 2L13 8L3 14V2Z" fill="#f59e0b"/>
                                    </svg>
                                </div>

                                <!-- Mononeuropathy -->
                                <div onclick="openModulePodcast('neuropathy-pathophysiology', 'neuropathy-mono')" style="
                                    background: #f8fafc; border: 1px solid #e2e8f0; border-radius: 6px; padding: 8px;
                                    cursor: pointer; transition: all 0.2s ease; display: flex; align-items: center; gap: 8px;"
                                    onmouseover="this.style.background='#eff6ff'; this.style.borderColor='#3b82f6'"
                                    onmouseout="this.style.background='#f8fafc'; this.style.borderColor='#e2e8f0'">
                                    <img src="ERNEST.png" style="width: 28px; height: 28px; border-radius: 50%; flex-shrink: 0; object-fit: cover;" alt="Ernest">
                                    <div style="flex: 1; min-width: 0;">
                                        <div style="font-size: 0.8em; font-weight: 600; color: #1e40af; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">Mononeuropathy</div>
                                        <div style="font-size: 0.7em; color: #64748b;">33:22</div>
                                    </div>
                                    <svg width="16" height="16" viewBox="0 0 16 16" fill="none" style="flex-shrink: 0;">
                                        <path d="M3 2L13 8L3 14V2Z" fill="#f59e0b"/>
                                    </svg>
                                </div>

                                <!-- Pattern Recognition -->
                                <div onclick="openModulePodcast('basic-patterns', 'patterns-ep1')" style="
                                    background: #f8fafc; border: 1px solid #e2e8f0; border-radius: 6px; padding: 8px;
                                    cursor: pointer; transition: all 0.2s ease; display: flex; align-items: center; gap: 8px;"
                                    onmouseover="this.style.background='#eff6ff'; this.style.borderColor='#3b82f6'"
                                    onmouseout="this.style.background='#f8fafc'; this.style.borderColor='#e2e8f0'">
                                    <img src="ERNEST.png" style="width: 28px; height: 28px; border-radius: 50%; flex-shrink: 0; object-fit: cover;" alt="Ernest">
                                    <div style="flex: 1; min-width: 0;">
                                        <div style="font-size: 0.8em; font-weight: 600; color: #1e40af; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">Pattern Recognition</div>
                                        <div style="font-size: 0.7em; color: #64748b;">14:59</div>
                                    </div>
                                    <svg width="16" height="16" viewBox="0 0 16 16" fill="none" style="flex-shrink: 0;">
                                        <path d="M3 2L13 8L3 14V2Z" fill="#f59e0b"/>
                                    </svg>
                                </div>

                                <!-- Neuropathy vs Myopathy -->
                                <div onclick="openModulePodcast('neuropathy-myopathy', 'neuro-myo-ep1')" style="
                                    background: #f8fafc; border: 1px solid #e2e8f0; border-radius: 6px; padding: 8px;
                                    cursor: pointer; transition: all 0.2s ease; display: flex; align-items: center; gap: 8px;"
                                    onmouseover="this.style.background='#eff6ff'; this.style.borderColor='#3b82f6'"
                                    onmouseout="this.style.background='#f8fafc'; this.style.borderColor='#e2e8f0'">
                                    <img src="ERNEST.png" style="width: 28px; height: 28px; border-radius: 50%; flex-shrink: 0; object-fit: cover;" alt="Ernest">
                                    <div style="flex: 1; min-width: 0;">
                                        <div style="font-size: 0.8em; font-weight: 600; color: #1e40af; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">Neuropathy vs Myopathy</div>
                                        <div style="font-size: 0.7em; color: #64748b;">17:09</div>
                                    </div>
                                    <svg width="16" height="16" viewBox="0 0 16 16" fill="none" style="flex-shrink: 0;">
                                        <path d="M3 2L13 8L3 14V2Z" fill="#f59e0b"/>
                                    </svg>
                                </div>

                                <!-- Report Writing -->
                                <div onclick="openModulePodcast('simple-reports', 'reports-ep1')" style="
                                    background: #f8fafc; border: 1px solid #e2e8f0; border-radius: 6px; padding: 8px;
                                    cursor: pointer; transition: all 0.2s ease; display: flex; align-items: center; gap: 8px;"
                                    onmouseover="this.style.background='#eff6ff'; this.style.borderColor='#3b82f6'"
                                    onmouseout="this.style.background='#f8fafc'; this.style.borderColor='#e2e8f0'">
                                    <img src="ERNEST.png" style="width: 28px; height: 28px; border-radius: 50%; flex-shrink: 0; object-fit: cover;" alt="Ernest">
                                    <div style="flex: 1; min-width: 0;">
                                        <div style="font-size: 0.8em; font-weight: 600; color: #1e40af; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">Report Writing</div>
                                        <div style="font-size: 0.7em; color: #64748b;">11:56</div>
                                    </div>
                                    <svg width="16" height="16" viewBox="0 0 16 16" fill="none" style="flex-shrink: 0;">
                                        <path d="M3 2L13 8L3 14V2Z" fill="#f59e0b"/>
                                    </svg>
                                </div>
                            </div>
                        </div>

                        <!-- Extra Topics Section -->
                        <div>
                            <h4 style="color: #a855f7; margin: 0 0 12px 0; font-size: 1em; border-bottom: 2px solid #e5e7eb; padding-bottom: 8px;">‚≠ê Advanced Topics</h4>

                            <!-- 3-Column Grid for Extra Topics -->
                            <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px;">
                                <!-- ALS and Mimics -->
                                <div onclick="window.playExtraPodcast('extra-als')" style="
                                    background: #faf5ff; border: 1px solid #e9d5ff; border-radius: 6px; padding: 8px;
                                    cursor: pointer; transition: all 0.2s ease; display: flex; align-items: center; gap: 8px;"
                                    onmouseover="this.style.background='#f3e8ff'; this.style.borderColor='#a855f7'"
                                    onmouseout="this.style.background='#faf5ff'; this.style.borderColor='#e9d5ff'">
                                    <img src="ERNEST.png" style="width: 28px; height: 28px; border-radius: 50%; flex-shrink: 0; object-fit: cover;" alt="Ernest">
                                    <div style="flex: 1; min-width: 0;">
                                        <div style="font-size: 0.8em; font-weight: 600; color: #7e22ce; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">ALS and Mimics</div>
                                        <div style="font-size: 0.7em; color: #64748b;">13:54</div>
                                    </div>
                                    <svg width="16" height="16" viewBox="0 0 16 16" fill="none" style="flex-shrink: 0;">
                                        <path d="M3 2L13 8L3 14V2Z" fill="#a855f7"/>
                                    </svg>
                                </div>

                                <!-- Blink Reflex -->
                                <div onclick="window.playExtraPodcast('extra-blink')" style="
                                    background: #faf5ff; border: 1px solid #e9d5ff; border-radius: 6px; padding: 8px;
                                    cursor: pointer; transition: all 0.2s ease; display: flex; align-items: center; gap: 8px;"
                                    onmouseover="this.style.background='#f3e8ff'; this.style.borderColor='#a855f7'"
                                    onmouseout="this.style.background='#faf5ff'; this.style.borderColor='#e9d5ff'">
                                    <img src="ERNEST.png" style="width: 28px; height: 28px; border-radius: 50%; flex-shrink: 0; object-fit: cover;" alt="Ernest">
                                    <div style="flex: 1; min-width: 0;">
                                        <div style="font-size: 0.8em; font-weight: 600; color: #7e22ce; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">Blink Reflex</div>
                                        <div style="font-size: 0.7em; color: #64748b;">14:14</div>
                                    </div>
                                    <svg width="16" height="16" viewBox="0 0 16 16" fill="none" style="flex-shrink: 0;">
                                        <path d="M3 2L13 8L3 14V2Z" fill="#a855f7"/>
                                    </svg>
                                </div>

                                <!-- NMJ Disorders -->
                                <div onclick="window.playExtraPodcast('extra-nmj')" style="
                                    background: #faf5ff; border: 1px solid #e9d5ff; border-radius: 6px; padding: 8px;
                                    cursor: pointer; transition: all 0.2s ease; display: flex; align-items: center; gap: 8px;"
                                    onmouseover="this.style.background='#f3e8ff'; this.style.borderColor='#a855f7'"
                                    onmouseout="this.style.background='#faf5ff'; this.style.borderColor='#e9d5ff'">
                                    <img src="ERNEST.png" style="width: 28px; height: 28px; border-radius: 50%; flex-shrink: 0; object-fit: cover;" alt="Ernest">
                                    <div style="flex: 1; min-width: 0;">
                                        <div style="font-size: 0.8em; font-weight: 600; color: #7e22ce; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">NMJ Disorders</div>
                                        <div style="font-size: 0.7em; color: #64748b;">16:00</div>
                                    </div>
                                    <svg width="16" height="16" viewBox="0 0 16 16" fill="none" style="flex-shrink: 0;">
                                        <path d="M3 2L13 8L3 14V2Z" fill="#a855f7"/>
                                    </svg>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Main Modules Container -->
                    <div class="modules-container">
                        <!-- Hero Module (EMG Introduction) -->
                        ${generateHeroModule()}

                        <!-- Grid of Modules 2-13 (12 icons in perfect 4x3 grid) -->
                        <div class="modules-grid">
                            ${generateGridModules()}
                        </div>
                    </div>
                </div>
            `;

            console.log('üîç DEBUG: Generated HTML length:', layoutHTML.length);

            // Set content
            boardContainer.innerHTML = layoutHTML;

            // Append ERNEST directly to body (not inside container)
            // Remove any existing ERNEST dialogue first
            const existingErnest = document.getElementById('ernest-dialogue');
            if (existingErnest) {
                existingErnest.remove();
            }
            // Add ERNEST to body
            document.body.insertAdjacentHTML('beforeend', generateERNESTDialogue());

            // Smooth fade-in animation
            setTimeout(() => {
                boardContainer.classList.add('pathway-loaded');
            }, 50);

            console.log('‚úÖ New Grid Layout Generated Successfully!');
        }

        // Generate Hero Module (Module 1 - EMG Introduction)
        // Generate Hero Module (Module 1 - EMG Introduction)
        function generateHeroModule() {
            const module = atriumModuleConfig[0]; // First module
            const desc = moduleDescriptions[1] || { title: module.title, text: "Start your EMG/NCS learning journey here.", highlights: "" };

            return `
                <div class="hero-module"
                     onmouseover="showModuleDescription(1)"
                     onmouseout="hideModuleDescription()"
                     onclick="openAtriumModule(1, '${module.id}')">
                    <div class="hero-content">
                        <img src="${module.customIcon}" alt="${module.title}" class="hero-icon">
                        <div class="hero-text">
                            <div class="hero-badge">üöÄ START HERE - Module 1</div>
                            <h2 class="hero-title">${module.title}</h2>
                            <p class="hero-description">${desc.text}</p>
                        </div>
                    </div>
                </div>
            `;
        }

        // Generate Grid Modules (Modules 2-13)
        function generateGridModules() {
            console.log('DEBUG: generateGridModules called');
            console.log('DEBUG: Config length:', atriumModuleConfig.length);
            let html = '';
            // Modules 2-13 (indices 1-12) - All 12 icons for perfect 4x3 grid
            for (let i = 1; i < atriumModuleConfig.length; i++) {
                const module = atriumModuleConfig[i];
                console.log(`DEBUG: Generating card for index ${i}: ${module.id}`);
                const moduleNumber = i + 1;

                html += `
                    <div class="module-card"
                         onmouseover="showModuleDescription(${moduleNumber})"
                         onmouseout="hideModuleDescription()"
                         onclick="openAtriumModule(${moduleNumber}, '${module.id}')">
                        <img src="${module.customIcon}"
                             alt="${module.title}"
                             class="module-icon">
                    </div>
                `;
            }
            return html;
        }

        // Generate Footer Module (Module 13 - Clinical Application)
        function generateFooterModule() {
            const module = atriumModuleConfig[12]; // Last module
            const desc = moduleDescriptions[13] || { title: module.title, text: "Apply your knowledge to real clinical scenarios.", highlights: "" };

            return `
                <div class="footer-module"
                     onmouseover="showModuleDescription(13)"
                     onmouseout="hideModuleDescription()"
                     onclick="openAtriumModule(13, '${module.id}')">
                    <div class="hero-content">
                        <img src="${module.customIcon}" alt="${module.title}" class="hero-icon">
                        <div class="hero-text">
                            <div class="hero-badge">üéì FINAL MODULE - Module 13</div>
                            <h2 class="hero-title">${module.title}</h2>
                            <p class="hero-description">${desc.text}</p>
                        </div>
                    </div>
                </div>
            `;
        }

        // Generate ERNEST Dialogue Box
        function generateERNESTDialogue() {
            return `
                <div id="ernest-dialogue" class="ernest-dialogue-box">
                    <div class="ernest-dialogue-content">
                        <img src="ERNEST.png" alt="ERNEST" class="ernest-avatar">
                        <div class="ernest-text">
                            <p class="ernest-name">ERNEST - Your EMG Guide</p>
                            <p id="ernest-message" class="ernest-message">Hover over any module to learn more about it!</p>
                            <p id="ernest-highlights" class="ernest-highlights"></p>
                        </div>
                    </div>
                </div>
            `;
        }

        // Generate Complete Podcast Library Section (All Episodes)
        function generateCompletePodcastLibrary() {
            return `
                <div class="complete-podcast-library" style="margin-top: 80px; padding: 50px 0; background: linear-gradient(135deg, #fafaf9, #f5f5f4); border-top: 3px solid #d4d4d8;">
                    <!-- Section Header -->
                    <div style="text-align: center; margin-bottom: 50px;">
                        <h2 style="color: #18181b; font-size: 2.5em; margin-bottom: 15px; font-weight: 800;">
                            üéôÔ∏è Complete Podcast Library
                        </h2>
                        <p style="color: #52525b; font-size: 1.2em; max-width: 800px; margin: 0 auto 10px;">
                            All of Ernest's podcast episodes in one place. Listen and learn at your own pace.
                        </p>
                        <p style="color: #71717a; font-size: 1em; max-width: 600px; margin: 0 auto;">
                            Total: 8 episodes ‚Ä¢ Combined duration: 4 hours 6 minutes
                        </p>
                    </div>

                    <!-- Module Podcasts Section -->
                    <div style="max-width: 1200px; margin: 0 auto 50px;">
                        <h3 style="color: #3b82f6; font-size: 1.8em; margin-bottom: 25px; text-align: center; font-weight: 700;">
                            üìö Core Module Podcasts
                        </h3>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 25px;">
                            <!-- Plexopathies -->
                            <div class="podcast-list-card" onclick="openModulePodcast('brachial-plexus', 'brachial-ep1')"
                                 style="background: white; border: 2px solid #e5e7eb; border-radius: 12px; padding: 25px; cursor: pointer; transition: all 0.3s ease; box-shadow: 0 2px 8px rgba(0,0,0,0.1);"
                                 onmouseover="this.style.transform='translateY(-5px)'; this.style.boxShadow='0 6px 20px rgba(59, 130, 246, 0.2)'; this.style.borderColor='#3b82f6'"
                                 onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 2px 8px rgba(0,0,0,0.1)'; this.style.borderColor='#e5e7eb'">
                                <div style="display: flex; align-items: center; margin-bottom: 15px;">
                                    <img src="ERNEST.png" style="width: 50px; height: 50px; border-radius: 50%; margin-right: 12px; border: 2px solid #3b82f6; object-fit: cover;" alt="Ernest">
                                    <div>
                                        <h4 style="color: #1e40af; margin: 0; font-size: 1.2em; font-weight: 600;">Plexopathies</h4>
                                        <p style="color: #64748b; margin: 3px 0 0 0; font-size: 0.85em;">Module 3 ‚Ä¢ 25 min</p>
                                    </div>
                                </div>
                                <p style="color: #475569; line-height: 1.5; margin: 0; font-size: 0.9em;">
                                    Brachial and lumbosacral plexus pathology, clinical syndromes, and electrodiagnostic evaluation
                                </p>
                            </div>

                            <!-- Radiculopathy -->
                            <div class="podcast-list-card" onclick="openModulePodcast('radiculopathy', 'radiculopathy-ep1')"
                                 style="background: white; border: 2px solid #e5e7eb; border-radius: 12px; padding: 25px; cursor: pointer; transition: all 0.3s ease; box-shadow: 0 2px 8px rgba(0,0,0,0.1);"
                                 onmouseover="this.style.transform='translateY(-5px)'; this.style.boxShadow='0 6px 20px rgba(59, 130, 246, 0.2)'; this.style.borderColor='#3b82f6'"
                                 onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 2px 8px rgba(0,0,0,0.1)'; this.style.borderColor='#e5e7eb'">
                                <div style="display: flex; align-items: center; margin-bottom: 15px;">
                                    <img src="ERNEST.png" style="width: 50px; height: 50px; border-radius: 50%; margin-right: 12px; border: 2px solid #3b82f6; object-fit: cover;" alt="Ernest">
                                    <div>
                                        <h4 style="color: #1e40af; margin: 0; font-size: 1.2em; font-weight: 600;">Radiculopathy</h4>
                                        <p style="color: #64748b; margin: 3px 0 0 0; font-size: 0.85em;">Module 4 ‚Ä¢ 19 min</p>
                                    </div>
                                </div>
                                <p style="color: #475569; line-height: 1.5; margin: 0; font-size: 0.9em;">
                                    Nerve root compression mechanisms, classic patterns, and EMG findings
                                </p>
                            </div>

                            <!-- Neuropathy Pathophysiology -->
                            <div class="podcast-list-card" onclick="openModulePodcast('neuropathy-pathophysiology', 'neuropathy-ep1')"
                                 style="background: white; border: 2px solid #e5e7eb; border-radius: 12px; padding: 25px; cursor: pointer; transition: all 0.3s ease; box-shadow: 0 2px 8px rgba(0,0,0,0.1);"
                                 onmouseover="this.style.transform='translateY(-5px)'; this.style.boxShadow='0 6px 20px rgba(59, 130, 246, 0.2)'; this.style.borderColor='#3b82f6'"
                                 onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 2px 8px rgba(0,0,0,0.1)'; this.style.borderColor='#e5e7eb'">
                                <div style="display: flex; align-items: center; margin-bottom: 15px;">
                                    <img src="ERNEST.png" style="width: 50px; height: 50px; border-radius: 50%; margin-right: 12px; border: 2px solid #3b82f6; object-fit: cover;" alt="Ernest">
                                    <div>
                                        <h4 style="color: #1e40af; margin: 0; font-size: 1.2em; font-weight: 600;">Neuropathy Pathophysiology</h4>
                                        <p style="color: #64748b; margin: 3px 0 0 0; font-size: 0.85em;">Module 5 ‚Ä¢ 61 min</p>
                                    </div>
                                </div>
                                <p style="color: #475569; line-height: 1.5; margin: 0; font-size: 0.9em;">
                                    Comprehensive exploration of peripheral neuropathy mechanisms and patterns
                                </p>
                            </div>

                            <!-- EMG Interpretation -->
                            <div class="podcast-list-card" onclick="openModulePodcast('basic-patterns', 'patterns-ep1')"
                                 style="background: white; border: 2px solid #e5e7eb; border-radius: 12px; padding: 25px; cursor: pointer; transition: all 0.3s ease; box-shadow: 0 2px 8px rgba(0,0,0,0.1);"
                                 onmouseover="this.style.transform='translateY(-5px)'; this.style.boxShadow='0 6px 20px rgba(59, 130, 246, 0.2)'; this.style.borderColor='#3b82f6'"
                                 onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 2px 8px rgba(0,0,0,0.1)'; this.style.borderColor='#e5e7eb'">
                                <div style="display: flex; align-items: center; margin-bottom: 15px;">
                                    <img src="ERNEST.png" style="width: 50px; height: 50px; border-radius: 50%; margin-right: 12px; border: 2px solid #3b82f6; object-fit: cover;" alt="Ernest">
                                    <div>
                                        <h4 style="color: #1e40af; margin: 0; font-size: 1.2em; font-weight: 600;">EMG Interpretation</h4>
                                        <p style="color: #64748b; margin: 3px 0 0 0; font-size: 0.85em;">Module 7 ‚Ä¢ 28 min</p>
                                    </div>
                                </div>
                                <p style="color: #475569; line-height: 1.5; margin: 0; font-size: 0.9em;">
                                    Systematic EMG interpretation and pattern recognition for common diagnoses
                                </p>
                            </div>

                            <!-- Myopathy vs Neuropathy -->
                            <div class="podcast-list-card" onclick="openModulePodcast('neuropathy-myopathy', 'neuro-myo-ep1')"
                                 style="background: white; border: 2px solid #e5e7eb; border-radius: 12px; padding: 25px; cursor: pointer; transition: all 0.3s ease; box-shadow: 0 2px 8px rgba(0,0,0,0.1);"
                                 onmouseover="this.style.transform='translateY(-5px)'; this.style.boxShadow='0 6px 20px rgba(59, 130, 246, 0.2)'; this.style.borderColor='#3b82f6'"
                                 onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 2px 8px rgba(0,0,0,0.1)'; this.style.borderColor='#e5e7eb'">
                                <div style="display: flex; align-items: center; margin-bottom: 15px;">
                                    <img src="ERNEST.png" style="width: 50px; height: 50px; border-radius: 50%; margin-right: 12px; border: 2px solid #3b82f6; object-fit: cover;" alt="Ernest">
                                    <div>
                                        <h4 style="color: #1e40af; margin: 0; font-size: 1.2em; font-weight: 600;">Myopathy vs. Neuropathy</h4>
                                        <p style="color: #64748b; margin: 3px 0 0 0; font-size: 0.85em;">Module 8 ‚Ä¢ 32 min</p>
                                    </div>
                                </div>
                                <p style="color: #475569; line-height: 1.5; margin: 0; font-size: 0.9em;">
                                    Differentiate nerve and muscle disorders using clinical and EDX features
                                </p>
                            </div>
                        </div>
                    </div>

                    <!-- Extra Topics Section -->
                    <div style="max-width: 1200px; margin: 0 auto;">
                        <h3 style="color: #a855f7; font-size: 1.8em; margin-bottom: 25px; text-align: center; font-weight: 700;">
                            ‚≠ê Advanced Topics
                        </h3>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 25px;">
                            <!-- ALS and Mimics -->
                            <div class="podcast-list-card" onclick="window.playExtraPodcast('extra-als')"
                                 style="background: white; border: 2px solid #e5e7eb; border-radius: 12px; padding: 25px; cursor: pointer; transition: all 0.3s ease; box-shadow: 0 2px 8px rgba(0,0,0,0.1);"
                                 onmouseover="this.style.transform='translateY(-5px)'; this.style.boxShadow='0 6px 20px rgba(168, 85, 247, 0.2)'; this.style.borderColor='#a855f7'"
                                 onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 2px 8px rgba(0,0,0,0.1)'; this.style.borderColor='#e5e7eb'">
                                <div style="display: flex; align-items: center; margin-bottom: 15px;">
                                    <img src="ERNEST.png" style="width: 50px; height: 50px; border-radius: 50%; margin-right: 12px; border: 2px solid #a855f7;" alt="Ernest">
                                    <div>
                                        <h4 style="color: #7e22ce; margin: 0; font-size: 1.2em; font-weight: 600;">ALS and Mimics</h4>
                                        <p style="color: #64748b; margin: 3px 0 0 0; font-size: 0.85em;">Extra Topics ‚Ä¢ 26 min</p>
                                    </div>
                                </div>
                                <p style="color: #475569; line-height: 1.5; margin: 0; font-size: 0.9em;">
                                    Motor neuron disease diagnosis and differentiating ALS from treatable mimics
                                </p>
                            </div>

                            <!-- Blink Reflex -->
                            <div class="podcast-list-card" onclick="window.playExtraPodcast('extra-blink')"
                                 style="background: white; border: 2px solid #e5e7eb; border-radius: 12px; padding: 25px; cursor: pointer; transition: all 0.3s ease; box-shadow: 0 2px 8px rgba(0,0,0,0.1);"
                                 onmouseover="this.style.transform='translateY(-5px)'; this.style.boxShadow='0 6px 20px rgba(168, 85, 247, 0.2)'; this.style.borderColor='#a855f7'"
                                 onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 2px 8px rgba(0,0,0,0.1)'; this.style.borderColor='#e5e7eb'">
                                <div style="display: flex; align-items: center; margin-bottom: 15px;">
                                    <img src="ERNEST.png" style="width: 50px; height: 50px; border-radius: 50%; margin-right: 12px; border: 2px solid #a855f7;" alt="Ernest">
                                    <div>
                                        <h4 style="color: #7e22ce; margin: 0; font-size: 1.2em; font-weight: 600;">Blink Reflex</h4>
                                        <p style="color: #64748b; margin: 3px 0 0 0; font-size: 0.85em;">Extra Topics ‚Ä¢ 26 min</p>
                                    </div>
                                </div>
                                <p style="color: #475569; line-height: 1.5; margin: 0; font-size: 0.9em;">
                                    Specialized NCS technique for evaluating trigeminal and facial nerve pathways
                                </p>
                            </div>

                            <!-- MG vs Lambert-Eaton -->
                            <div class="podcast-list-card" onclick="window.playExtraPodcast('extra-mg-lems')"
                                 style="background: white; border: 2px solid #e5e7eb; border-radius: 12px; padding: 25px; cursor: pointer; transition: all 0.3s ease; box-shadow: 0 2px 8px rgba(0,0,0,0.1);"
                                 onmouseover="this.style.transform='translateY(-5px)'; this.style.boxShadow='0 6px 20px rgba(168, 85, 247, 0.2)'; this.style.borderColor='#a855f7'"
                                 onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 2px 8px rgba(0,0,0,0.1)'; this.style.borderColor='#e5e7eb'">
                                <div style="display: flex; align-items: center; margin-bottom: 15px;">
                                    <img src="ERNEST.png" style="width: 50px; height: 50px; border-radius: 50%; margin-right: 12px; border: 2px solid #a855f7;" alt="Ernest">
                                    <div>
                                        <h4 style="color: #7e22ce; margin: 0; font-size: 1.2em; font-weight: 600;">MG vs. Lambert-Eaton</h4>
                                        <p style="color: #64748b; margin: 3px 0 0 0; font-size: 0.85em;">Extra Topics ‚Ä¢ 29 min</p>
                                    </div>
                                </div>
                                <p style="color: #475569; line-height: 1.5; margin: 0; font-size: 0.9em;">
                                    Compare and contrast these neuromuscular junction disorders
                                </p>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        // Generate Extra Topics Podcast Section
        function generateExtraTopicsSection() {
            return `
                <div class="extra-topics-section" style="margin-top: 60px; padding: 40px 0;">
                    <!-- Section Header -->
                    <div style="text-align: center; margin-bottom: 40px;">
                        <h2 style="color: #1e40af; font-size: 2.2em; margin-bottom: 15px; font-weight: 700;">
                            üéß Advanced Topics Podcast Library
                        </h2>
                        <p style="color: #64748b; font-size: 1.1em; max-width: 700px; margin: 0 auto;">
                            Deep dives into specialized electrodiagnostic topics with Ernest. Expand your knowledge beyond the core curriculum.
                        </p>
                    </div>

                    <!-- Podcast Cards Grid -->
                    <div class="podcast-grid" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; max-width: 1200px; margin: 0 auto;">
                        <!-- ALS and Mimics -->
                        <div class="podcast-card" onclick="window.playExtraPodcast('extra-als')"
                             style="background: linear-gradient(135deg, #fef2f2, #fee2e2);
                                    border: 2px solid #dc2626;
                                    border-radius: 15px;
                                    padding: 30px;
                                    cursor: pointer;
                                    transition: all 0.3s ease;
                                    box-shadow: 0 4px 15px rgba(220, 38, 38, 0.2);"
                             onmouseover="this.style.transform='translateY(-8px)'; this.style.boxShadow='0 8px 25px rgba(220, 38, 38, 0.3)'"
                             onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 15px rgba(220, 38, 38, 0.2)'">
                            <div style="display: flex; align-items: center; margin-bottom: 20px;">
                                <img src="ERNEST.png" style="width: 60px; height: 60px; border-radius: 50%; margin-right: 15px; border: 3px solid #dc2626;" alt="Ernest">
                                <div>
                                    <h3 style="color: #991b1b; margin: 0; font-size: 1.4em; font-weight: 600;">ALS and Mimics</h3>
                                    <p style="color: #b91c1c; margin: 5px 0 0 0; font-size: 0.9em;">Duration: 26 minutes</p>
                                </div>
                            </div>
                            <p style="color: #7f1d1d; line-height: 1.6; margin-bottom: 15px;">
                                Explore motor neuron disease diagnosis and learn to differentiate ALS from treatable mimics using clinical and electrodiagnostic features.
                            </p>
                            <div style="display: flex; align-items: center; color: #dc2626; font-weight: 600;">
                                <svg width="14" height="14" viewBox="0 0 16 16" fill="none" style="margin-right: 8px; vertical-align: middle;">
                                    <path d="M3 2L13 8L3 14V2Z" fill="currentColor"/>
                                </svg> Listen Now
                            </div>
                        </div>

                        <!-- Blink Reflex -->
                        <div class="podcast-card" onclick="window.playExtraPodcast('extra-blink')"
                             style="background: linear-gradient(135deg, #f0f9ff, #e0f2fe);
                                    border: 2px solid #0ea5e9;
                                    border-radius: 15px;
                                    padding: 30px;
                                    cursor: pointer;
                                    transition: all 0.3s ease;
                                    box-shadow: 0 4px 15px rgba(14, 165, 233, 0.2);"
                             onmouseover="this.style.transform='translateY(-8px)'; this.style.boxShadow='0 8px 25px rgba(14, 165, 233, 0.3)'"
                             onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 15px rgba(14, 165, 233, 0.2)'">
                            <div style="display: flex; align-items: center; margin-bottom: 20px;">
                                <img src="ERNEST.png" style="width: 60px; height: 60px; border-radius: 50%; margin-right: 15px; border: 3px solid #0ea5e9;" alt="Ernest">
                                <div>
                                    <h3 style="color: #075985; margin: 0; font-size: 1.4em; font-weight: 600;">Blink Reflex</h3>
                                    <p style="color: #0369a1; margin: 5px 0 0 0; font-size: 0.9em;">Duration: 26 minutes</p>
                                </div>
                            </div>
                            <p style="color: #0c4a6e; line-height: 1.6; margin-bottom: 15px;">
                                Master this specialized NCS technique for evaluating trigeminal and facial nerve pathways. Learn technical aspects and clinical applications.
                            </p>
                            <div style="display: flex; align-items: center; color: #0ea5e9; font-weight: 600;">
                                <svg width="14" height="14" viewBox="0 0 16 16" fill="none" style="margin-right: 8px; vertical-align: middle;">
                                    <path d="M3 2L13 8L3 14V2Z" fill="currentColor"/>
                                </svg> Listen Now
                            </div>
                        </div>

                        <!-- MG vs Lambert-Eaton -->
                        <div class="podcast-card" onclick="window.playExtraPodcast('extra-mg-lems')"
                             style="background: linear-gradient(135deg, #f3e8ff, #e9d5ff);
                                    border: 2px solid #a855f7;
                                    border-radius: 15px;
                                    padding: 30px;
                                    cursor: pointer;
                                    transition: all 0.3s ease;
                                    box-shadow: 0 4px 15px rgba(168, 85, 247, 0.2);"
                             onmouseover="this.style.transform='translateY(-8px)'; this.style.boxShadow='0 8px 25px rgba(168, 85, 247, 0.3)'"
                             onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 15px rgba(168, 85, 247, 0.2)'">
                            <div style="display: flex; align-items: center; margin-bottom: 20px;">
                                <img src="ERNEST.png" style="width: 60px; height: 60px; border-radius: 50%; margin-right: 15px; border: 3px solid #a855f7;" alt="Ernest">
                                <div>
                                    <h3 style="color: #6b21a8; margin: 0; font-size: 1.4em; font-weight: 600;">MG vs. Lambert-Eaton</h3>
                                    <p style="color: #7e22ce; margin: 5px 0 0 0; font-size: 0.9em;">Duration: 29 minutes</p>
                                </div>
                            </div>
                            <p style="color: #581c87; line-height: 1.6; margin-bottom: 15px;">
                                Compare and contrast these neuromuscular junction disorders. Learn the distinctive clinical, electrodiagnostic, and treatment features of each.
                            </p>
                            <div style="display: flex; align-items: center; color: #a855f7; font-weight: 600;">
                                <svg width="14" height="14" viewBox="0 0 16 16" fill="none" style="margin-right: 8px; vertical-align: middle;">
                                    <path d="M3 2L13 8L3 14V2Z" fill="currentColor"/>
                                </svg> Listen Now
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        // Open Module with Modal Integration
        async function openAtriumModule(moduleNumber, moduleId) {
            console.log(`üéì Opening Module ${moduleNumber}: ${moduleId}`);

            // Use module loader for dynamic loading on ALL devices (including iOS)
            const module = { contentId: moduleId, id: moduleId };

            try {
                // Try to load module dynamically
                if (window.moduleLoader) {
                    console.log(`üì¶ Loading module dynamically: ${moduleId}`);
                    const loadedModule = await window.moduleLoader.loadModule(moduleId);

                    if (loadedModule && loadedModule.generateContent) {
                        const content = loadedModule.generateContent(module);
                        if (content && typeof window.showModal === 'function') {
                            window.showModal(`Module ${moduleNumber}: ${atriumModuleConfig[moduleNumber - 1].title}`, content);
                            console.log(`‚úÖ Module ${moduleNumber} loaded dynamically`);
                        } else {
                            throw new Error('No content generated');
                        }
                    } else {
                        throw new Error('Module or generateContent not found');
                    }
                } else {
                    // Fallback to original method if module loader not available
                    console.log('‚ö†Ô∏è Module loader not available, using fallback');
                    if (typeof generateLearningContentByType === 'function') {
                        const content = generateLearningContentByType(module, moduleNumber - 1);
                        if (content && typeof window.showModal === 'function') {
                            window.showModal(`Module ${moduleNumber}: ${atriumModuleConfig[moduleNumber - 1].title}`, content);
                            console.log(`‚úÖ Module ${moduleNumber} opened successfully (fallback)`);
                        } else {
                            showFallbackContent(moduleNumber, moduleId);
                        }
                    } else {
                        showFallbackContent(moduleNumber, moduleId);
                    }
                }
            } catch (error) {
                console.error(`‚ùå Error opening module ${moduleNumber}:`, error);
                // Fallback to original method on error
                try {
                    if (typeof generateLearningContentByType === 'function') {
                        const content = generateLearningContentByType(module, moduleNumber - 1);
                        if (content && typeof window.showModal === 'function') {
                            window.showModal(`Module ${moduleNumber}: ${atriumModuleConfig[moduleNumber - 1].title}`, content);
                        } else {
                            showFallbackContent(moduleNumber, moduleId);
                        }
                    } else {
                        showFallbackContent(moduleNumber, moduleId);
                    }
                } catch (fallbackError) {
                    console.error('‚ùå Fallback also failed:', fallbackError);
                    showFallbackContent(moduleNumber, moduleId);
                }
            }
        }

        // Open module in new tab (iOS workaround for zoom crash)
        async function openModuleInNewTab(moduleNumber, moduleId) {
            const module = { contentId: moduleId, id: moduleId };

            try {
                // Use module loader to get content dynamically
                let content = '';
                if (window.moduleLoader) {
                    const loadedModule = await window.moduleLoader.loadModule(moduleId);
                    if (loadedModule && loadedModule.generateContent) {
                        content = loadedModule.generateContent(module);
                    } else {
                        throw new Error('Module not found or no content generator');
                    }
                } else if (typeof generateLearningContentByType === 'function') {
                    content = generateLearningContentByType(module, moduleNumber - 1);
                } else {
                    throw new Error('No content generation method available');
                }

                if (!content) {
                    throw new Error('No content generated');
                }

                const moduleTitle = atriumModuleConfig[moduleNumber - 1].title;

                // Get base URL for script paths
                const baseURL = window.location.origin + window.location.pathname.substring(0, window.location.pathname.lastIndexOf('/') + 1);

                // Create standalone HTML page using string concatenation to avoid template literal issues
                const newTabHTML = '<!DOCTYPE html>\n' +
                    '<html lang="en">\n' +
                    '<head>\n' +
                    '    <meta charset="UTF-8">\n' +
                    '    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes">\n' +
                    '    <title>Module ' + moduleNumber + ': ' + moduleTitle + '</title>\n' +
                    '    <base href="' + baseURL + '">\n' +
                    '    <style>\n' +
                    '        * { box-sizing: border-box; }\n' +
                    '        body {\n' +
                    '            font-family: \'Segoe UI\', Tahoma, Geneva, Verdana, sans-serif;\n' +
                    '            line-height: 1.8;\n' +
                    '            color: #1f2937;\n' +
                    '            background: linear-gradient(135deg, #fdfcf8 0%, #f9f7f1 100%);\n' +
                    '            margin: 0;\n' +
                    '            padding: 20px;\n' +
                    '            font-size: 18px;\n' +
                    '        }\n' +
                    '        .module-header {\n' +
                    '            background: linear-gradient(135deg, #4f46e5, #6366f1);\n' +
                    '            color: white;\n' +
                    '            padding: 25px;\n' +
                    '            border-radius: 15px;\n' +
                    '            margin-bottom: 25px;\n' +
                    '            box-shadow: 0 4px 20px rgba(79, 70, 229, 0.3);\n' +
                    '        }\n' +
                    '        .module-header h1 { margin: 0 0 10px 0; font-size: 1.8em; }\n' +
                    '        .back-button {\n' +
                    '            display: inline-block;\n' +
                    '            background: white;\n' +
                    '            color: #4f46e5;\n' +
                    '            padding: 12px 24px;\n' +
                    '            border-radius: 25px;\n' +
                    '            text-decoration: none;\n' +
                    '            font-weight: 600;\n' +
                    '            margin-top: 15px;\n' +
                    '            box-shadow: 0 2px 10px rgba(0,0,0,0.1);\n' +
                    '        }\n' +
                    '        .content-wrapper {\n' +
                    '            background: white;\n' +
                    '            padding: 30px;\n' +
                    '            border-radius: 15px;\n' +
                    '            box-shadow: 0 2px 20px rgba(0,0,0,0.08);\n' +
                    '            max-width: 900px;\n' +
                    '            margin: 0 auto;\n' +
                    '            overflow: hidden;\n' +
                    '        }\n' +
                    '        /* Mobile-optimized column layout - stack vertically */\n' +
                    '        .content-wrapper .study-section,\n' +
                    '        .content-wrapper .two-column-layout {\n' +
                    '            display: block !important;\n' +
                    '            width: 100% !important;\n' +
                    '        }\n' +
                    '        .content-wrapper .study-column,\n' +
                    '        .content-wrapper [style*="flex: 1"],\n' +
                    '        .content-wrapper [style*="width: 48%"],\n' +
                    '        .content-wrapper [style*="width: 50%"] {\n' +
                    '            display: block !important;\n' +
                    '            width: 100% !important;\n' +
                    '            max-width: 100% !important;\n' +
                    '            margin-bottom: 20px !important;\n' +
                    '            word-wrap: break-word;\n' +
                    '            overflow-wrap: break-word;\n' +
                    '        }\n' +
                    '        /* Ensure flex and grid containers don\'t break */\n' +
                    '        .content-wrapper [style*="display: grid"],\n' +
                    '        .content-wrapper [style*="display: flex"] {\n' +
                    '            display: block !important;\n' +
                    '        }\n' +
                    '        .content-wrapper img, .content-wrapper table { max-width: 100%; height: auto; }\n' +
                    '    </style>\n' +
                    '</head>\n' +
                    '<body>\n' +
                    '    <div class="module-header">\n' +
                    '        <h1>üìö Module ' + moduleNumber + ': ' + moduleTitle + '</h1>\n' +
                    '        <p style="margin: 0; opacity: 0.9;">EMG/NCS Learning Journey</p>\n' +
                    '        <a href="#" onclick="window.close(); return false;" class="back-button">‚Üê Close & Return to Journey</a>\n' +
                    '    </div>\n' +
                    '    <div class="content-wrapper">\n' +
                    content +
                    '\n    </div>\n' +
                    '\n' +
                    '    <!-- Lightweight interactive stubs for mobile - avoids loading 976KB file -->\n' +
                    '    <script>\n' +
                    '        // Stub functions that redirect back to main page for interactive features\n' +
                    '        window.showStudyCards = function() {\n' +
                    '            if (confirm(\'üì± Interactive features work best on the main page.\\n\\nWould you like to close this tab and return to the main page to use NCS Study Cards?\')) {\n' +
                    '                window.close();\n' +
                    '            }\n' +
                    '        };\n' +
                    '        \n' +
                    '        window.showEMGChallenge = function() {\n' +
                    '            if (confirm(\'üì± Interactive features work best on the main page.\\n\\nWould you like to close this tab and return to the main page to use the EMG Challenge?\')) {\n' +
                    '                window.close();\n' +
                    '            }\n' +
                    '        };\n' +
                    '        \n' +
                    '        window.launchEMGApp = function(caseId) {\n' +
                    '            if (confirm(\'üì± Interactive features work best on the main page.\\n\\nWould you like to close this tab and return to the main page to launch this EMG case?\')) {\n' +
                    '                window.close();\n' +
                    '            }\n' +
                    '        };\n' +
                    '        \n' +
                    '        window.openBrachialPlexusModal = function() {\n' +
                    '            if (confirm(\'üì± Interactive features work best on the main page.\\n\\nWould you like to close this tab and return to the main page for the interactive Brachial Plexus?\')) {\n' +
                    '                window.close();\n' +
                    '            }\n' +
                    '        };\n' +
                    '        \n' +
                    '        console.log(\'üì± Mobile-optimized stubs loaded. Interactive features redirect to main page.\');\n' +
                    '    </' + 'script>\n' +
                    '</body>\n' +
                    '</html>';

                // Open in new tab
                const newTab = window.open('', '_blank');
                if (newTab) {
                    newTab.document.write(newTabHTML);
                    newTab.document.close();
                    console.log(`‚úÖ Module ${moduleNumber} opened in new tab`);
                } else {
                    alert('Please allow pop-ups to view learning modules on mobile.');
                }
            } catch (error) {
                console.error(`‚ùå Error opening module ${moduleNumber} in new tab:`, error);
                alert('Error loading module content. Please try again.');
            }
        }

        // Fallback content if modal generators fail
        function showFallbackContent(moduleNumber, moduleId) {
            if (typeof window.showModal === 'function') {
                window.showModal(`Module ${moduleNumber}`, `
                    <div style="text-align: center; padding: 40px;">
                        <div style="font-size: 3em; margin-bottom: 20px;">‚ö†Ô∏è</div>
                        <h3>Content Loading Error</h3>
                        <p>Unable to load content for this module.</p>
                        <p><strong>Module:</strong> ${moduleId}</p>
                        <p>Please check that all required JavaScript files are loaded.</p>
                    </div>
                `);
            }
        }

        // Dynamic Module Description System
        const moduleDescriptions = {
            1: {
                title: "EMG/NCS Introduction",
                text: "Master the fundamental principles of electrodiagnostic medicine! This comprehensive module covers patient preparation, safety protocols, basic neurophysiology, and the clinical applications that make EMG/NCS an essential diagnostic tool.",
                highlights: "Topics: Patient care, safety, basic principles, clinical applications"
            },
            2: {
                title: "Peripheral Anatomy",
                text: "Build your anatomical foundation with detailed nerve pathway mapping. Learn the complex relationships between peripheral nerves, muscles, and clinical presentations to become an expert diagnostician.",
                highlights: "Topics: Nerve anatomy, muscle innervation, anatomical variations"
            },
            3: {
                title: "Plexus Anatomy",
                text: "Explore the complex nerve networks of the body! This interactive module covers both Brachial and Lumbosacral plexuses, helping you visualize anatomy, trace pathways, and understand injury patterns.",
                highlights: "Topics: Brachial & Lumbosacral anatomy, interactive tracing, injury patterns"
            },
            4: {
                title: "Radiculopathy Pathophysiology",
                text: "Understand the mechanisms behind nerve root compression and irritation. Learn to differentiate radiculopathy from other conditions and master the EMG/NCS findings that confirm your diagnosis.",
                highlights: "Topics: Nerve root compression, differential diagnosis, EMG patterns"
            },
            5: {
                title: "Neuropathy Pathophysiology",
                text: "Distinguish between axonal and demyelinating processes with confidence! This fundamental knowledge shapes your entire approach to peripheral nerve disorders and treatment planning.",
                highlights: "Topics: Axonal vs demyelinating, pathophysiology, treatment implications"
            },
            6: {
                title: "NCS Fundamentals",
                text: "Dive deep into nerve conduction studies! Master electrode placement, stimulation techniques, measurement interpretation, and learn to differentiate normal from pathological findings.",
                highlights: "Topics: Electrode placement, stimulation, normal values, interpretation"
            },
            7: {
                title: "NCS Techniques",
                text: "Perfect your technical skills with advanced nerve conduction study techniques. Learn troubleshooting strategies, optimal positioning, and how to obtain reliable, reproducible results.",
                highlights: "Topics: Advanced techniques, troubleshooting, quality control"
            },
            8: {
                title: "EMG Needle Localization",
                text: "Master precise needle electrode placement using anatomical landmarks. Learn safe insertion techniques, avoid complications, and ensure accurate muscle sampling for reliable results.",
                highlights: "Topics: Needle placement, anatomical landmarks, safety protocols"
            },
            9: {
                title: "Muscle Study Laboratory",
                text: "Explore comprehensive muscle anatomy with our advanced Preston & Shapiro laboratory database. Interactive muscle exploration with detailed anatomical references and clinical correlations.",
                highlights: "Topics: Muscle anatomy, Preston & Shapiro database, interactive learning"
            },
            10: {
                title: "Basic Pattern Recognition",
                text: "Develop your pattern recognition skills for abnormal spontaneous activity. Learn to identify fibrillations, positive sharp waves, fasciculations, and other key EMG findings.",
                highlights: "Topics: Spontaneous activity, pattern recognition, EMG waveforms"
            },
            11: {
                title: "Neuropathy vs Myopathy",
                text: "Master the critical distinction between nerve and muscle disorders. Learn the EMG/NCS patterns that differentiate neuropathies from myopathies and guide appropriate treatment.",
                highlights: "Topics: Differential diagnosis, EMG patterns, clinical implications"
            },
            12: {
                title: "Basic Report Writing",
                text: "Learn to write clear, clinically relevant EMG/NCS reports. Understand report structure, proper terminology, and how to communicate findings effectively to referring physicians.",
                highlights: "Topics: Report structure, medical terminology, clinical communication"
            },
            13: {
                title: "Clinical Application",
                text: "Apply everything you've learned with real clinical scenarios and comprehensive case studies. Practice the complete EMG/NCS workflow from history to final diagnosis.",
                highlights: "Topics: Clinical cases, workflow, diagnostic reasoning, real scenarios"
            }
        };


        // Global variables for ERNEST system
        let hideTimer = null;


        // NEW ERNEST RPG-STYLE DIALOGUE FUNCTIONS

        function showModuleDescription(moduleNumber) {
            // Cancel any pending hide timer
            if (hideTimer) {
                clearTimeout(hideTimer);
                hideTimer = null;
            }

            // Get module description
            const desc = moduleDescriptions[moduleNumber] || {
                title: `Module ${moduleNumber}`,
                text: "Hover over modules to learn more!",
                highlights: ""
            };

            // Update ERNEST dialogue content
            const ernestMessage = document.getElementById('ernest-message');
            const ernestHighlights = document.getElementById('ernest-highlights');
            const ernestDialogue = document.getElementById('ernest-dialogue');

            if (ernestMessage && ernestDialogue) {
                ernestMessage.textContent = desc.text;
                if (ernestHighlights) {
                    ernestHighlights.textContent = desc.highlights;
                }
                // Slide up ERNEST dialogue
                ernestDialogue.classList.add('show');
            }
        }

        function hideModuleDescription() {
            // Clear any existing timer
            if (hideTimer) {
                clearTimeout(hideTimer);
            }

            // Set 2-second delay before hiding ERNEST
            hideTimer = setTimeout(() => {
                const ernestDialogue = document.getElementById('ernest-dialogue');
                if (ernestDialogue) {
                    // Slide down ERNEST dialogue
                    ernestDialogue.classList.remove('show');
                }
                hideTimer = null;
            }, 2000); // 2 seconds - better timing
        }






        // Override the existing generateLearningBoard function
        window.generateLearningBoard = generateAtriumPathway;

        // Make sure all functions are available globally
        // window.startAtriumJourney is already defined earlier in the script
        window.showModuleDescription = showModuleDescription;
        window.hideModuleDescription = hideModuleDescription;

        // Tab Navigation Function for Enhanced EMG Introduction
        function showEMGSection(sectionName) {
            console.log('üîÑ Switching to EMG section:', sectionName);

            // Hide all EMG sections
            const sections = document.querySelectorAll('.emg-section');
            sections.forEach(section => {
                section.style.display = 'none';
            });

            // Show the selected section
            const targetSection = document.getElementById(sectionName + '-section');
            if (targetSection) {
                targetSection.style.display = 'block';
            }

            // Update tab styling
            const tabs = document.querySelectorAll('.emg-tab');
            tabs.forEach(tab => {
                tab.style.background = 'transparent';
                tab.style.color = '#64748b';
            });

            // Highlight active tab
            const activeTab = document.getElementById(sectionName + '-tab');
            if (activeTab) {
                activeTab.style.background = '#3b82f6';
                activeTab.style.color = 'white';
            }

            console.log('‚úÖ EMG section switched to:', sectionName);
        }



        // Toggle Collapsible Podcasts Section
        function togglePodcastsCollapsible() {
            const container = document.getElementById('podcasts-collapsible-container');
            const icon = document.getElementById('podcast-toggle-icon');

            if (container.style.display === 'none' || container.style.display === '') {
                container.style.display = 'block';
                icon.textContent = '‚ñ≤';
                icon.style.transform = 'rotate(180deg)';
                console.log('üéß Expanded podcast list');
            } else {
                container.style.display = 'none';
                icon.textContent = '‚ñº';
                icon.style.transform = 'rotate(0deg)';
                console.log('üéß Collapsed podcast list');
            }
        }

        // Make functions globally available
        window.generateAtriumPathway = generateAtriumPathway;
        window.openAtriumModule = openAtriumModule;
        window.showModuleDescription = showModuleDescription;
        window.hideModuleDescription = hideModuleDescription;
        window.showEMGSection = showEMGSection;

        window.togglePodcastsCollapsible = togglePodcastsCollapsible;

        console.log('‚ú®üéÆ Enhanced Journey with Integrated Modal System - Ready!');
    </script>

    <!-- General Modal for Clinical Cases -->
    <div id="modal-overlay"
        style="position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; background: rgba(0,0,0,0.9); z-index: 10000; display: none; justify-content: center; align-items: center; overflow-y: auto;">
        <div
            style="background: white; border-radius: 15px; width: 95%; max-width: 1200px; max-height: 95vh; overflow-y: auto; position: relative; margin: 20px; box-shadow: 0 20px 60px rgba(0,0,0,0.3);">
            <div
                style="padding: 25px; border-bottom: 2px solid #e5e7eb; background: linear-gradient(135deg, #f3f4f6, #e5e7eb); border-radius: 15px 15px 0 0;">
                <h2 id="modal-title" style="margin: 0; color: #1f2937; font-size: 24px; font-weight: 700;"></h2>
                <button onclick="closeGeneralModal()"
                    style="position: absolute; top: 20px; right: 20px; background: #ef4444; color: white; border: none; font-size: 20px; cursor: pointer; width: 35px; height: 35px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold; transition: all 0.2s;">√ó</button>
            </div>
            <div id="modal-body" style="padding: 30px; background: white; border-radius: 0 0 15px 15px;">
            </div>
        </div>
    </div>

    <!-- Description Panel Now Generated in Pathway HTML -->

    <!-- New UI Layout System - DISABLED (using custom Atrium Health system) -->
    <!-- <script src="js/new-ui-layout.js"></script> -->

    <script>
        function closeGeneralModal() {
            const overlay = document.getElementById('modal-overlay');
            if (overlay) {
                // Fade out with transition
                overlay.classList.remove('show');

                // Hide after animation completes (increased to match slower transition)
                setTimeout(() => {
                    overlay.style.display = 'none';
                }, 700);

                console.log('üîí Modal closed with transition');
            }
        }

        // Add CSS styles for modal and transitions
        const modalStyles = document.createElement('style');
        modalStyles.textContent = `
            /* Page transition effects */
            .page-transition {
                transition: all 0.8s cubic-bezier(0.4, 0, 0.2, 1);
            }

            .blur-out {
                filter: blur(20px);
                opacity: 0.3;
                transform: scale(0.95);
            }

            #modal-overlay {
                opacity: 0;
                backdrop-filter: blur(0px);
                transition: opacity 0.6s ease, backdrop-filter 0.6s ease;
            }

            #modal-overlay.show {
                opacity: 1;
                backdrop-filter: blur(8px);
            }

            #modal-overlay > div {
                opacity: 0;
                transform: scale(0.9) translateY(40px);
                transition: opacity 0.5s ease 0.2s, transform 0.5s cubic-bezier(0.4, 0, 0.2, 1) 0.2s;
            }

            #modal-overlay.show > div {
                opacity: 1;
                transform: scale(1) translateY(0);
            }

            #modal-overlay button:hover {
                background: #dc2626 !important;
                transform: scale(1.1);
            }

            #modal-overlay .interactive-content {
                max-width: 100%;
                margin: 0;
            }

            #modal-overlay .quiz-section {
                margin-bottom: 20px;
            }

            /* Transition for main content */
            #learning-board, #pgy-selection {
                transition: filter 0.6s ease, opacity 0.6s ease, transform 0.6s ease;
            }
        `;
        document.head.appendChild(modalStyles);

        // Close modal when clicking outside overlay
        document.addEventListener('DOMContentLoaded', function () {
            const overlay = document.getElementById('modal-overlay');
            if (overlay) {
                overlay.addEventListener('click', function (e) {
                    // Check if click came from modal content by traversing up the DOM
                    let element = e.target;
                    while (element && element !== overlay) {
                        if (element.hasAttribute && element.hasAttribute('data-modal-content')) {
                            // Click is from modal content, don't close
                            return;
                        }
                        element = element.parentElement;
                    }

                    // Click is on overlay itself, close modal
                    if (e.target === overlay) {
                        closeGeneralModal();
                    }
                });
            }
        });

        // Add keyboard support for ESC key
        document.addEventListener('keydown', function (e) {
            if (e.key === 'Escape') {
                const overlay = document.getElementById('modal-overlay');
                if (overlay && overlay.style.display === 'flex') {
                    closeGeneralModal();
                }
            }
        });

        // Learning Objectives Modal Functions - Global Scope
        window.showLearningObjectives = function () {
            console.log('üéØ showLearningObjectives called');
            const modal = document.getElementById('learning-objectives-modal');
            console.log('üìã Modal element:', modal);
            if (modal) {
                console.log('‚úÖ Modal found, displaying...');
                modal.style.display = 'flex';
                document.body.style.overflow = 'hidden';
            } else {
                console.error('‚ùå Modal not found!');
            }
        };

        window.closeLearningObjectives = function () {
            console.warn('üö® closeLearningObjectives() CALLED');
            console.warn('üìç Call stack:', new Error().stack);

            const modal = document.getElementById('learning-objectives-modal');
            if (modal) {
                console.warn('‚úÖ Learning objectives modal found, hiding it');
                modal.style.display = 'none';
                document.body.style.overflow = 'auto';
            } else {
                console.warn('‚ùå Learning objectives modal NOT found');
            }
        };

        // Close modal when clicking outside content (with zoom gesture detection + DEBUG LOGGING)
        document.addEventListener('DOMContentLoaded', function () {
            const modal = document.getElementById('learning-objectives-modal');
            if (modal) {
                let touchStartTime = 0;
                let touchStartDistance = 0;

                // Track touch start for gesture detection
                modal.addEventListener('touchstart', function (e) {
                    touchStartTime = Date.now();
                    console.warn('üì± LEARNING-OBJ touchstart:', {
                        touches: e.touches.length,
                        target: e.target.tagName,
                        targetClass: e.target.className,
                        timestamp: touchStartTime
                    });

                    // If multi-touch, likely a zoom gesture
                    if (e.touches && e.touches.length > 1) {
                        const dx = e.touches[0].clientX - e.touches[1].clientX;
                        const dy = e.touches[0].clientY - e.touches[1].clientY;
                        touchStartDistance = Math.sqrt(dx * dx + dy * dy);
                        console.warn('üîç LEARNING-OBJ MULTI-TOUCH:', {
                            distance: touchStartDistance,
                            touches: e.touches.length
                        });
                    } else {
                        touchStartDistance = 0;
                    }
                }, { passive: true });

                modal.addEventListener('click', function (e) {
                    // Only close if:
                    // 1. Click target is the modal overlay itself (not modal content)
                    // 2. Touch duration was reasonable (< 300ms suggests intentional tap)
                    // 3. No multi-touch detected (zoom gesture)
                    const touchDuration = Date.now() - touchStartTime;
                    const isModal = e.target === modal;
                    const isQuickTap = touchDuration < 300;
                    const isSingleTouch = touchStartDistance === 0;

                    console.warn('üëÜ LEARNING-OBJ click event:', {
                        target: e.target.tagName,
                        targetClass: e.target.className,
                        isModal: isModal,
                        touchDuration: touchDuration,
                        isQuickTap: isQuickTap,
                        touchStartDistance: touchStartDistance,
                        isSingleTouch: isSingleTouch,
                        willClose: isModal && isQuickTap && isSingleTouch
                    });

                    if (isModal && isQuickTap && isSingleTouch) {
                        console.warn('üö™ CLOSING learning objectives modal');
                        window.closeLearningObjectives();
                    } else {
                        console.warn('‚úã NOT closing learning objectives - conditions not met');
                    }

                    // Reset for next interaction
                    touchStartTime = 0;
                    touchStartDistance = 0;
                });
            }
        });
    </script>

    <!-- Learning Objectives Modal -->
    <div id="learning-objectives-modal" class="modal-overlay" style="display: none;">
        <div class="modal-content learning-objectives-content">
            <div class="modal-header">
                <h2 class="modal-title">EMG/NCS Learning Objectives</h2>
                <button class="modal-close" onclick="closeLearningObjectives()">&times;</button>
            </div>
            <div class="modal-body">
                <!-- PGY-2 Section (Prominent) -->
                <div class="objectives-section pgy2-section">
                    <h3 class="objectives-header pgy2-header">üë®‚Äç‚öïÔ∏è PGY-2 Objectives</h3>
                    <p class="objectives-subtitle">Foundation & Developing Independence</p>

                    <div class="competency-group">
                        <h4>üî¨ NCS Patient Care</h4>
                        <ul>
                            <li>Describe peripheral anatomy (brachial plexus, lumbosacral plexus)</li>
                            <li>Perform focused H&P pertinent to study</li>
                            <li>Independently perform NCS screen for median, ulnar, radial nerves</li>
                        </ul>
                    </div>

                    <div class="competency-group">
                        <h4>ü¶¥ Radiculopathy</h4>
                        <ul>
                            <li>Understand pathophysiology of radiculopathy</li>
                            <li>Outline appropriate diagnostic plan</li>
                            <li>Properly perform NCS for radiculopathy (understand when NCS are normal vs abnormal)</li>
                        </ul>
                    </div>

                    <div class="competency-group">
                        <h4>‚ö° Peripheral Neuropathy</h4>
                        <ul>
                            <li>Assess and diagnose basic neuropathy patterns</li>
                            <li>Properly perform NCS for peripheral neuropathy</li>
                            <li>Classify neuropathy types (axonal vs demyelinating)</li>
                        </ul>
                    </div>

                    <div class="competency-group">
                        <h4>üß† Medical Knowledge</h4>
                        <ul>
                            <li>Differentiate neuropathy vs myopathy</li>
                            <li>Explain pathophysiological differences</li>
                            <li>Apply knowledge to diagnostic decision-making</li>
                        </ul>
                    </div>

                    <div class="competency-group">
                        <h4>üìä Spontaneous Discharges</h4>
                        <ul>
                            <li>Recognize fibrillation potentials and positive sharp waves</li>
                            <li>Identify fasciculation potentials and complex repetitive discharges</li>
                        </ul>
                    </div>

                    <div class="competency-group">
                        <h4>üó∫Ô∏è Plexus Anatomy</h4>
                        <ul>
                            <li>Trace nerve roots, branches, cords, divisions, and trunks (basic level)</li>
                            <li>Localize lesions in upper and lower limbs</li>
                        </ul>
                    </div>

                    <div class="competency-group">
                        <h4>üìù Report Writing</h4>
                        <ul>
                            <li>Understand importance of comprehensive EDx reports</li>
                            <li>Recognize basic structure</li>
                            <li>Complete templates with appropriate recommendations</li>
                        </ul>
                    </div>
                </div>

                <!-- Three Column Layout for PGY-3, PGY-4, Advanced -->
                <div class="objectives-grid">
                    <!-- PGY-3 Column -->
                    <div class="objectives-section pgy3-section">
                        <h3 class="objectives-header pgy3-header">üë©‚Äç‚öïÔ∏è PGY-3 Objectives</h3>
                        <p class="objectives-subtitle">Independent Practice</p>

                        <div class="competency-group-compact">
                            <h4>NCS Patient Care</h4>
                            <ul>
                                <li>Perform complete NCS independently</li>
                            </ul>
                        </div>

                        <div class="competency-group-compact">
                            <h4>Radiculopathy</h4>
                            <ul>
                                <li>Perform and interpret EMG studies independently</li>
                            </ul>
                        </div>

                        <div class="competency-group-compact">
                            <h4>Peripheral Neuropathy</h4>
                            <ul>
                                <li>Distinguish between different neuropathy patterns independently</li>
                            </ul>
                        </div>

                        <div class="competency-group-compact">
                            <h4>Medical Knowledge</h4>
                            <ul>
                                <li>Independently diagnose neuropathy vs myopathy cases</li>
                            </ul>
                        </div>

                        <div class="competency-group-compact">
                            <h4>Spontaneous Discharges</h4>
                            <ul>
                                <li>Assess myokymic discharges</li>
                                <li>Evaluate recruitment patterns qualitatively</li>
                            </ul>
                        </div>

                        <div class="competency-group-compact">
                            <h4>Plexus Anatomy</h4>
                            <ul>
                                <li>Understand entrapment neuropathy differential diagnosis</li>
                            </ul>
                        </div>

                        <div class="competency-group-compact">
                            <h4>Report Writing</h4>
                            <ul>
                                <li>Prepare comprehensive EDx reports in timely manner</li>
                            </ul>
                        </div>
                    </div>

                    <!-- PGY-4 Column -->
                    <div class="objectives-section pgy4-section">
                        <h3 class="objectives-header pgy4-header">ü©∫ PGY-4 Objectives</h3>
                        <p class="objectives-subtitle">Complex Cases</p>

                        <div class="competency-group-compact">
                            <h4>NCS Patient Care</h4>
                            <ul>
                                <li>Perform complex studies (blink reflex, repetitive nerve stimulation, proximal
                                    studies)</li>
                            </ul>
                        </div>

                        <div class="competency-group-compact">
                            <h4>Radiculopathy</h4>
                            <ul>
                                <li>Communicate findings via coherent EDx report</li>
                            </ul>
                        </div>

                        <div class="competency-group-compact">
                            <h4>Peripheral Neuropathy</h4>
                            <ul>
                                <li>Handle complex neuropathy cases with atypical presentations</li>
                            </ul>
                        </div>

                        <div class="competency-group-compact">
                            <h4>Medical Knowledge</h4>
                            <ul>
                                <li>Handle unusual and complex diagnostic scenarios</li>
                            </ul>
                        </div>

                        <div class="competency-group-compact">
                            <h4>Spontaneous Discharges</h4>
                            <ul>
                                <li>Evaluate recruitment patterns quantitatively</li>
                            </ul>
                        </div>

                        <div class="competency-group-compact">
                            <h4>Plexus Anatomy</h4>
                            <ul>
                                <li>Diagnose complex plexopathies with multiple level involvement</li>
                            </ul>
                        </div>

                        <div class="competency-group-compact">
                            <h4>Report Writing</h4>
                            <ul>
                                <li>Integrate clinical and EDx findings</li>
                                <li>Provide ranked differential diagnosis</li>
                            </ul>
                        </div>
                    </div>

                    <!-- Advanced/Aspirational Column -->
                    <div class="objectives-section advanced-section">
                        <h3 class="objectives-header advanced-header">‚≠ê Advanced & Beyond</h3>
                        <p class="objectives-subtitle">Expert/Teaching Level</p>

                        <div class="competency-group-compact">
                            <h4>NCS Patient Care</h4>
                            <ul>
                                <li>Capable of teaching and discussing full differential diagnosis</li>
                            </ul>
                        </div>

                        <div class="competency-group-compact">
                            <h4>All Competencies</h4>
                            <ul>
                                <li>Expert level proficiency</li>
                                <li>Capable of teaching others</li>
                                <li>Handle all cases including rare/complex scenarios</li>
                                <li>Educate patients, families, and colleagues</li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Ernest's Podcast Player (Global System) -->
    <script type="module" src="js/podcast-player.js" defer></script>

    <!-- Ernest AI JRPG System -->
    <script src="js/ernest-jrpg.js?v=earl_variety_fix"></script>
</body>

</html>